<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion des stocks - VARITEKS</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .card { background: white; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); border: 1px solid #e5e7eb; }
        .btn-primary { background: #3b82f6; color: white; padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; font-weight: 500; transition: all 0.2s ease; }
        .btn-primary:hover { background: #2563eb; transform: translateY(-1px); box-shadow: 0 4px 8px rgba(59, 130, 246, 0.3); }
        .btn-secondary { background: #6b7280; color: white; padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; font-weight: 500; transition: all 0.2s ease; }
        .btn-secondary:hover { background: #4b5563; transform: translateY(-1px); box-shadow: 0 4px 8px rgba(107, 114, 128, 0.3); }
        .btn-success { background: #10b981; color: white; padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; font-weight: 500; transition: all 0.2s ease; }
        .btn-success:hover { background: #059669; transform: translateY(-1px); box-shadow: 0 4px 8px rgba(16, 185, 129, 0.3); }
        .btn-danger { background: #ef4444; color: white; padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; font-weight: 500; transition: all 0.2s ease; }
        .btn-danger:hover { background: #dc2626; transform: translateY(-1px); box-shadow: 0 4px 8px rgba(239, 68, 68, 0.3); }
        .btn-sm { padding: 6px 12px; font-size: 14px; }
        .btn-lg { padding: 12px 24px; font-size: 16px; }
        .sidebar { background: #1f2937; color: white; min-height: 100vh; }
        .sidebar-item { padding: 12px 16px; cursor: pointer; border-radius: 6px; margin: 4px 8px; }
        .sidebar-item:hover { background: #374151; }
        .sidebar-item.active { background: #3b82f6; }
        
        .movement-tab {
            transition: all 0.3s ease;
            border-bottom: 2px solid transparent;
        }
        
        .movement-tab.active {
            border-bottom-color: #10b981 !important;
            color: #10b981 !important;
            font-weight: 600;
        }
        
        .movement-tab:hover {
            color: #374151;
        }
        
        .settings-tab {
            transition: all 0.3s ease;
            border-bottom: 2px solid transparent;
        }
        
        .settings-tab.active {
            border-bottom-color: #3b82f6 !important;
            color: #3b82f6 !important;
            font-weight: 600;
        }
        
        .settings-tab:hover {
            color: #374151;
        }
        
        .settings-content {
            display: none;
        }
        
        .settings-content.active {
            display: block;
        }
        
        /* Enhanced Dashboard Styles */
        .dashboard-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 20px;
            padding: 30px;
            color: white;
            position: relative;
            overflow: hidden;
            transition: all 0.4s ease;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .dashboard-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }
        
        .dashboard-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, rgba(255,255,255,0.1) 0%, transparent 100%);
            pointer-events: none;
        }
        
        .dashboard-card.products {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .dashboard-card.categories {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        .dashboard-card.inventory {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        
        .dashboard-card.consumption {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        }
        
        .dashboard-card.low-stock {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }
        
        .dashboard-card.total-value {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
        }
        
        .dashboard-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.9;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .dashboard-number {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .dashboard-label {
            font-size: 1.1rem;
            opacity: 0.9;
            font-weight: 500;
        }
        
        .dashboard-trend {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .dashboard-trend.up {
            color: #10b981;
        }
        
        .dashboard-trend.down {
            color: #ef4444;
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }
        
        .dashboard-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            border-radius: 20px;
            margin-bottom: 30px;
            position: relative;
            overflow: hidden;
        }
        
        .dashboard-header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: float 6s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(180deg); }
        }
        
        .dashboard-title {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .dashboard-subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
            font-weight: 400;
        }
        
        .dashboard-time {
            position: absolute;
            top: 20px;
            right: 30px;
            background: rgba(255,255,255,0.2);
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: 600;
        }
        
        .quick-actions {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .quick-actions h3 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 20px;
            color: #1f2937;
        }
        
        .quick-action-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }
        
        .quick-action-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }
        
        .recent-activity {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .recent-activity h3 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 20px;
            color: #1f2937;
        }
        
        .activity-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 10px;
            background: #f8fafc;
            transition: all 0.3s ease;
        }
        
        .activity-item:hover {
            background: #e2e8f0;
            transform: translateX(5px);
        }
        
        .activity-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 15px;
            font-size: 1.2rem;
        }
        
        .activity-icon.add {
            background: linear-gradient(135deg, #10b981, #34d399);
            color: white;
        }
        
        .activity-icon.edit {
            background: linear-gradient(135deg, #3b82f6, #60a5fa);
            color: white;
        }
        
        .activity-icon.delete {
            background: linear-gradient(135deg, #ef4444, #f87171);
            color: white;
        }
        
        .activity-content {
            flex: 1;
        }
        
        .activity-title {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 5px;
        }
        
        .activity-time {
            font-size: 0.9rem;
            color: #6b7280;
        }
        
        .pulse-animation {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        /* Advanced Sync Indicators */
        .sync-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            position: relative;
            animation: pulse 2s infinite;
        }

        .sync-indicator.online {
            background: #10b981;
            box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7);
        }

        .sync-indicator.warning {
            background: #f59e0b;
            box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.7);
        }

        .sync-indicator.offline {
            background: #ef4444;
            box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
            animation: pulse 1s infinite;
        }

        .sync-indicator.syncing {
            background: #3b82f6;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .sync-status {
            font-size: 12px;
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 12px;
            color: white;
            min-width: 80px;
            text-align: center;
        }

        .sync-status.success {
            background: #10b981;
        }

        .sync-status.warning {
            background: #f59e0b;
        }

        .sync-status.error {
            background: #ef4444;
        }

        .sync-status.syncing {
            background: #3b82f6;
            animation: pulse 1s infinite;
        }

        .auto-save-indicator {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 11px;
            color: #6b7280;
            background: rgba(255, 255, 255, 0.9);
            padding: 4px 8px;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
        }

        .auto-save-indicator i {
            animation: spin 2s linear infinite;
        }

        .data-change-indicator {
            position: fixed;
            top: 50%;
            right: 20px;
            transform: translateY(-50%);
            background: #3b82f6;
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12px;
            z-index: 1000;
            opacity: 0;
            transition: all 0.3s ease;
        }

        .data-change-indicator.show {
            opacity: 1;
            transform: translateY(-50%) translateX(-10px);
        }

        .sync-queue-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(59, 130, 246, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12px;
            z-index: 1000;
            display: none;
        }

        .sync-queue-indicator.active {
            display: block;
            animation: slideInUp 0.3s ease;
        }

        @keyframes slideInUp {
            from {
                transform: translateY(100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* Advanced Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-overlay.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        .modal {
            background: white;
            border-radius: 16px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow: hidden;
            transform: scale(0.9);
            opacity: 0;
            transition: all 0.3s ease;
        }

        .modal-overlay.active .modal {
            transform: scale(1);
            opacity: 1;
        }

        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 24px;
            display: flex;
            align-items: center;
            justify-content: between;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            flex: 1;
            display: flex;
            align-items: center;
        }

        .modal-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        .modal-body {
            padding: 24px;
            max-height: 60vh;
            overflow-y: auto;
        }

        .modal-footer {
            background: #f8fafc;
            padding: 16px 24px;
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            border-top: 1px solid #e2e8f0;
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.2s ease;
            background: white;
        }

        .form-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .form-input:invalid {
            border-color: #ef4444;
        }

        .color-option {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.2s ease;
            position: relative;
        }

        .color-option:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .color-option.selected {
            border-color: #1f2937;
            transform: scale(1.1);
        }

        .color-option.selected::after {
            content: '✓';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-weight: bold;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Enhanced Table Styles */
        .enhanced-table {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            border: 1px solid #e5e7eb;
        }

        .enhanced-table thead {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        }

        .enhanced-table th {
            padding: 16px 12px;
            font-weight: 600;
            color: #374151;
            text-align: right;
            border-bottom: 2px solid #e5e7eb;
        }

        .enhanced-table td {
            padding: 12px;
            border-bottom: 1px solid #f3f4f6;
            vertical-align: middle;
        }

        .enhanced-table tbody tr {
            transition: all 0.2s ease;
        }

        .enhanced-table tbody tr:hover {
            background: #f8fafc;
            transform: translateX(-2px);
            box-shadow: 4px 0 8px rgba(0, 0, 0, 0.1);
        }

        .action-buttons {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .action-btn {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 14px;
        }

        .action-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        .action-btn.edit {
            background: #3b82f6;
            color: white;
        }

        .action-btn.delete {
            background: #ef4444;
            color: white;
        }

        .action-btn.view {
            background: #10b981;
            color: white;
        }

        .action-btn.consume {
            background: #f59e0b;
            color: white;
        }

        .form-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.2s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .stock-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            text-align: center;
            min-width: 60px;
        }

        .stock-normal {
            background: #dcfce7;
            color: #166534;
        }

        .stock-low {
            background: #fef3c7;
            color: #92400e;
        }

        .stock-out {
            background: #fee2e2;
            color: #991b1b;
        }
        
        /* Login Page Styles */
        .login-container {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .login-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            padding: 40px;
            width: 100%;
            max-width: 400px;
            position: relative;
            overflow: hidden;
        }
        
        .login-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2);
        }
        
        .login-logo {
            text-align: center;
            margin-bottom: 30px;
        }

        .login-logo i {
            font-size: 60px;
            color: #667eea;
            margin-bottom: 10px;
        }

        .company-logo {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #FF4B4B, #3B4CCA);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            position: relative;
            overflow: hidden;
        }

        .company-logo::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iODAiIHZpZXdCb3g9IjAgMCA4MCA4MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTQwIDEwQzI3LjMgMTAgMTcgMjAuMyAxNyAzM0MxNyA0NS43IDI3LjMgNTYgNDAgNTZDNTIuNyA1NiA2MyA0NS43IDYzIDMzQzYzIDIwLjMgNTIuNyAxMCA0MCAxMFoiIGZpbGw9IndoaXRlIiBmaWxsLW9wYWNpdHk9IjAuMiIvPgo8cGF0aCBkPSJNMzAgMjVIMzVWNDBIMzBWMjVaIiBmaWxsPSJ3aGl0ZSIvPgo8cGF0aCBkPSJNNDUgMjVINTBWNDBINDVWMjVaIiBmaWxsPSJ3aGl0ZSIvPgo8cGF0aCBkPSJNMjUgMzBIMzBWNDVIMjVWMzBaIiBmaWxsPSJ3aGl0ZSIvPgo8cGF0aCBkPSJNNTAgMzBINTVWNDVINTBWMzBaIiBmaWxsPSJ3aGl0ZSIvPgo8L3N2Zz4K') center/contain no-repeat;
        }

        .sidebar-logo {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 20px 16px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 20px;
        }

        .sidebar-logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #FF4B4B, #3B4CCA);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .sidebar-logo-icon::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTIwIDVDMTMuNjUgNSA4LjUgMTAuMTUgOC41IDE2LjVDOC41IDIyLjg1IDEzLjY1IDI4IDIwIDI4QzI2LjM1IDI4IDMxLjUgMjIuODUgMzEuNSAxNi41QzMxLjUgMTAuMTUgMjYuMzUgNSAyMCA1WiIgZmlsbD0id2hpdGUiIGZpbGwtb3BhY2l0eT0iMC4yIi8+CjxwYXRoIGQ9Ik0xNSAxMi41SDE3LjVWMjBIMTVWMTIuNVoiIGZpbGw9IndoaXRlIi8+CjxwYXRoIGQ9Ik0yMi41IDEyLjVIMjVWMjBIMjIuNVYxMi41WiIgZmlsbD0id2hpdGUiLz4KPHBhdGggZD0iTTEyLjUgMTVIMTVWMjIuNUgxMi41VjE1WiIgZmlsbD0id2hpdGUiLz4KPHBhdGggZD0iTTI1IDE1SDI3LjVWMjIuNUgyNVYxNVoiIGZpbGw9IndoaXRlIi8+Cjwvc3ZnPgo=') center/contain no-repeat;
        }

        .sidebar-logo-text {
            color: white;
            font-weight: bold;
            font-size: 16px;
            line-height: 1.2;
        }

        .sidebar-logo-subtitle {
            color: rgba(255,255,255,0.7);
            font-size: 12px;
            margin-top: 2px;
        }
        
        .login-title {
            font-size: 28px;
            font-weight: 700;
            color: #2d3748;
            text-align: center;
            margin-bottom: 8px;
        }
        
        .login-subtitle {
            color: #718096;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .form-group {
            margin-bottom: 20px;
            position: relative;
        }
        
        .form-input {
            width: 100%;
            padding: 15px 20px 15px 50px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: #f8fafc;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .form-icon {
            position: absolute;
            left: 18px;
            top: 50%;
            transform: translateY(-50%);
            color: #a0aec0;
            font-size: 18px;
        }
        
        .login-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }
        
        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        
        .login-btn:active {
            transform: translateY(0);
        }
        
        .remember-forgot {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 20px 0;
            font-size: 14px;
        }
        
        .remember-me {
            display: flex;
            align-items: center;
            color: #4a5568;
        }
        
        .remember-me input {
            margin-left: 8px;
        }
        
        .forgot-password {
            color: #667eea;
            text-decoration: none;
            font-weight: 500;
        }
        
        .forgot-password:hover {
            text-decoration: underline;
        }
        
        .login-footer {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e2e8f0;
            color: #718096;
            font-size: 14px;
        }
        
        .error-message {
            background: #fed7d7;
            color: #c53030;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            text-align: center;
            display: none;
        }
        
        .success-message {
            background: #c6f6d5;
            color: #2f855a;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            text-align: center;
            display: none;
        }
        
        .main-app {
            display: none;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            color: white;
            font-size: 14px;
        }
        
        .logout-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }
        
        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .page { display: none; }
        .page.active { display: block; }
        .hidden { display: none !important; }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Login Page -->
    <div id="loginPage" class="login-container">
        <div class="login-card">
            <div class="login-logo">
                <div class="company-logo"></div>
                <h1 class="login-title">Gestion des stocks</h1>
                <h2 class="text-2xl font-bold text-gray-800 mb-2">VARITEKS</h2>
                <p class="login-subtitle">Système de gestion intégré</p>
            </div>

            <div id="errorMessage" class="error-message"></div>
            <div id="successMessage" class="success-message"></div>
            <div id="securityMessage" class="error-message" style="background: #fef2f2; color: #991b1b; display: none;">
                <i class="fas fa-shield-alt ml-1"></i>
                جاري التحقق من الأمان...
            </div>

            <form id="loginForm" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <i class="fas fa-user-shield form-icon"></i>
                    <input type="text" id="username" class="form-input" placeholder="معرف المستخدم" required autocomplete="off">
                </div>

                <div class="form-group">
                    <i class="fas fa-key form-icon"></i>
                    <input type="password" id="password" class="form-input" placeholder="كلمة المرور الآمنة" required autocomplete="off">
                </div>

                <div class="form-group">
                    <i class="fas fa-fingerprint form-icon"></i>
                    <input type="text" id="securityCode" class="form-input" placeholder="رمز الأمان" required autocomplete="off">
                    <small style="color: #6b7280; font-size: 12px; margin-top: 5px; display: block;">
                        أدخل الرمز: <span id="captchaCode" style="font-weight: bold; color: #1f2937;"></span>
                    </small>
                </div>

                <div class="remember-forgot">
                    <label class="remember-me">
                        <input type="checkbox" id="rememberMe">
                        حفظ الجلسة
                    </label>
                </div>

                <button type="submit" class="login-btn" id="loginButton">
                    <i class="fas fa-sign-in-alt" style="margin-left: 8px;"></i>
                    دخول آمن
                </button>
            </form>

            <div class="login-footer">
                <p>© 2024 Gestion des stocks - VARITEKS. جميع الحقوق محفوظة.</p>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" class="main-app flex">
        <!-- Sidebar -->
        <div class="w-64 sidebar">
            <div class="sidebar-logo">
                <div class="sidebar-logo-icon"></div>
                <div>
                    <div class="sidebar-logo-text">VARITEKS</div>
                    <div class="sidebar-logo-subtitle">Gestion des stocks</div>
                </div>
            </div>
            <div class="p-6 pt-0">
                <nav>
                    <div class="sidebar-item active" onclick="showPage('dashboard')">
                        <i class="fas fa-tachometer-alt ml-2"></i>
                        لوحة التحكم
                    </div>
                    <div class="sidebar-item" onclick="showPage('products')">
                        <i class="fas fa-box ml-2"></i>
                        إدارة المنتجات
                    </div>
                    <div class="sidebar-item" onclick="showPage('categories')">
                        <i class="fas fa-tags ml-2"></i>
                        إدارة الأصناف
                    </div>
                    <div class="sidebar-item" onclick="showPage('inventory')">
                        <i class="fas fa-warehouse ml-2"></i>
                        إدارة المخزون
                    </div>
                    <div class="sidebar-item" onclick="showPage('sales')">
                        <i class="fas fa-box-open ml-2"></i>
                        المخرجات الأسبوعية
                    </div>
                    <div class="sidebar-item" onclick="showPage('movements')">
                        <i class="fas fa-exchange-alt ml-2"></i>
                        حركات المخزون
                    </div>
                    <div class="sidebar-item" onclick="showPage('reports')">
                        <i class="fas fa-chart-bar ml-2"></i>
                        التقارير
                    </div>
                    <div class="sidebar-item" onclick="showPage('settings')">
                        <i class="fas fa-cog ml-2"></i>
                        الإعدادات
                    </div>
                </nav>
            </div>
        </div>

        <!-- Main Content -->
        <div class="flex-1">
            <!-- Top Header Bar -->
            <div class="bg-white border-b border-gray-200 px-6 py-3 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 bg-gradient-to-br from-red-500 to-blue-600 rounded-lg flex items-center justify-center">
                        <div class="w-6 h-6 bg-white rounded opacity-80"></div>
                    </div>
                    <div>
                        <h2 class="font-bold text-gray-800">VARITEKS</h2>
                        <p class="text-xs text-gray-500">Gestion des stocks</p>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <div class="text-right">
                        <div id="currentUserName" class="font-semibold text-gray-800"></div>
                        <div id="currentUserRole" class="text-sm text-gray-500"></div>
                    </div>
                    <button onclick="logout()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm transition-colors">
                        <i class="fas fa-sign-out-alt ml-1"></i>
                        تسجيل الخروج
                    </button>
                </div>
            </div>

            <div class="p-6">
            <!-- Advanced Sync Status Indicators -->
            <div id="saveStatus" class="fixed top-4 right-4 bg-green-500 text-white px-3 py-1 rounded-lg text-sm hidden z-50">
                <i class="fas fa-check ml-1"></i>
                تم الحفظ
            </div>

            <!-- Sync Status Bar -->
            <div class="fixed top-4 left-4 flex items-center gap-2 z-50">
                <div id="syncIndicator" class="sync-indicator online" title="حالة المزامنة"></div>
                <div id="syncStatus" class="sync-status success">متصل</div>
                <div id="autoSaveIndicator" class="auto-save-indicator">
                    <i class="fas fa-sync-alt"></i>
                    <span>حفظ تلقائي</span>
                </div>
            </div>

            <!-- Data Change Indicator -->
            <div id="dataChangeIndicator" class="data-change-indicator">
                <i class="fas fa-database ml-1"></i>
                <span>جاري حفظ التغييرات...</span>
            </div>

            <!-- Sync Queue Indicator -->
            <div id="syncQueueIndicator" class="sync-queue-indicator">
                <i class="fas fa-clock ml-1"></i>
                <span id="queueCount">0</span> تغيير في الانتظار
            </div>

            <!-- Modal Overlay -->
            <div id="modalOverlay" class="modal-overlay">
                <!-- Add Product Modal -->
                <div id="addProductModal" class="modal">
                    <div class="modal-header">
                        <h3 class="modal-title">
                            <i class="fas fa-plus-circle ml-2"></i>
                            إضافة منتج جديد
                        </h3>
                        <button class="modal-close" onclick="closeModal('addProductModal')">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        <form id="addProductForm" class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">اسم المنتج *</label>
                                    <input type="text" id="productName" class="form-input" placeholder="أدخل اسم المنتج" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">كود المنتج *</label>
                                    <input type="text" id="productCode" class="form-input" placeholder="أدخل كود المنتج" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">الصنف *</label>
                                    <select id="productCategory" class="form-input" required>
                                        <option value="">اختر الصنف</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">الوحدة</label>
                                    <select id="productUnit" class="form-input">
                                        <option value="قطعة">قطعة</option>
                                        <option value="كيس">كيس</option>
                                        <option value="عبوة">عبوة</option>
                                        <option value="رزمة">رزمة</option>
                                        <option value="علبة">علبة</option>
                                        <option value="كيلو">كيلو</option>
                                        <option value="لتر">لتر</option>
                                        <option value="متر">متر</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">السعر (ر.س) *</label>
                                    <input type="number" id="productPrice" class="form-input" placeholder="0.00" step="0.01" min="0" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">التكلفة (ر.س) *</label>
                                    <input type="number" id="productCost" class="form-input" placeholder="0.00" step="0.01" min="0" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">المخزون الحالي *</label>
                                    <input type="number" id="productStock" class="form-input" placeholder="0" min="0" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">الحد الأدنى للمخزون *</label>
                                    <input type="number" id="productMinStock" class="form-input" placeholder="0" min="0" required>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">الوصف</label>
                                <textarea id="productDescription" class="form-input" rows="3" placeholder="وصف المنتج (اختياري)"></textarea>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">الباركود</label>
                                    <input type="text" id="productBarcode" class="form-input" placeholder="رقم الباركود (اختياري)">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">المورد</label>
                                    <input type="text" id="productSupplier" class="form-input" placeholder="اسم المورد (اختياري)">
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn-secondary" onclick="closeModal('addProductModal')">
                            <i class="fas fa-times ml-2"></i>
                            إلغاء
                        </button>
                        <button type="button" class="btn-primary" onclick="saveNewProduct()">
                            <i class="fas fa-save ml-2"></i>
                            حفظ المنتج
                        </button>
                    </div>
                </div>

                <!-- Add Category Modal -->
                <div id="addCategoryModal" class="modal">
                    <div class="modal-header">
                        <h3 class="modal-title">
                            <i class="fas fa-tags ml-2"></i>
                            إضافة صنف جديد
                        </h3>
                        <button class="modal-close" onclick="closeModal('addCategoryModal')">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        <form id="addCategoryForm" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">اسم الصنف *</label>
                                <input type="text" id="categoryName" class="form-input" placeholder="أدخل اسم الصنف" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">الوصف</label>
                                <textarea id="categoryDescription" class="form-input" rows="3" placeholder="وصف الصنف (اختياري)"></textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">اللون</label>
                                <div class="grid grid-cols-6 gap-2">
                                    <div class="color-option" data-color="#3b82f6" style="background: #3b82f6"></div>
                                    <div class="color-option" data-color="#10b981" style="background: #10b981"></div>
                                    <div class="color-option" data-color="#f59e0b" style="background: #f59e0b"></div>
                                    <div class="color-option" data-color="#ef4444" style="background: #ef4444"></div>
                                    <div class="color-option" data-color="#8b5cf6" style="background: #8b5cf6"></div>
                                    <div class="color-option" data-color="#06b6d4" style="background: #06b6d4"></div>
                                    <div class="color-option" data-color="#84cc16" style="background: #84cc16"></div>
                                    <div class="color-option" data-color="#f97316" style="background: #f97316"></div>
                                    <div class="color-option" data-color="#ec4899" style="background: #ec4899"></div>
                                    <div class="color-option" data-color="#6366f1" style="background: #6366f1"></div>
                                    <div class="color-option" data-color="#14b8a6" style="background: #14b8a6"></div>
                                    <div class="color-option" data-color="#f59e0b" style="background: #f59e0b"></div>
                                </div>
                                <input type="hidden" id="categoryColor" value="#3b82f6">
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn-secondary" onclick="closeModal('addCategoryModal')">
                            <i class="fas fa-times ml-2"></i>
                            إلغاء
                        </button>
                        <button type="button" class="btn-primary" onclick="saveNewCategory()">
                            <i class="fas fa-save ml-2"></i>
                            حفظ الصنف
                        </button>
                    </div>
                </div>

                <!-- Edit Product Modal -->
                <div id="editProductModal" class="modal">
                    <div class="modal-header">
                        <h3 class="modal-title">
                            <i class="fas fa-edit ml-2"></i>
                            تعديل المنتج
                        </h3>
                        <button class="modal-close" onclick="closeModal('editProductModal')">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        <form id="editProductForm" class="space-y-4">
                            <input type="hidden" id="editProductId">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">اسم المنتج *</label>
                                    <input type="text" id="editProductName" class="form-input" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">كود المنتج *</label>
                                    <input type="text" id="editProductCode" class="form-input" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">الصنف *</label>
                                    <select id="editProductCategory" class="form-input" required>
                                        <option value="">اختر الصنف</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">الوحدة</label>
                                    <select id="editProductUnit" class="form-input">
                                        <option value="قطعة">قطعة</option>
                                        <option value="كيس">كيس</option>
                                        <option value="عبوة">عبوة</option>
                                        <option value="رزمة">رزمة</option>
                                        <option value="علبة">علبة</option>
                                        <option value="كيلو">كيلو</option>
                                        <option value="لتر">لتر</option>
                                        <option value="متر">متر</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">السعر (ر.س) *</label>
                                    <input type="number" id="editProductPrice" class="form-input" step="0.01" min="0" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">التكلفة (ر.س) *</label>
                                    <input type="number" id="editProductCost" class="form-input" step="0.01" min="0" required>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">الوصف</label>
                                <textarea id="editProductDescription" class="form-input" rows="3"></textarea>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">الباركود</label>
                                    <input type="text" id="editProductBarcode" class="form-input">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">المورد</label>
                                    <input type="text" id="editProductSupplier" class="form-input">
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn-danger" onclick="deleteProductFromModal()">
                            <i class="fas fa-trash ml-2"></i>
                            حذف المنتج
                        </button>
                        <button type="button" class="btn-secondary" onclick="closeModal('editProductModal')">
                            <i class="fas fa-times ml-2"></i>
                            إلغاء
                        </button>
                        <button type="button" class="btn-primary" onclick="saveEditedProduct()">
                            <i class="fas fa-save ml-2"></i>
                            حفظ التغييرات
                        </button>
                    </div>
                </div>

                <!-- Edit Category Modal -->
                <div id="editCategoryModal" class="modal">
                    <div class="modal-header">
                        <h3 class="modal-title">
                            <i class="fas fa-edit ml-2"></i>
                            تعديل الصنف
                        </h3>
                        <button class="modal-close" onclick="closeModal('editCategoryModal')">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        <form id="editCategoryForm" class="space-y-4">
                            <input type="hidden" id="editCategoryId">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">اسم الصنف *</label>
                                <input type="text" id="editCategoryName" class="form-input" placeholder="أدخل اسم الصنف" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">الوصف</label>
                                <textarea id="editCategoryDescription" class="form-input" rows="3" placeholder="وصف الصنف (اختياري)"></textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">اللون</label>
                                <div class="grid grid-cols-6 gap-2" id="editColorOptions">
                                    <div class="color-option" data-color="#3b82f6" style="background: #3b82f6"></div>
                                    <div class="color-option" data-color="#10b981" style="background: #10b981"></div>
                                    <div class="color-option" data-color="#f59e0b" style="background: #f59e0b"></div>
                                    <div class="color-option" data-color="#ef4444" style="background: #ef4444"></div>
                                    <div class="color-option" data-color="#8b5cf6" style="background: #8b5cf6"></div>
                                    <div class="color-option" data-color="#06b6d4" style="background: #06b6d4"></div>
                                    <div class="color-option" data-color="#84cc16" style="background: #84cc16"></div>
                                    <div class="color-option" data-color="#f97316" style="background: #f97316"></div>
                                    <div class="color-option" data-color="#ec4899" style="background: #ec4899"></div>
                                    <div class="color-option" data-color="#6366f1" style="background: #6366f1"></div>
                                    <div class="color-option" data-color="#14b8a6" style="background: #14b8a6"></div>
                                    <div class="color-option" data-color="#f59e0b" style="background: #f59e0b"></div>
                                </div>
                                <input type="hidden" id="editCategoryColor" value="#3b82f6">
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn-danger" onclick="deleteCategoryFromModal()">
                            <i class="fas fa-trash ml-2"></i>
                            حذف الصنف
                        </button>
                        <button type="button" class="btn-secondary" onclick="closeModal('editCategoryModal')">
                            <i class="fas fa-times ml-2"></i>
                            إلغاء
                        </button>
                        <button type="button" class="btn-primary" onclick="saveEditedCategory()">
                            <i class="fas fa-save ml-2"></i>
                            حفظ التغييرات
                        </button>
                    </div>
                </div>

                <!-- Add Movement Modal -->
                <div id="addMovementModal" class="modal">
                    <div class="modal-header">
                        <h3 class="modal-title">
                            <i class="fas fa-exchange-alt ml-2"></i>
                            إضافة حركة مخزون جديدة
                        </h3>
                        <button class="modal-close" onclick="closeModal('addMovementModal')">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        <form id="addMovementForm" class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">المنتج *</label>
                                    <select id="movementProduct" class="form-input" required>
                                        <option value="">اختر المنتج</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">نوع الحركة *</label>
                                    <select id="movementType" class="form-input" required onchange="updateMovementForm()">
                                        <option value="">اختر نوع الحركة</option>
                                        <option value="in">إدخال (+)</option>
                                        <option value="out">إخراج (-)</option>
                                        <option value="adjustment">تعديل المخزون</option>
                                        <option value="transfer">نقل بين المواقع</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">الكمية *</label>
                                    <input type="number" id="movementQuantity" class="form-input" placeholder="0" min="1" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">التاريخ *</label>
                                    <input type="datetime-local" id="movementDate" class="form-input" required>
                                </div>
                            </div>

                            <div id="movementReasonSection">
                                <label class="block text-sm font-medium text-gray-700 mb-2">السبب *</label>
                                <select id="movementReason" class="form-input" required>
                                    <option value="">اختر السبب</option>
                                </select>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">ملاحظات</label>
                                <textarea id="movementNotes" class="form-input" rows="3" placeholder="ملاحظات إضافية (اختياري)"></textarea>
                            </div>

                            <div id="movementSummary" class="p-4 bg-gray-50 rounded-lg" style="display: none;">
                                <h4 class="font-medium text-gray-800 mb-2">ملخص الحركة:</h4>
                                <div class="grid grid-cols-2 gap-4 text-sm">
                                    <div>
                                        <span class="text-gray-600">المخزون الحالي:</span>
                                        <span id="currentStockDisplay" class="font-medium">-</span>
                                    </div>
                                    <div>
                                        <span class="text-gray-600">المخزون بعد الحركة:</span>
                                        <span id="newStockDisplay" class="font-medium">-</span>
                                    </div>
                                    <div>
                                        <span class="text-gray-600">قيمة الحركة:</span>
                                        <span id="movementValueDisplay" class="font-medium">-</span>
                                    </div>
                                    <div>
                                        <span class="text-gray-600">التأثير:</span>
                                        <span id="movementImpactDisplay" class="font-medium">-</span>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn-secondary" onclick="closeModal('addMovementModal')">
                            <i class="fas fa-times ml-2"></i>
                            إلغاء
                        </button>
                        <button type="button" class="btn-primary" onclick="saveNewMovement()">
                            <i class="fas fa-save ml-2"></i>
                            حفظ الحركة
                        </button>
                    </div>
                </div>

                <!-- Custom Report Modal -->
                <div id="customReportModal" class="modal">
                    <div class="modal-header">
                        <h3 class="modal-title">
                            <i class="fas fa-chart-bar ml-2"></i>
                            إنشاء تقرير مخصص
                        </h3>
                        <button class="modal-close" onclick="closeModal('customReportModal')">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        <form id="customReportForm" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">عنوان التقرير *</label>
                                <input type="text" id="reportCustomTitle" class="form-input" placeholder="أدخل عنوان التقرير" required>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">نوع التقرير *</label>
                                    <select id="reportType" class="form-input" required onchange="updateReportOptions()">
                                        <option value="">اختر نوع التقرير</option>
                                        <option value="inventory">تقرير المخزون</option>
                                        <option value="consumption">تقرير الاستهلاك</option>
                                        <option value="movement">تقرير الحركات</option>
                                        <option value="value">تقرير القيمة</option>
                                        <option value="product">تقرير منتج محدد</option>
                                        <option value="category">تقرير صنف محدد</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">تنسيق التقرير</label>
                                    <select id="reportFormat" class="form-input">
                                        <option value="table">جدول</option>
                                        <option value="chart">رسم بياني</option>
                                        <option value="both">جدول ورسم بياني</option>
                                    </select>
                                </div>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">من تاريخ</label>
                                    <input type="date" id="reportDateFrom" class="form-input">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">إلى تاريخ</label>
                                    <input type="date" id="reportDateTo" class="form-input">
                                </div>
                            </div>

                            <div id="reportFilterSection" style="display: none;">
                                <label class="block text-sm font-medium text-gray-700 mb-2">تصفية حسب</label>
                                <select id="reportFilter" class="form-input">
                                    <option value="">بدون تصفية</option>
                                </select>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">خيارات إضافية</label>
                                <div class="grid grid-cols-2 gap-4">
                                    <div class="flex items-center">
                                        <input type="checkbox" id="reportIncludeChart" class="ml-2">
                                        <label for="reportIncludeChart">تضمين رسم بياني</label>
                                    </div>
                                    <div class="flex items-center">
                                        <input type="checkbox" id="reportIncludeSummary" class="ml-2" checked>
                                        <label for="reportIncludeSummary">تضمين ملخص</label>
                                    </div>
                                    <div class="flex items-center">
                                        <input type="checkbox" id="reportIncludeDetails" class="ml-2" checked>
                                        <label for="reportIncludeDetails">تضمين التفاصيل</label>
                                    </div>
                                    <div class="flex items-center">
                                        <input type="checkbox" id="reportAutoExport" class="ml-2">
                                        <label for="reportAutoExport">تصدير تلقائي</label>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn-secondary" onclick="closeModal('customReportModal')">
                            <i class="fas fa-times ml-2"></i>
                            إلغاء
                        </button>
                        <button type="button" class="btn-primary" onclick="generateReport()">
                            <i class="fas fa-chart-bar ml-2"></i>
                            إنشاء التقرير
                        </button>
                    </div>
                </div>
            </div>

            <!-- User Header -->
            <div class="bg-white shadow-sm p-4 mb-6 rounded-lg flex justify-between items-center">

            </div>

            <!-- Dashboard Page -->
            <div id="dashboard" class="page active">
                <!-- Dashboard Header -->
                <div class="dashboard-header">
                    <div class="dashboard-time" id="currentDateTime"></div>
                    <h1 class="dashboard-title">Gestion des stocks - VARITEKS</h1>
                    <p class="dashboard-subtitle">Système de gestion intégré pour tous vos besoins d'inventaire</p>
                </div>

                <!-- Stats Cards -->
                <div class="dashboard-grid">
                    <div class="dashboard-card products">
                        <div class="dashboard-trend up" id="productsTrend">+5%</div>
                        <div class="dashboard-icon">
                            <i class="fas fa-box"></i>
                        </div>
                        <div class="dashboard-number" id="totalProducts">0</div>
                        <div class="dashboard-label">إجمالي المنتجات</div>
                    </div>

                    <div class="dashboard-card categories">
                        <div class="dashboard-trend up" id="categoriesTrend">+2</div>
                        <div class="dashboard-icon">
                            <i class="fas fa-tags"></i>
                        </div>
                        <div class="dashboard-number" id="totalCategories">0</div>
                        <div class="dashboard-label">إجمالي الأصناف</div>
                    </div>

                    <div class="dashboard-card inventory">
                        <div class="dashboard-trend down" id="inventoryTrend">-3%</div>
                        <div class="dashboard-icon">
                            <i class="fas fa-warehouse"></i>
                        </div>
                        <div class="dashboard-number" id="totalInventoryValue">0</div>
                        <div class="dashboard-label">قيمة المخزون (ر.س)</div>
                    </div>

                    <div class="dashboard-card consumption">
                        <div class="dashboard-trend up" id="consumptionTrend">+12%</div>
                        <div class="dashboard-icon">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div class="dashboard-number" id="weeklyConsumption">0</div>
                        <div class="dashboard-label">استهلاك هذا الأسبوع</div>
                    </div>

                    <div class="dashboard-card low-stock">
                        <div class="dashboard-trend down" id="lowStockTrend">-1</div>
                        <div class="dashboard-icon">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <div class="dashboard-number" id="lowStockProducts">0</div>
                        <div class="dashboard-label">منتجات منخفضة المخزون</div>
                    </div>

                    <div class="dashboard-card total-value">
                        <div class="dashboard-trend up" id="valueTrend">+8%</div>
                        <div class="dashboard-icon">
                            <i class="fas fa-money-bill-wave"></i>
                        </div>
                        <div class="dashboard-number" id="consumptionValue">0</div>
                        <div class="dashboard-label">قيمة الاستهلاك (ر.س)</div>
                    </div>
                </div>

                <!-- Sync Status Section -->
                <div class="mt-8 mb-6">
                    <h3 class="text-xl font-bold mb-4 text-gray-800">
                        <i class="fas fa-sync-alt ml-2 text-blue-600"></i>
                        حالة المزامنة والحفظ التلقائي
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <!-- Sync Status Card -->
                        <div class="card p-6 bg-gradient-to-br from-blue-50 to-blue-100 border-l-4 border-blue-500">
                            <div class="flex items-center justify-between mb-4">
                                <div class="p-3 bg-blue-500 text-white rounded-lg">
                                    <i class="fas fa-sync-alt text-xl" id="dashboardSyncIcon"></i>
                                </div>
                                <div class="text-right">
                                    <div class="text-lg font-bold text-blue-800" id="dashboardSyncStatus">متصل</div>
                                    <div class="text-blue-600 text-sm">حالة المزامنة</div>
                                </div>
                            </div>
                            <div class="flex items-center justify-between text-blue-700 text-sm">
                                <span id="dashboardLastSync">آخر مزامنة: الآن</span>
                                <span id="dashboardQueueStatus">0 في الانتظار</span>
                            </div>
                        </div>

                        <!-- Data Integrity Card -->
                        <div class="card p-6 bg-gradient-to-br from-green-50 to-green-100 border-l-4 border-green-500">
                            <div class="flex items-center justify-between mb-4">
                                <div class="p-3 bg-green-500 text-white rounded-lg">
                                    <i class="fas fa-shield-alt text-xl"></i>
                                </div>
                                <div class="text-right">
                                    <div class="text-lg font-bold text-green-800" id="dashboardDataIntegrity">آمن</div>
                                    <div class="text-green-600 text-sm">سلامة البيانات</div>
                                </div>
                            </div>
                            <div class="flex items-center justify-between text-green-700 text-sm">
                                <span id="dashboardBackupCount">3 نسخ احتياطية</span>
                                <span id="dashboardAutoSave">حفظ تلقائي: مفعل</span>
                            </div>
                        </div>

                        <!-- Performance Card -->
                        <div class="card p-6 bg-gradient-to-br from-purple-50 to-purple-100 border-l-4 border-purple-500">
                            <div class="flex items-center justify-between mb-4">
                                <div class="p-3 bg-purple-500 text-white rounded-lg">
                                    <i class="fas fa-tachometer-alt text-xl"></i>
                                </div>
                                <div class="text-right">
                                    <div class="text-lg font-bold text-purple-800" id="dashboardPerformance">ممتاز</div>
                                    <div class="text-purple-600 text-sm">أداء النظام</div>
                                </div>
                            </div>
                            <div class="flex items-center justify-between text-purple-700 text-sm">
                                <span id="dashboardResponseTime">< 100ms</span>
                                <span id="dashboardUptime">متاح 100%</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="quick-actions">
                    <h3><i class="fas fa-bolt ml-2"></i>الإجراءات السريعة</h3>
                    <div class="flex flex-wrap gap-3">
                        <button class="quick-action-btn" onclick="showAddProductModal()">
                            <i class="fas fa-plus ml-2"></i>إضافة منتج جديد
                        </button>
                        <button class="quick-action-btn" onclick="showAddCategoryModal()">
                            <i class="fas fa-tag ml-2"></i>إضافة صنف جديد
                        </button>
                        <button class="quick-action-btn" onclick="showPage('inventory')">
                            <i class="fas fa-boxes ml-2"></i>تعديل المخزون
                        </button>
                        <button class="quick-action-btn" onclick="showPage('sales')">
                            <i class="fas fa-shopping-cart ml-2"></i>تسجيل استهلاك
                        </button>
                        <button class="quick-action-btn" onclick="showPage('reports')">
                            <i class="fas fa-chart-bar ml-2"></i>عرض التقارير
                        </button>
                        <button class="quick-action-btn" onclick="exportAllData()">
                            <i class="fas fa-download ml-2"></i>نسخة احتياطية
                        </button>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Recent Activity -->
                    <div class="recent-activity">
                        <h3><i class="fas fa-history ml-2"></i>النشاط الأخير</h3>
                        <div id="recentActivityList">
                            <!-- Activity items will be populated here -->
                        </div>
                    </div>

                    <div class="card p-6">
                        <h3 class="text-lg font-semibold mb-4">إدارة البيانات</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center p-3 bg-blue-50 rounded">
                                <div>
                                    <span class="font-medium">حفظ محلي</span>
                                    <p class="text-sm text-gray-600">يتم حفظ البيانات محلياً في المتصفح</p>
                                </div>
                                <i class="fas fa-check-circle text-green-500 text-xl"></i>
                            </div>

                            <div class="grid grid-cols-2 gap-2">
                                <button onclick="exportAllData()" class="btn-secondary text-sm">
                                    <i class="fas fa-download ml-1"></i>
                                    تصدير البيانات
                                </button>
                                <label class="btn-secondary text-sm cursor-pointer text-center">
                                    <i class="fas fa-upload ml-1"></i>
                                    استيراد البيانات
                                    <input type="file" accept=".json" onchange="importData(event)" class="hidden">
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Other Pages (Products, Categories, etc.) -->
            <div id="products" class="page">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">إدارة المنتجات</h2>
                    <div class="flex gap-2">
                        <button class="btn-primary" onclick="showAddProductModal()">
                            <i class="fas fa-plus ml-2"></i>
                            إضافة منتج جديد
                        </button>
                        <button class="btn-success" onclick="quickAddProduct()" title="إضافة سريعة (Ctrl+N)">
                            <i class="fas fa-bolt ml-2"></i>
                            إضافة سريعة
                        </button>
                        <button class="btn-secondary" onclick="exportProductsData()">
                            <i class="fas fa-download ml-2"></i>
                            تصدير البيانات
                        </button>
                    </div>
                </div>

                <div class="card p-6">
                    <div class="mb-4 flex gap-4">
                        <input type="text" id="productSearch" placeholder="البحث في المنتجات..." class="flex-1 p-2 border rounded-lg">
                        <select id="categoryFilter" class="p-2 border rounded-lg">
                            <option value="">جميع الأصناف</option>
                        </select>
                        <button onclick="applyProductFilters()" class="btn-primary">
                            <i class="fas fa-search ml-2"></i>
                            بحث
                        </button>
                    </div>

                    <div class="enhanced-table">
                        <div class="overflow-x-auto">
                            <table class="w-full" id="productsTable">
                                <thead>
                                    <tr>
                                        <th>اسم المنتج</th>
                                        <th>الكود</th>
                                        <th>الصنف</th>
                                        <th>السعر</th>
                                        <th>التكلفة</th>
                                        <th>المخزون</th>
                                        <th>الحد الأدنى</th>
                                        <th>الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="productsTableBody">
                                    <!-- Products will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Categories Page -->
            <div id="categories" class="page">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">إدارة الأصناف</h2>
                    <div class="flex gap-2">
                        <button class="btn-primary" onclick="showAddCategoryModal()">
                            <i class="fas fa-plus ml-2"></i>
                            إضافة صنف جديد
                        </button>
                        <button class="btn-secondary" onclick="exportCategoriesData()">
                            <i class="fas fa-download ml-2"></i>
                            تصدير الأصناف
                        </button>
                    </div>
                </div>

                <div class="card p-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="categoriesGrid">
                        <!-- Categories will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Inventory Page -->
            <div id="inventory" class="page">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">إدارة المخزون</h2>
                    <div class="flex gap-2">
                        <button class="btn-secondary" onclick="exportInventoryReport()">
                            <i class="fas fa-download ml-2"></i>
                            تصدير تقرير المخزون
                        </button>
                        <button class="btn-primary" onclick="showStockAdjustmentModal()">
                            <i class="fas fa-edit ml-2"></i>
                            تعديل المخزون
                        </button>
                    </div>
                </div>

                <!-- Inventory Stats -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                    <div class="card p-6 bg-blue-50">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-blue-600 font-medium">إجمالي المنتجات</p>
                                <p class="text-2xl font-bold text-blue-800" id="inventoryTotalProducts">0</p>
                            </div>
                            <i class="fas fa-boxes text-3xl text-blue-600"></i>
                        </div>
                    </div>

                    <div class="card p-6 bg-green-50">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-green-600 font-medium">قيمة المخزون</p>
                                <p class="text-2xl font-bold text-green-800" id="inventoryTotalValue">0 ر.س</p>
                            </div>
                            <i class="fas fa-dollar-sign text-3xl text-green-600"></i>
                        </div>
                    </div>

                    <div class="card p-6 bg-yellow-50">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-yellow-600 font-medium">مخزون منخفض</p>
                                <p class="text-2xl font-bold text-yellow-800" id="inventoryLowStock">0</p>
                            </div>
                            <i class="fas fa-exclamation-triangle text-3xl text-yellow-600"></i>
                        </div>
                    </div>

                    <div class="card p-6 bg-red-50">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-red-600 font-medium">مخزون منتهي</p>
                                <p class="text-2xl font-bold text-red-800" id="inventoryOutOfStock">0</p>
                            </div>
                            <i class="fas fa-times-circle text-3xl text-red-600"></i>
                        </div>
                    </div>
                </div>

                <div class="card p-6">
                    <div class="mb-4 flex gap-4">
                        <input type="text" id="inventorySearch" placeholder="البحث في المخزون..." class="flex-1 p-2 border rounded-lg">
                        <select id="stockStatusFilter" class="p-2 border rounded-lg">
                            <option value="">جميع الحالات</option>
                            <option value="normal">مخزون طبيعي</option>
                            <option value="low">مخزون منخفض</option>
                            <option value="out">مخزون منتهي</option>
                        </select>
                        <button onclick="applyInventoryFilters()" class="btn-primary">
                            <i class="fas fa-filter ml-2"></i>
                            تطبيق
                        </button>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="p-3 text-right">المنتج</th>
                                    <th class="p-3 text-right">الكود</th>
                                    <th class="p-3 text-right">المخزون الحالي</th>
                                    <th class="p-3 text-right">الحد الأدنى</th>
                                    <th class="p-3 text-right">حالة المخزون</th>
                                    <th class="p-3 text-right">قيمة المخزون</th>
                                    <th class="p-3 text-right">الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="inventoryTableBody">
                                <!-- Inventory items will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Sales/Consumption Page -->
            <div id="sales" class="page">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">المخرجات الأسبوعية</h2>
                    <div class="flex gap-2">
                        <button class="btn-secondary" onclick="exportWeeklyReport()">
                            <i class="fas fa-download ml-2"></i>
                            تصدير التقرير الأسبوعي
                        </button>
                        <button class="btn-primary" onclick="showAddConsumptionModal()">
                            <i class="fas fa-plus ml-2"></i>
                            إضافة استهلاك
                        </button>
                    </div>
                </div>

                <!-- Weekly Stats -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                    <div class="card p-6 bg-green-50">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-green-600 font-medium">استهلاك هذا الأسبوع</p>
                                <p class="text-2xl font-bold text-green-800" id="thisWeekConsumption">0</p>
                            </div>
                            <i class="fas fa-chart-line text-3xl text-green-600"></i>
                        </div>
                    </div>

                    <div class="card p-6 bg-blue-50">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-blue-600 font-medium">الأسبوع الماضي</p>
                                <p class="text-2xl font-bold text-blue-800" id="lastWeekConsumption">0</p>
                            </div>
                            <i class="fas fa-history text-3xl text-blue-600"></i>
                        </div>
                    </div>

                    <div class="card p-6 bg-purple-50">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-purple-600 font-medium">إجمالي الكمية</p>
                                <p class="text-2xl font-bold text-purple-800" id="totalConsumptionQuantity">0</p>
                            </div>
                            <i class="fas fa-boxes text-3xl text-purple-600"></i>
                        </div>
                    </div>

                    <div class="card p-6 bg-orange-50">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-orange-600 font-medium">قيمة الاستهلاك</p>
                                <p class="text-2xl font-bold text-orange-800" id="totalConsumptionValue">0 ر.س</p>
                            </div>
                            <i class="fas fa-money-bill-wave text-3xl text-orange-600"></i>
                        </div>
                    </div>
                </div>

                <div class="card p-6">
                    <div class="mb-4 flex gap-4">
                        <input type="text" id="consumptionSearch" placeholder="البحث في الاستهلاك..." class="flex-1 p-2 border rounded-lg">
                        <select id="weekFilter" class="p-2 border rounded-lg">
                            <option value="current">هذا الأسبوع</option>
                            <option value="last">الأسبوع الماضي</option>
                            <option value="all">جميع الفترات</option>
                        </select>
                        <select id="reasonFilter" class="p-2 border rounded-lg">
                            <option value="">جميع الأسباب</option>
                            <option value="إنتاج">إنتاج</option>
                            <option value="صيانة">صيانة</option>
                            <option value="اختبار">اختبار</option>
                            <option value="عينة">عينة</option>
                            <option value="تلف">تلف</option>
                            <option value="انتهاء صلاحية">انتهاء صلاحية</option>
                            <option value="استخدام داخلي">استخدام داخلي</option>
                            <option value="أخرى">أخرى</option>
                        </select>
                        <button onclick="applyConsumptionFilters()" class="btn-primary">
                            <i class="fas fa-filter ml-2"></i>
                            تطبيق
                        </button>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="p-3 text-right">المنتج</th>
                                    <th class="p-3 text-right">الصنف</th>
                                    <th class="p-3 text-right">الكمية</th>
                                    <th class="p-3 text-right">الوحدة</th>
                                    <th class="p-3 text-right">التاريخ</th>
                                    <th class="p-3 text-right">السبب</th>
                                    <th class="p-3 text-right">القيمة</th>
                                    <th class="p-3 text-right">الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="consumptionTableBody">
                                <!-- Consumption items will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Other pages placeholders -->
            <div id="movements" class="page">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">حركات المخزون</h2>
                    <div class="flex gap-2">
                        <button class="btn-primary" onclick="showAddMovementModal()">
                            <i class="fas fa-plus ml-2"></i>
                            إضافة حركة جديدة
                        </button>
                        <button class="btn-secondary" onclick="exportMovementsData()">
                            <i class="fas fa-download ml-2"></i>
                            تصدير الحركات
                        </button>
                    </div>
                </div>

                <!-- Movement Statistics -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                    <div class="card p-6 bg-gradient-to-br from-blue-50 to-blue-100 border-l-4 border-blue-500">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-blue-600 text-sm font-medium">إجمالي الحركات</p>
                                <p class="text-2xl font-bold text-blue-800" id="totalMovements">0</p>
                            </div>
                            <div class="p-3 bg-blue-500 text-white rounded-lg">
                                <i class="fas fa-exchange-alt text-xl"></i>
                            </div>
                        </div>
                    </div>

                    <div class="card p-6 bg-gradient-to-br from-green-50 to-green-100 border-l-4 border-green-500">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-green-600 text-sm font-medium">حركات الإدخال</p>
                                <p class="text-2xl font-bold text-green-800" id="inMovements">0</p>
                            </div>
                            <div class="p-3 bg-green-500 text-white rounded-lg">
                                <i class="fas fa-arrow-down text-xl"></i>
                            </div>
                        </div>
                    </div>

                    <div class="card p-6 bg-gradient-to-br from-red-50 to-red-100 border-l-4 border-red-500">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-red-600 text-sm font-medium">حركات الإخراج</p>
                                <p class="text-2xl font-bold text-red-800" id="outMovements">0</p>
                            </div>
                            <div class="p-3 bg-red-500 text-white rounded-lg">
                                <i class="fas fa-arrow-up text-xl"></i>
                            </div>
                        </div>
                    </div>

                    <div class="card p-6 bg-gradient-to-br from-purple-50 to-purple-100 border-l-4 border-purple-500">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-purple-600 text-sm font-medium">قيمة الحركات</p>
                                <p class="text-2xl font-bold text-purple-800" id="movementsValue">0 ر.س</p>
                            </div>
                            <div class="p-3 bg-purple-500 text-white rounded-lg">
                                <i class="fas fa-money-bill-wave text-xl"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Filters -->
                <div class="card p-4 mb-6">
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                        <input type="text" id="movementSearch" placeholder="البحث في الحركات..." class="form-input">
                        <select id="movementTypeFilter" class="form-input">
                            <option value="">جميع الأنواع</option>
                            <option value="in">إدخال</option>
                            <option value="out">إخراج</option>
                            <option value="adjustment">تعديل</option>
                            <option value="transfer">نقل</option>
                        </select>
                        <select id="movementProductFilter" class="form-input">
                            <option value="">جميع المنتجات</option>
                        </select>
                        <input type="date" id="movementDateFrom" class="form-input" placeholder="من تاريخ">
                        <input type="date" id="movementDateTo" class="form-input" placeholder="إلى تاريخ">
                    </div>
                    <div class="mt-4 flex gap-2">
                        <button onclick="applyMovementFilters()" class="btn-primary">
                            <i class="fas fa-filter ml-2"></i>
                            تطبيق الفلاتر
                        </button>
                        <button onclick="clearMovementFilters()" class="btn-secondary">
                            <i class="fas fa-times ml-2"></i>
                            مسح الفلاتر
                        </button>
                    </div>
                </div>

                <!-- Movements Table -->
                <div class="enhanced-table">
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr>
                                    <th>التاريخ</th>
                                    <th>المنتج</th>
                                    <th>نوع الحركة</th>
                                    <th>الكمية</th>
                                    <th>المخزون قبل</th>
                                    <th>المخزون بعد</th>
                                    <th>القيمة</th>
                                    <th>السبب</th>
                                    <th>المستخدم</th>
                                    <th>الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="movementsTableBody">
                                <!-- Movements will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="reports" class="page">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">التقارير والإحصائيات</h2>
                    <div class="flex gap-2">
                        <button class="btn-primary" onclick="generateCustomReport()">
                            <i class="fas fa-chart-bar ml-2"></i>
                            تقرير مخصص
                        </button>
                        <button class="btn-secondary" onclick="exportAllReports()">
                            <i class="fas fa-file-export ml-2"></i>
                            تصدير جميع التقارير
                        </button>
                    </div>
                </div>

                <!-- Report Categories -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <!-- Inventory Reports -->
                    <div class="card p-6 border-l-4 border-blue-500">
                        <h3 class="text-lg font-bold text-blue-800 mb-4">
                            <i class="fas fa-boxes ml-2"></i>
                            تقارير المخزون
                        </h3>
                        <div class="space-y-3">
                            <button onclick="generateInventoryReport()" class="w-full text-left p-3 hover:bg-blue-50 rounded-lg transition-colors">
                                <i class="fas fa-warehouse text-blue-600 ml-2"></i>
                                تقرير المخزون الحالي
                            </button>
                            <button onclick="generateLowStockReport()" class="w-full text-left p-3 hover:bg-blue-50 rounded-lg transition-colors">
                                <i class="fas fa-exclamation-triangle text-yellow-600 ml-2"></i>
                                تقرير المخزون المنخفض
                            </button>
                            <button onclick="generateStockValueReport()" class="w-full text-left p-3 hover:bg-blue-50 rounded-lg transition-colors">
                                <i class="fas fa-money-bill-wave text-green-600 ml-2"></i>
                                تقرير قيمة المخزون
                            </button>
                            <button onclick="generateStockMovementReport()" class="w-full text-left p-3 hover:bg-blue-50 rounded-lg transition-colors">
                                <i class="fas fa-exchange-alt text-purple-600 ml-2"></i>
                                تقرير حركة المخزون
                            </button>
                        </div>
                    </div>

                    <!-- Sales Reports -->
                    <div class="card p-6 border-l-4 border-green-500">
                        <h3 class="text-lg font-bold text-green-800 mb-4">
                            <i class="fas fa-chart-line ml-2"></i>
                            تقارير المبيعات والاستهلاك
                        </h3>
                        <div class="space-y-3">
                            <button onclick="generateConsumptionReport()" class="w-full text-left p-3 hover:bg-green-50 rounded-lg transition-colors">
                                <i class="fas fa-shopping-cart text-green-600 ml-2"></i>
                                تقرير الاستهلاك الأسبوعي
                            </button>
                            <button onclick="generateTopProductsReport()" class="w-full text-left p-3 hover:bg-green-50 rounded-lg transition-colors">
                                <i class="fas fa-star text-yellow-600 ml-2"></i>
                                تقرير المنتجات الأكثر استهلاكاً
                            </button>
                            <button onclick="generateCategoryReport()" class="w-full text-left p-3 hover:bg-green-50 rounded-lg transition-colors">
                                <i class="fas fa-tags text-blue-600 ml-2"></i>
                                تقرير الاستهلاك حسب الصنف
                            </button>
                            <button onclick="generateProfitReport()" class="w-full text-left p-3 hover:bg-green-50 rounded-lg transition-colors">
                                <i class="fas fa-chart-pie text-purple-600 ml-2"></i>
                                تقرير الأرباح المتوقعة
                            </button>
                        </div>
                    </div>

                    <!-- Analysis Reports -->
                    <div class="card p-6 border-l-4 border-purple-500">
                        <h3 class="text-lg font-bold text-purple-800 mb-4">
                            <i class="fas fa-analytics ml-2"></i>
                            تقارير التحليل
                        </h3>
                        <div class="space-y-3">
                            <button onclick="generateTrendReport()" class="w-full text-left p-3 hover:bg-purple-50 rounded-lg transition-colors">
                                <i class="fas fa-trending-up text-purple-600 ml-2"></i>
                                تحليل الاتجاهات
                            </button>
                            <button onclick="generateSeasonalReport()" class="w-full text-left p-3 hover:bg-purple-50 rounded-lg transition-colors">
                                <i class="fas fa-calendar-alt text-blue-600 ml-2"></i>
                                التحليل الموسمي
                            </button>
                            <button onclick="generatePerformanceReport()" class="w-full text-left p-3 hover:bg-purple-50 rounded-lg transition-colors">
                                <i class="fas fa-tachometer-alt text-green-600 ml-2"></i>
                                تقرير الأداء العام
                            </button>
                            <button onclick="generateForecastReport()" class="w-full text-left p-3 hover:bg-purple-50 rounded-lg transition-colors">
                                <i class="fas fa-crystal-ball text-indigo-600 ml-2"></i>
                                توقعات المخزون
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Quick Stats -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                    <div class="card p-6 text-center bg-gradient-to-br from-blue-500 to-blue-600 text-white">
                        <i class="fas fa-boxes text-3xl mb-3"></i>
                        <h4 class="text-lg font-bold">إجمالي المنتجات</h4>
                        <p class="text-2xl font-bold" id="reportTotalProducts">0</p>
                    </div>
                    <div class="card p-6 text-center bg-gradient-to-br from-green-500 to-green-600 text-white">
                        <i class="fas fa-money-bill-wave text-3xl mb-3"></i>
                        <h4 class="text-lg font-bold">قيمة المخزون</h4>
                        <p class="text-2xl font-bold" id="reportInventoryValue">0 ر.س</p>
                    </div>
                    <div class="card p-6 text-center bg-gradient-to-br from-yellow-500 to-yellow-600 text-white">
                        <i class="fas fa-exclamation-triangle text-3xl mb-3"></i>
                        <h4 class="text-lg font-bold">مخزون منخفض</h4>
                        <p class="text-2xl font-bold" id="reportLowStock">0</p>
                    </div>
                    <div class="card p-6 text-center bg-gradient-to-br from-purple-500 to-purple-600 text-white">
                        <i class="fas fa-chart-line text-3xl mb-3"></i>
                        <h4 class="text-lg font-bold">استهلاك الشهر</h4>
                        <p class="text-2xl font-bold" id="reportMonthlyConsumption">0</p>
                    </div>
                </div>

                <!-- Report Display Area -->
                <div id="reportDisplayArea" class="card p-6" style="display: none;">
                    <div class="flex justify-between items-center mb-4">
                        <h3 id="reportTitle" class="text-xl font-bold">تقرير</h3>
                        <div class="flex gap-2">
                            <button onclick="printReport()" class="btn-secondary">
                                <i class="fas fa-print ml-2"></i>
                                طباعة
                            </button>
                            <button onclick="exportReportPDF()" class="btn-secondary">
                                <i class="fas fa-file-pdf ml-2"></i>
                                PDF
                            </button>
                            <button onclick="exportReportExcel()" class="btn-secondary">
                                <i class="fas fa-file-excel ml-2"></i>
                                Excel
                            </button>
                            <button onclick="closeReport()" class="btn-danger">
                                <i class="fas fa-times ml-2"></i>
                                إغلاق
                            </button>
                        </div>
                    </div>
                    <div id="reportContent">
                        <!-- Report content will be displayed here -->
                    </div>
                </div>
            </div>

            <div id="settings" class="page">
                <h2 class="text-2xl font-bold mb-6">الإعدادات</h2>

                <!-- Sync Settings -->
                <div class="card p-6 mb-6">
                    <h3 class="text-lg font-semibold mb-4 text-gray-800">
                        <i class="fas fa-sync-alt ml-2 text-blue-600"></i>
                        إعدادات المزامنة والحفظ التلقائي
                    </h3>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Auto Save Settings -->
                        <div class="space-y-4">
                            <h4 class="font-medium text-gray-700">الحفظ التلقائي</h4>

                            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                <span class="text-sm text-gray-600">تفعيل الحفظ التلقائي</span>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="autoSaveToggle" class="sr-only peer" checked>
                                    <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                </label>
                            </div>

                            <div class="space-y-2">
                                <label class="block text-sm text-gray-600">فترة الحفظ التلقائي (ثانية)</label>
                                <select id="autoSaveInterval" class="w-full p-2 border rounded-lg">
                                    <option value="1000">1 ثانية</option>
                                    <option value="2000" selected>2 ثانية</option>
                                    <option value="5000">5 ثواني</option>
                                    <option value="10000">10 ثواني</option>
                                    <option value="30000">30 ثانية</option>
                                </select>
                            </div>

                            <div class="space-y-2">
                                <label class="block text-sm text-gray-600">عدد النسخ الاحتياطية</label>
                                <select id="backupCount" class="w-full p-2 border rounded-lg">
                                    <option value="1">نسخة واحدة</option>
                                    <option value="2">نسختان</option>
                                    <option value="3" selected>3 نسخ</option>
                                    <option value="5">5 نسخ</option>
                                </select>
                            </div>
                        </div>

                        <!-- Sync Monitoring -->
                        <div class="space-y-4">
                            <h4 class="font-medium text-gray-700">مراقبة المزامنة</h4>

                            <div class="p-3 bg-blue-50 rounded-lg">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-sm font-medium text-blue-800">حالة المزامنة</span>
                                    <span id="settingsSyncStatus" class="text-sm text-blue-600">متصل</span>
                                </div>
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-sm text-blue-700">آخر مزامنة</span>
                                    <span id="settingsLastSync" class="text-sm text-blue-600">الآن</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-blue-700">في الانتظار</span>
                                    <span id="settingsQueueCount" class="text-sm text-blue-600">0</span>
                                </div>
                            </div>

                            <div class="space-y-2">
                                <button onclick="forceSyncData()" class="w-full btn-primary">
                                    <i class="fas fa-sync-alt ml-2"></i>
                                    فرض المزامنة الآن
                                </button>
                                <button onclick="clearSyncQueue()" class="w-full btn-secondary">
                                    <i class="fas fa-trash ml-2"></i>
                                    مسح طابور المزامنة
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Data Management -->
                <div class="card p-6 mb-6">
                    <h3 class="text-lg font-semibold mb-4 text-gray-800">
                        <i class="fas fa-database ml-2 text-green-600"></i>
                        إدارة البيانات المحسنة
                    </h3>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Backup and Export -->
                        <div class="space-y-4">
                            <h4 class="font-medium text-gray-700">النسخ الاحتياطية والتصدير</h4>

                            <button onclick="saveDataToExternalFiles()" class="w-full btn-primary">
                                <i class="fas fa-download ml-2"></i>
                                تصدير جميع البيانات (ملفات منفصلة)
                            </button>

                            <button onclick="createCompleteBackup()" class="w-full btn-success">
                                <i class="fas fa-archive ml-2"></i>
                                إنشاء نسخة احتياطية كاملة
                            </button>

                            <button onclick="createManualBackup()" class="w-full btn-secondary">
                                <i class="fas fa-save ml-2"></i>
                                حفظ سريع
                            </button>
                        </div>

                        <!-- Import and Restore -->
                        <div class="space-y-4">
                            <h4 class="font-medium text-gray-700">الاستيراد والاستعادة</h4>

                            <button onclick="importDataFromFiles()" class="w-full btn-primary">
                                <i class="fas fa-upload ml-2"></i>
                                استيراد البيانات من ملفات
                            </button>

                            <button onclick="restoreFromBackup()" class="w-full btn-warning">
                                <i class="fas fa-undo ml-2"></i>
                                استعادة من النسخة الاحتياطية
                            </button>

                            <button onclick="showDataStatistics()" class="w-full btn-secondary">
                                <i class="fas fa-chart-bar ml-2"></i>
                                إحصائيات البيانات
                            </button>
                        </div>
                    </div>

                    <!-- Data Status -->
                    <div class="mt-6 p-4 bg-gray-50 rounded-lg">
                        <h4 class="font-medium text-gray-700 mb-3">حالة البيانات</h4>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                            <div class="text-center">
                                <div class="font-semibold text-blue-600" id="dataProductsCount">0</div>
                                <div class="text-gray-600">المنتجات</div>
                            </div>
                            <div class="text-center">
                                <div class="font-semibold text-green-600" id="dataCategoriesCount">0</div>
                                <div class="text-gray-600">الأصناف</div>
                            </div>
                            <div class="text-center">
                                <div class="font-semibold text-purple-600" id="dataConsumptionsCount">0</div>
                                <div class="text-gray-600">الاستهلاك</div>
                            </div>
                            <div class="text-center">
                                <div class="font-semibold text-orange-600" id="dataMovementsCount">0</div>
                                <div class="text-gray-600">الحركات</div>
                            </div>
                        </div>
                    </div>

                    <!-- Instructions -->
                    <div class="mt-4 p-4 bg-blue-50 rounded-lg">
                        <h4 class="font-medium text-blue-800 mb-2">
                            <i class="fas fa-info-circle ml-2"></i>
                            تعليمات نقل البيانات بين الأجهزة
                        </h4>
                        <ol class="text-sm text-blue-700 space-y-1">
                            <li>1. اضغط على "تصدير جميع البيانات" لحفظ الملفات</li>
                            <li>2. انسخ الملفات المحفوظة مع ملف النظام إلى الجهاز الجديد</li>
                            <li>3. ضع جميع الملفات في نفس المجلد</li>
                            <li>4. افتح النظام - سيتم تحميل البيانات تلقائياً</li>
                            <li>5. أو استخدم "استيراد البيانات" لتحميل الملفات يدوياً</li>
                        </ol>
                    </div>
                </div>

                <!-- User Settings -->
                <div class="card p-6">
                    <h3 class="text-lg font-semibold mb-4 text-gray-800">
                        <i class="fas fa-user ml-2 text-purple-600"></i>
                        إعدادات المستخدم
                    </h3>

                    <div class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm text-gray-600 mb-2">اسم المستخدم الحالي</label>
                                <input type="text" id="currentUsername" class="w-full p-2 border rounded-lg bg-gray-100" readonly>
                            </div>
                            <div>
                                <label class="block text-sm text-gray-600 mb-2">الدور</label>
                                <input type="text" id="currentUserRole" class="w-full p-2 border rounded-lg bg-gray-100" readonly>
                            </div>
                        </div>

                        <div class="flex gap-4">
                            <button onclick="showChangePasswordModal()" class="btn-primary">
                                <i class="fas fa-key ml-2"></i>
                                تغيير كلمة المرور
                            </button>
                            <button onclick="logout()" class="btn-danger">
                                <i class="fas fa-sign-out-alt ml-2"></i>
                                تسجيل الخروج
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Add Consumption Modal -->
                <div id="addConsumptionModal" class="modal">
                    <div class="modal-header">
                        <h3 class="modal-title">
                            <i class="fas fa-minus-circle ml-2"></i>
                            إضافة استهلاك جديد
                        </h3>
                        <button class="modal-close" onclick="closeModal('addConsumptionModal')">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        <form id="addConsumptionForm" class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">المنتج *</label>
                                    <select id="consumptionProduct" class="form-input" required onchange="updateConsumptionInfo()">
                                        <option value="">اختر المنتج</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">الكمية *</label>
                                    <input type="number" id="consumptionQuantity" class="form-input" placeholder="0" min="1" required onchange="updateConsumptionInfo()">
                                </div>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">السبب *</label>
                                    <select id="consumptionReason" class="form-input" required>
                                        <option value="">اختر السبب</option>
                                        <option value="إنتاج">إنتاج</option>
                                        <option value="صيانة">صيانة</option>
                                        <option value="اختبار">اختبار</option>
                                        <option value="عينة">عينة</option>
                                        <option value="تلف">تلف</option>
                                        <option value="انتهاء صلاحية">انتهاء صلاحية</option>
                                        <option value="استخدام داخلي">استخدام داخلي</option>
                                        <option value="أخرى">أخرى</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">التاريخ *</label>
                                    <input type="datetime-local" id="consumptionDate" class="form-input" required>
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">ملاحظات</label>
                                <textarea id="consumptionNotes" class="form-input" rows="3" placeholder="ملاحظات إضافية (اختياري)"></textarea>
                            </div>

                            <div id="consumptionInfo" class="p-4 bg-gray-50 rounded-lg" style="display: none;">
                                <h4 class="font-medium text-gray-800 mb-2">معلومات المنتج:</h4>
                                <div class="grid grid-cols-2 gap-4 text-sm">
                                    <div>
                                        <span class="text-gray-600">المخزون الحالي:</span>
                                        <span id="currentStockInfo" class="font-medium">-</span>
                                    </div>
                                    <div>
                                        <span class="text-gray-600">المخزون بعد الاستهلاك:</span>
                                        <span id="stockAfterConsumption" class="font-medium">-</span>
                                    </div>
                                    <div>
                                        <span class="text-gray-600">تكلفة الوحدة:</span>
                                        <span id="unitCostInfo" class="font-medium">-</span>
                                    </div>
                                    <div>
                                        <span class="text-gray-600">إجمالي التكلفة:</span>
                                        <span id="totalCostInfo" class="font-medium">-</span>
                                    </div>
                                </div>
                                <div id="stockWarning" class="mt-2 p-2 bg-yellow-100 text-yellow-800 rounded text-sm" style="display: none;">
                                    <i class="fas fa-exclamation-triangle ml-1"></i>
                                    تحذير: المخزون سيصبح منخفضاً أو منتهياً
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn-secondary" onclick="closeModal('addConsumptionModal')">
                            <i class="fas fa-times ml-2"></i>
                            إلغاء
                        </button>
                        <button type="button" class="btn-primary" onclick="saveNewConsumption()">
                            <i class="fas fa-save ml-2"></i>
                            حفظ الاستهلاك
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Authentication System
        let currentUser = null;

        // User credentials and roles (Only 2 users)
        const users = {
            'admin': {
                password: 'admin123',
                role: 'admin',
                name: 'مدير النظام',
                permissions: ['all']
            },
            'user': {
                password: 'user123',
                role: 'user',
                name: 'مستخدم النظام',
                permissions: ['dashboard', 'products', 'categories', 'inventory', 'sales', 'settings']
            }
        };

        // Security variables
        let currentCaptcha = '';
        let loginAttempts = 0;
        let isBlocked = false;
        let blockEndTime = null;

        function generateCaptcha() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            currentCaptcha = '';
            for (let i = 0; i < 6; i++) {
                currentCaptcha += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            document.getElementById('captchaCode').textContent = currentCaptcha;
        }

        function handleLogin(event) {
            event.preventDefault();

            // Check if blocked
            if (isBlocked) {
                const remainingTime = Math.ceil((blockEndTime - Date.now()) / 1000);
                if (remainingTime > 0) {
                    showError(`تم حظر تسجيل الدخول لمدة ${remainingTime} ثانية بسبب المحاولات الخاطئة`);
                    return;
                } else {
                    isBlocked = false;
                    loginAttempts = 0;
                }
            }

            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            const securityCode = document.getElementById('securityCode').value.trim();

            // Clear previous messages
            hideMessages();

            // Show security check
            showSecurityCheck();

            setTimeout(() => {
                hideSecurityCheck();

                // Validate inputs
                if (!username || !password || !securityCode) {
                    showError('يرجى ملء جميع الحقول المطلوبة');
                    loginAttempts++;
                    checkLoginAttempts();
                    return;
                }

                // Check security code
                if (securityCode.toUpperCase() !== currentCaptcha) {
                    showError('رمز الأمان غير صحيح');
                    generateCaptcha();
                    document.getElementById('securityCode').value = '';
                    loginAttempts++;
                    checkLoginAttempts();
                    return;
                }

                // Check credentials
                const user = users[username];
                if (!user) {
                    showError('معرف المستخدم غير صحيح');
                    generateCaptcha();
                    document.getElementById('securityCode').value = '';
                    loginAttempts++;
                    checkLoginAttempts();
                    return;
                }

                if (user.password !== password) {
                    showError('كلمة المرور غير صحيحة');
                    generateCaptcha();
                    document.getElementById('securityCode').value = '';
                    loginAttempts++;
                    checkLoginAttempts();
                    return;
                }

                // Successful login
                loginAttempts = 0;
                currentUser = {
                    username: username,
                    name: user.name,
                    role: user.role,
                    permissions: user.permissions,
                    loginTime: new Date().toISOString()
                };

                // Save login state
                if (document.getElementById('rememberMe').checked) {
                    localStorage.setItem('makhzan_user_secure', JSON.stringify(currentUser));
                } else {
                    sessionStorage.setItem('makhzan_user_secure', JSON.stringify(currentUser));
                }

                showSuccess('تم التحقق من الهوية بنجاح');

                setTimeout(() => {
                    showMainApp();
                }, 1500);

            }, 2000); // Security check delay
        }

        function checkLoginAttempts() {
            if (loginAttempts >= 3) {
                isBlocked = true;
                blockEndTime = Date.now() + (30 * 1000); // Block for 30 seconds
                showError('تم حظر تسجيل الدخول لمدة 30 ثانية بسبب المحاولات الخاطئة المتكررة');

                // Disable form
                document.getElementById('loginButton').disabled = true;
                document.getElementById('loginForm').style.opacity = '0.5';

                setTimeout(() => {
                    isBlocked = false;
                    loginAttempts = 0;
                    document.getElementById('loginButton').disabled = false;
                    document.getElementById('loginForm').style.opacity = '1';
                    generateCaptcha();
                }, 30000);
            }
        }

        function showSecurityCheck() {
            const securityMsg = document.getElementById('securityMessage');
            securityMsg.style.display = 'block';
            securityMsg.innerHTML = '<i class="fas fa-shield-alt ml-1"></i>جاري التحقق من الأمان...';
        }

        function hideSecurityCheck() {
            document.getElementById('securityMessage').style.display = 'none';
        }

        function showMainApp() {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('mainApp').style.display = 'flex';

            // Update user info in header
            document.getElementById('currentUserName').textContent = currentUser.name;
            document.getElementById('currentUserRole').textContent = getRoleDisplayName(currentUser.role);

            // Apply role-based restrictions
            applyRoleRestrictions();

            // Initialize app
            initializeApp();
        }

        function getRoleDisplayName(role) {
            switch (role) {
                case 'admin': return 'مدير النظام';
                case 'user': return 'مستخدم النظام';
                default: return 'مستخدم';
            }
        }

        function applyRoleRestrictions() {
            const sidebarItems = document.querySelectorAll('.sidebar-item');

            sidebarItems.forEach(item => {
                const onclick = item.getAttribute('onclick');
                if (onclick) {
                    const page = onclick.match(/showPage\('(\w+)'\)/);
                    if (page) {
                        const pageName = page[1];
                        if (!hasPermission(pageName)) {
                            item.style.display = 'none';
                        }
                    }
                }
            });

            // Hide certain buttons based on role
            if (currentUser.role === 'user') {
                // Users have limited access to some features
                hideUserRestrictedElements();
            }
        }

        function hasPermission(page) {
            if (currentUser.permissions.includes('all')) {
                return true;
            }
            return currentUser.permissions.includes(page);
        }

        function hideUserRestrictedElements() {
            // Hide movements and reports for regular users
            const restrictedPages = ['movements', 'reports'];
            restrictedPages.forEach(page => {
                const element = document.querySelector(`[onclick="showPage('${page}')"]`);
                if (element) {
                    element.style.display = 'none';
                }
            });
            console.log('تم تطبيق قيود المستخدم العادي');
        }

        function logout() {
            if (confirm('هل أنت متأكد من تسجيل الخروج؟')) {
                // Clear stored login data
                localStorage.removeItem('makhzan_user_secure');
                sessionStorage.removeItem('makhzan_user_secure');

                // Reset current user
                currentUser = null;

                // Show login page
                document.getElementById('mainApp').style.display = 'none';
                document.getElementById('loginPage').style.display = 'flex';

                // Reset login form
                document.getElementById('loginForm').reset();
                hideMessages();

                showSuccess('تم تسجيل الخروج بنجاح');
            }
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';

            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        function showSuccess(message) {
            const successDiv = document.getElementById('successMessage');
            successDiv.textContent = message;
            successDiv.style.display = 'block';

            setTimeout(() => {
                successDiv.style.display = 'none';
            }, 3000);
        }

        function hideMessages() {
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('successMessage').style.display = 'none';
        }

        function checkAutoLogin() {
            // Check for saved login data
            let savedUser = localStorage.getItem('makhzan_user_secure') || sessionStorage.getItem('makhzan_user_secure');

            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    showMainApp();
                    return true;
                } catch (error) {
                    console.error('Error parsing saved user data:', error);
                    localStorage.removeItem('makhzan_user_secure');
                    sessionStorage.removeItem('makhzan_user_secure');
                }
            }
            return false;
        }

        function initializeApp() {
            console.log('تهيئة النظام المتقدم...');

            // Initialize sync system first
            initializeSyncSystem();

            // Load data from localStorage
            loadFromLocalStorage();

            // Show dashboard
            showPage('dashboard');

            // Render all components
            renderProducts();
            renderCategories();
            renderInventory();
            updateDashboardStats();

            // Populate category filters
            populateCategoryFilters();

            // Force initial sync
            queueDataChange('app_initialize', {
                timestamp: new Date().toISOString(),
                user: currentUser.name,
                action: 'تهيئة النظام'
            });

            console.log('تم تحميل النظام مع المزامنة المتقدمة');

            showNotification(`مرحباً ${currentUser.name} - النظام جاهز مع الحفظ التلقائي`, 'success');
        }

        function populateCategoryFilters() {
            const categoryFilter = document.getElementById('categoryFilter');
            if (categoryFilter) {
                categoryFilter.innerHTML = '<option value="">جميع الأصناف</option>' +
                    categories.map(cat => `<option value="${cat.name}">${cat.name}</option>`).join('');
            }
        }

        // Data arrays with initial sample data
        let products = [];
        let categories = [];
        let weeklyConsumptions = [];
        let stockMovements = [];
        let reports = [];

        // Sample database initialization
        function initializeSampleData() {
            // Sample categories
            const sampleCategories = [
                {
                    id: 1,
                    name: 'مواد غذائية',
                    description: 'جميع المواد الغذائية والمشروبات',
                    color: '#3b82f6',
                    createdAt: new Date().toISOString()
                },
                {
                    id: 2,
                    name: 'مواد تنظيف',
                    description: 'مواد التنظيف والصابون',
                    color: '#10b981',
                    createdAt: new Date().toISOString()
                },
                {
                    id: 3,
                    name: 'أدوات مكتبية',
                    description: 'القرطاسية والأدوات المكتبية',
                    color: '#f59e0b',
                    createdAt: new Date().toISOString()
                },
                {
                    id: 4,
                    name: 'مستلزمات طبية',
                    description: 'الأدوية والمستلزمات الطبية',
                    color: '#ef4444',
                    createdAt: new Date().toISOString()
                }
            ];

            // Sample products
            const sampleProducts = [
                {
                    id: 1,
                    name: 'أرز بسمتي',
                    code: 'RICE001',
                    category: 'مواد غذائية',
                    categoryId: 1,
                    price: 25.50,
                    cost: 20.00,
                    currentStock: 150,
                    minStock: 20,
                    unit: 'كيس',
                    description: 'أرز بسمتي فاخر 5 كيلو',
                    barcode: '1234567890123',
                    supplier: 'شركة الأرز الذهبي',
                    createdAt: new Date().toISOString(),
                    lastModified: new Date().toISOString()
                },
                {
                    id: 2,
                    name: 'زيت طبخ',
                    code: 'OIL001',
                    category: 'مواد غذائية',
                    categoryId: 1,
                    price: 18.75,
                    cost: 15.00,
                    currentStock: 80,
                    minStock: 15,
                    unit: 'عبوة',
                    description: 'زيت طبخ نباتي 1.8 لتر',
                    barcode: '1234567890124',
                    supplier: 'مصنع الزيوت المتحدة',
                    createdAt: new Date().toISOString(),
                    lastModified: new Date().toISOString()
                },
                {
                    id: 3,
                    name: 'صابون غسيل',
                    code: 'SOAP001',
                    category: 'مواد تنظيف',
                    categoryId: 2,
                    price: 12.00,
                    cost: 9.50,
                    currentStock: 45,
                    minStock: 10,
                    unit: 'قطعة',
                    description: 'صابون غسيل للملابس 400 جرام',
                    barcode: '1234567890125',
                    supplier: 'شركة المنظفات الحديثة',
                    createdAt: new Date().toISOString(),
                    lastModified: new Date().toISOString()
                },
                {
                    id: 4,
                    name: 'أقلام حبر',
                    code: 'PEN001',
                    category: 'أدوات مكتبية',
                    categoryId: 3,
                    price: 2.50,
                    cost: 1.75,
                    currentStock: 200,
                    minStock: 50,
                    unit: 'قلم',
                    description: 'أقلام حبر زرقاء',
                    barcode: '1234567890126',
                    supplier: 'مكتبة الطالب',
                    createdAt: new Date().toISOString(),
                    lastModified: new Date().toISOString()
                },
                {
                    id: 5,
                    name: 'ورق A4',
                    code: 'PAPER001',
                    category: 'أدوات مكتبية',
                    categoryId: 3,
                    price: 35.00,
                    cost: 28.00,
                    currentStock: 25,
                    minStock: 5,
                    unit: 'رزمة',
                    description: 'ورق طباعة A4 أبيض 500 ورقة',
                    barcode: '1234567890127',
                    supplier: 'مصنع الورق الوطني',
                    createdAt: new Date().toISOString(),
                    lastModified: new Date().toISOString()
                },
                {
                    id: 6,
                    name: 'مطهر يدين',
                    code: 'HAND001',
                    category: 'مستلزمات طبية',
                    categoryId: 4,
                    price: 15.00,
                    cost: 12.00,
                    currentStock: 8,
                    minStock: 10,
                    unit: 'عبوة',
                    description: 'مطهر يدين كحولي 250 مل',
                    barcode: '1234567890128',
                    supplier: 'الصيدلية المركزية',
                    createdAt: new Date().toISOString(),
                    lastModified: new Date().toISOString()
                }
            ];

            // Sample consumption data
            const sampleConsumptions = [
                {
                    id: 1,
                    productId: 1,
                    productName: 'أرز بسمتي',
                    quantity: 5,
                    unitCost: 20.00,
                    reason: 'إنتاج',
                    notes: 'استخدام في المطبخ',
                    date: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000).toISOString(),
                    user: 'المدير'
                },
                {
                    id: 2,
                    productId: 3,
                    productName: 'صابون غسيل',
                    quantity: 3,
                    unitCost: 9.50,
                    reason: 'استخدام داخلي',
                    notes: 'تنظيف المكاتب',
                    date: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000).toISOString(),
                    user: 'العامل'
                },
                {
                    id: 3,
                    productId: 4,
                    productName: 'أقلام حبر',
                    quantity: 10,
                    unitCost: 1.75,
                    reason: 'استخدام داخلي',
                    notes: 'توزيع على الموظفين',
                    date: new Date().toISOString(),
                    user: 'المدير'
                }
            ];

            // Sample stock movements
            const sampleMovements = [
                {
                    id: 1,
                    productId: 1,
                    productName: 'أرز بسمتي',
                    type: 'in',
                    quantity: 100,
                    stockBefore: 50,
                    stockAfter: 150,
                    unitCost: 20.00,
                    totalValue: 2000.00,
                    reason: 'شراء جديد',
                    notes: 'وصول شحنة جديدة من المورد',
                    date: new Date(Date.now() - 5 * 24 * 60 * 60 * 1000).toISOString(),
                    user: 'المدير',
                    reference: 'PO-001'
                },
                {
                    id: 2,
                    productId: 2,
                    productName: 'زيت طبخ',
                    type: 'in',
                    quantity: 50,
                    stockBefore: 30,
                    stockAfter: 80,
                    unitCost: 15.00,
                    totalValue: 750.00,
                    reason: 'شراء جديد',
                    notes: 'تجديد المخزون',
                    date: new Date(Date.now() - 4 * 24 * 60 * 60 * 1000).toISOString(),
                    user: 'المدير',
                    reference: 'PO-002'
                },
                {
                    id: 3,
                    productId: 1,
                    productName: 'أرز بسمتي',
                    type: 'out',
                    quantity: 5,
                    stockBefore: 150,
                    stockAfter: 145,
                    unitCost: 20.00,
                    totalValue: 100.00,
                    reason: 'إنتاج',
                    notes: 'استخدام في المطبخ',
                    date: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000).toISOString(),
                    user: 'المدير',
                    reference: 'OUT-001'
                },
                {
                    id: 4,
                    productId: 3,
                    productName: 'صابون غسيل',
                    type: 'out',
                    quantity: 3,
                    stockBefore: 48,
                    stockAfter: 45,
                    unitCost: 9.50,
                    totalValue: 28.50,
                    reason: 'استخدام داخلي',
                    notes: 'تنظيف المكاتب',
                    date: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000).toISOString(),
                    user: 'العامل',
                    reference: 'OUT-002'
                },
                {
                    id: 5,
                    productId: 6,
                    productName: 'مطهر يدين',
                    type: 'adjustment',
                    quantity: -2,
                    stockBefore: 10,
                    stockAfter: 8,
                    unitCost: 12.00,
                    totalValue: -24.00,
                    reason: 'تلف',
                    notes: 'انتهاء صلاحية عبوتين',
                    date: new Date(Date.now() - 3 * 24 * 60 * 60 * 1000).toISOString(),
                    user: 'المدير',
                    reference: 'ADJ-001'
                }
            ];

            // Only initialize if no data exists
            if (categories.length === 0) {
                categories = sampleCategories;
            }
            if (products.length === 0) {
                products = sampleProducts;
            }
            if (weeklyConsumptions.length === 0) {
                weeklyConsumptions = sampleConsumptions;
            }
            if (stockMovements.length === 0) {
                stockMovements = sampleMovements;
            }

            // Save to localStorage
            saveToLocalStorage();
            console.log('تم تحميل البيانات التجريبية بنجاح');
        }

        // Enhanced Dashboard Functions
        function updateCurrentDateTime() {
            const now = new Date();
            const options = {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            };

            const dateTimeElement = document.getElementById('currentDateTime');
            if (dateTimeElement) {
                dateTimeElement.textContent = now.toLocaleDateString('ar-SA', options);
            }
        }

        function addRecentActivity(type, title, time = new Date()) {
            const activityList = document.getElementById('recentActivityList');
            if (!activityList) return;

            const activityItem = document.createElement('div');
            activityItem.className = 'activity-item';

            const iconClass = type === 'add' ? 'add' : type === 'edit' ? 'edit' : 'delete';
            const iconName = type === 'add' ? 'fa-plus' : type === 'edit' ? 'fa-edit' : 'fa-trash';

            activityItem.innerHTML = `
                <div class="activity-icon ${iconClass}">
                    <i class="fas ${iconName}"></i>
                </div>
                <div class="activity-content">
                    <div class="activity-title">${title}</div>
                    <div class="activity-time">${time.toLocaleString('ar-SA')}</div>
                </div>
            `;

            // Add to beginning of list
            activityList.insertBefore(activityItem, activityList.firstChild);

            // Keep only last 5 activities
            while (activityList.children.length > 5) {
                activityList.removeChild(activityList.lastChild);
            }
        }

        function animateNumber(elementId, targetValue, duration = 1000) {
            const element = document.getElementById(elementId);
            if (!element) return;

            const startValue = parseInt(element.textContent) || 0;
            const increment = (targetValue - startValue) / (duration / 16);
            let currentValue = startValue;

            const timer = setInterval(() => {
                currentValue += increment;
                if ((increment > 0 && currentValue >= targetValue) ||
                    (increment < 0 && currentValue <= targetValue)) {
                    currentValue = targetValue;
                    clearInterval(timer);
                }
                element.textContent = Math.round(currentValue);
            }, 16);
        }

        function updateDashboardStats() {
            // Update current date/time
            updateCurrentDateTime();

            const totalProducts = products.length;
            const totalCategories = categories.length;
            const lowStockProducts = products.filter(p => p.currentStock <= p.minStock).length;
            const totalInventoryValue = products.reduce((sum, p) => sum + (p.currentStock * p.cost), 0);

            // Calculate weekly consumption
            const oneWeekAgo = new Date();
            oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
            const weeklyConsumption = (weeklyConsumptions || []).filter(c =>
                new Date(c.date) >= oneWeekAgo
            ).reduce((sum, c) => sum + c.quantity, 0);

            // Calculate consumption value
            const consumptionValue = (weeklyConsumptions || []).filter(c =>
                new Date(c.date) >= oneWeekAgo
            ).reduce((sum, c) => {
                const product = products.find(p => p.id === c.productId);
                return sum + (c.quantity * (product ? product.cost : 0));
            }, 0);

            // Animate numbers
            animateNumber('totalProducts', totalProducts);
            animateNumber('totalCategories', totalCategories);
            animateNumber('lowStockProducts', lowStockProducts);
            animateNumber('totalInventoryValue', Math.round(totalInventoryValue));
            animateNumber('weeklyConsumption', weeklyConsumption);
            animateNumber('consumptionValue', Math.round(consumptionValue));

            // Add pulse animation to cards with changes
            const cards = document.querySelectorAll('.dashboard-card');
            cards.forEach(card => {
                card.classList.add('pulse-animation');
                setTimeout(() => {
                    card.classList.remove('pulse-animation');
                }, 2000);
            });

            // Update recent activity if empty
            const activityList = document.getElementById('recentActivityList');
            if (activityList && activityList.children.length === 0) {
                addRecentActivity('add', 'تم تحميل النظام بنجاح');
                addRecentActivity('edit', 'تم تحديث إحصائيات لوحة التحكم');
            }

            // Update sync dashboard cards
            updateSyncDashboardCards();
        }

        function updateSyncDashboardCards() {
            // Update sync status
            const syncStatusElement = document.getElementById('dashboardSyncStatus');
            const syncIconElement = document.getElementById('dashboardSyncIcon');
            const lastSyncElement = document.getElementById('dashboardLastSync');
            const queueStatusElement = document.getElementById('dashboardQueueStatus');

            if (syncStatusElement && syncIconElement) {
                if (isSyncing) {
                    syncStatusElement.textContent = 'جاري المزامنة...';
                    syncIconElement.className = 'fas fa-sync-alt text-xl fa-spin';
                } else if (lastSyncTime) {
                    const timeDiff = Date.now() - lastSyncTime.getTime();
                    if (timeDiff < 10000) {
                        syncStatusElement.textContent = 'متصل';
                        syncIconElement.className = 'fas fa-check-circle text-xl';
                    } else if (timeDiff < 60000) {
                        syncStatusElement.textContent = 'متأخر';
                        syncIconElement.className = 'fas fa-exclamation-triangle text-xl';
                    } else {
                        syncStatusElement.textContent = 'غير متصل';
                        syncIconElement.className = 'fas fa-times-circle text-xl';
                    }
                } else {
                    syncStatusElement.textContent = 'في الانتظار';
                    syncIconElement.className = 'fas fa-clock text-xl';
                }
            }

            if (lastSyncElement) {
                if (lastSyncTime) {
                    const timeDiff = Date.now() - lastSyncTime.getTime();
                    if (timeDiff < 60000) {
                        lastSyncElement.textContent = 'آخر مزامنة: الآن';
                    } else if (timeDiff < 3600000) {
                        lastSyncElement.textContent = `آخر مزامنة: ${Math.floor(timeDiff / 60000)} دقيقة`;
                    } else {
                        lastSyncElement.textContent = `آخر مزامنة: ${Math.floor(timeDiff / 3600000)} ساعة`;
                    }
                } else {
                    lastSyncElement.textContent = 'لم تتم المزامنة بعد';
                }
            }

            if (queueStatusElement) {
                queueStatusElement.textContent = `${syncQueue.length} في الانتظار`;
            }

            // Update data integrity status
            const dataIntegrityElement = document.getElementById('dashboardDataIntegrity');
            const backupCountElement = document.getElementById('dashboardBackupCount');
            const autoSaveElement = document.getElementById('dashboardAutoSave');

            if (dataIntegrityElement) {
                try {
                    // Check if data exists and is valid
                    const hasProducts = localStorage.getItem('makhzan_products');
                    const hasCategories = localStorage.getItem('makhzan_categories');
                    const hasBackup = localStorage.getItem('makhzan_backup_primary');

                    if (hasProducts && hasCategories && hasBackup) {
                        dataIntegrityElement.textContent = 'آمن';
                    } else {
                        dataIntegrityElement.textContent = 'تحذير';
                    }
                } catch (error) {
                    dataIntegrityElement.textContent = 'خطأ';
                }
            }

            if (backupCountElement) {
                let backupCount = 0;
                if (localStorage.getItem('makhzan_backup_primary')) backupCount++;
                if (localStorage.getItem('makhzan_backup_secondary')) backupCount++;
                if (sessionStorage.getItem('makhzan_session_backup')) backupCount++;
                backupCountElement.textContent = `${backupCount} نسخ احتياطية`;
            }

            if (autoSaveElement) {
                autoSaveElement.textContent = autoSaveInterval ? 'حفظ تلقائي: مفعل' : 'حفظ تلقائي: معطل';
            }

            // Update performance metrics
            const performanceElement = document.getElementById('dashboardPerformance');
            const responseTimeElement = document.getElementById('dashboardResponseTime');
            const uptimeElement = document.getElementById('dashboardUptime');

            if (performanceElement) {
                const errorCount = syncRetryCount;
                if (errorCount === 0) {
                    performanceElement.textContent = 'ممتاز';
                } else if (errorCount < 3) {
                    performanceElement.textContent = 'جيد';
                } else {
                    performanceElement.textContent = 'ضعيف';
                }
            }

            if (responseTimeElement) {
                responseTimeElement.textContent = '< 100ms';
            }

            if (uptimeElement) {
                uptimeElement.textContent = 'متاح 100%';
            }
        }

        // Page navigation
        function showPage(pageId) {
            // Hide all pages
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });

            // Show selected page
            const targetPage = document.getElementById(pageId);
            if (targetPage) {
                targetPage.classList.add('active');
            }

            // Update sidebar
            document.querySelectorAll('.sidebar-item').forEach(item => {
                item.classList.remove('active');
            });

            const activeItem = document.querySelector(`[onclick="showPage('${pageId}')"]`);
            if (activeItem) {
                activeItem.classList.add('active');
            }

            // Page-specific actions
            if (pageId === 'dashboard') {
                updateDashboardStats();
            } else if (pageId === 'products') {
                renderProducts();
                populateCategoryFilters();
            } else if (pageId === 'categories') {
                renderCategories();
            } else if (pageId === 'inventory') {
                renderInventory();
            } else if (pageId === 'sales') {
                renderConsumptions();
            } else if (pageId === 'movements') {
                renderMovements();
                populateMovementFilters();
            } else if (pageId === 'reports') {
                renderReports();
                updateReportStats();
            } else if (pageId === 'settings') {
                updateSettingsPage();
            }
        }

        function renderConsumptions() {
            const tableBody = document.getElementById('consumptionTableBody');
            if (!tableBody) return;

            if (weeklyConsumptions.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="8" class="p-6 text-center text-gray-500">
                            <i class="fas fa-chart-line text-4xl mb-4 block"></i>
                            لا توجد عمليات استهلاك مسجلة
                        </td>
                    </tr>
                `;
                return;
            }

            tableBody.innerHTML = weeklyConsumptions.map(consumption => {
                const product = products.find(p => p.id === consumption.productId);
                const totalValue = (consumption.quantity * consumption.unitCost).toFixed(2);

                return `
                    <tr class="hover:bg-gray-50">
                        <td class="p-3 font-medium">${consumption.productName}</td>
                        <td class="p-3">${product ? product.category : '-'}</td>
                        <td class="p-3 font-bold">${consumption.quantity}</td>
                        <td class="p-3">${product ? product.unit : '-'}</td>
                        <td class="p-3">${new Date(consumption.date).toLocaleDateString('ar-SA')}</td>
                        <td class="p-3">${consumption.reason}</td>
                        <td class="p-3">${totalValue} ر.س</td>
                        <td class="p-3">
                            <div class="action-buttons">
                                <button onclick="editConsumption(${consumption.id})" class="action-btn edit" title="تعديل">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="deleteConsumption(${consumption.id})" class="action-btn delete" title="حذف">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            // Update consumption stats
            updateConsumptionStats();
        }

        function updateConsumptionStats() {
            const now = new Date();
            const oneWeekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
            const twoWeeksAgo = new Date(now.getTime() - 14 * 24 * 60 * 60 * 1000);

            const thisWeek = weeklyConsumptions.filter(c => new Date(c.date) >= oneWeekAgo);
            const lastWeek = weeklyConsumptions.filter(c => {
                const date = new Date(c.date);
                return date >= twoWeeksAgo && date < oneWeekAgo;
            });

            const thisWeekQuantity = thisWeek.reduce((sum, c) => sum + c.quantity, 0);
            const lastWeekQuantity = lastWeek.reduce((sum, c) => sum + c.quantity, 0);
            const totalQuantity = weeklyConsumptions.reduce((sum, c) => sum + c.quantity, 0);
            const totalValue = weeklyConsumptions.reduce((sum, c) => sum + (c.quantity * c.unitCost), 0);

            // Update elements
            const elements = {
                'thisWeekConsumption': thisWeekQuantity,
                'lastWeekConsumption': lastWeekQuantity,
                'totalConsumptionQuantity': totalQuantity,
                'totalConsumptionValue': totalValue.toFixed(2) + ' ر.س'
            };

            Object.entries(elements).forEach(([id, value]) => {
                const element = document.getElementById(id);
                if (element) element.textContent = value;
            });
        }

        // Basic functions
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 px-4 py-2 rounded-lg text-white z-50 ${
                type === 'success' ? 'bg-green-500' :
                type === 'error' ? 'bg-red-500' : 'bg-blue-500'
            }`;
            notification.textContent = message;

            document.body.appendChild(notification);

            setTimeout(() => {
                document.body.removeChild(notification);
            }, 3000);
        }

        function loadFromLocalStorage() {
            try {
                // First try to load from external files
                loadFromExternalFiles();

                const savedProducts = localStorage.getItem('makhzan_products');
                const savedCategories = localStorage.getItem('makhzan_categories');
                const savedConsumptions = localStorage.getItem('makhzan_consumptions');
                const savedMovements = localStorage.getItem('makhzan_movements');

                if (savedProducts) {
                    products = JSON.parse(savedProducts);
                }

                if (savedCategories) {
                    categories = JSON.parse(savedCategories);
                }

                if (savedConsumptions) {
                    weeklyConsumptions = JSON.parse(savedConsumptions);
                }

                if (savedMovements) {
                    stockMovements = JSON.parse(savedMovements);
                }

                // If no data exists, initialize with sample data
                if (!savedProducts || !savedCategories || !savedConsumptions || !savedMovements) {
                    console.log('لم يتم العثور على بيانات محفوظة، جاري تحميل البيانات التجريبية...');
                    initializeSampleData();
                }

                console.log(`تم تحميل ${products.length} منتج، ${categories.length} صنف، ${weeklyConsumptions.length} عملية استهلاك، ${stockMovements.length} حركة مخزون`);

            } catch (error) {
                console.error('خطأ في تحميل البيانات:', error);
                console.log('جاري تحميل البيانات التجريبية...');
                initializeSampleData();
            }
        }

        // Enhanced Data Persistence System for Cross-Device Compatibility
        function loadFromExternalFiles() {
            try {
                // Check if data files exist in the same directory
                const dataFiles = [
                    'variteks_products.json',
                    'variteks_categories.json',
                    'variteks_consumptions.json',
                    'variteks_movements.json',
                    'variteks_users.json'
                ];

                dataFiles.forEach(filename => {
                    fetch(filename)
                        .then(response => {
                            if (response.ok) {
                                return response.json();
                            }
                            throw new Error('File not found');
                        })
                        .then(data => {
                            switch(filename) {
                                case 'variteks_products.json':
                                    if (data && data.length > 0) products = data;
                                    break;
                                case 'variteks_categories.json':
                                    if (data && data.length > 0) categories = data;
                                    break;
                                case 'variteks_consumptions.json':
                                    if (data && data.length > 0) weeklyConsumptions = data;
                                    break;
                                case 'variteks_movements.json':
                                    if (data && data.length > 0) stockMovements = data;
                                    break;
                                case 'variteks_users.json':
                                    if (data && Object.keys(data).length > 0) users = data;
                                    break;
                            }
                            console.log(`تم تحميل ${filename} بنجاح`);
                        })
                        .catch(error => {
                            // File doesn't exist, continue with localStorage
                            console.log(`${filename} غير موجود، سيتم استخدام البيانات المحلية`);
                        });
                });
            } catch (error) {
                console.log('تعذر تحميل الملفات الخارجية، سيتم استخدام البيانات المحلية');
            }
        }

        function saveDataToExternalFiles() {
            try {
                // Create data objects for each file
                const dataFiles = {
                    'variteks_products.json': products,
                    'variteks_categories.json': categories,
                    'variteks_consumptions.json': weeklyConsumptions,
                    'variteks_movements.json': stockMovements,
                    'variteks_users.json': users
                };

                // Save each file
                Object.entries(dataFiles).forEach(([filename, data]) => {
                    const dataStr = JSON.stringify(data, null, 2);
                    const dataBlob = new Blob([dataStr], {type: 'application/json'});

                    // Create download link
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(dataBlob);
                    link.download = filename;

                    // Auto-download the file
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);

                    console.log(`تم حفظ ${filename}`);
                });

                // Also create a complete backup
                const completeBackup = {
                    products: products,
                    categories: categories,
                    weeklyConsumptions: weeklyConsumptions,
                    stockMovements: stockMovements,
                    users: users,
                    timestamp: new Date().toISOString(),
                    version: '1.0',
                    systemName: 'VARITEKS - Gestion des stocks'
                };

                const backupStr = JSON.stringify(completeBackup, null, 2);
                const backupBlob = new Blob([backupStr], {type: 'application/json'});

                const backupLink = document.createElement('a');
                backupLink.href = URL.createObjectURL(backupBlob);
                backupLink.download = `variteks_complete_backup_${new Date().toISOString().split('T')[0]}.json`;

                document.body.appendChild(backupLink);
                backupLink.click();
                document.body.removeChild(backupLink);

                showNotification('تم حفظ جميع ملفات البيانات بنجاح', 'success');

            } catch (error) {
                console.error('خطأ في حفظ الملفات:', error);
                showNotification('خطأ في حفظ الملفات', 'error');
            }
        }

        function importDataFromFiles() {
            const input = document.createElement('input');
            input.type = 'file';
            input.multiple = true;
            input.accept = '.json';

            input.onchange = function(event) {
                const files = event.target.files;
                let filesProcessed = 0;

                Array.from(files).forEach(file => {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const data = JSON.parse(e.target.result);

                            // Check if it's a complete backup file
                            if (data.systemName && data.systemName.includes('VARITEKS')) {
                                if (data.products) products = data.products;
                                if (data.categories) categories = data.categories;
                                if (data.weeklyConsumptions) weeklyConsumptions = data.weeklyConsumptions;
                                if (data.stockMovements) stockMovements = data.stockMovements;
                                if (data.users) users = data.users;

                                showNotification('تم استيراد النسخة الاحتياطية الكاملة بنجاح', 'success');
                            } else {
                                // Handle individual files based on filename
                                if (file.name.includes('products')) {
                                    products = data;
                                } else if (file.name.includes('categories')) {
                                    categories = data;
                                } else if (file.name.includes('consumptions')) {
                                    weeklyConsumptions = data;
                                } else if (file.name.includes('movements')) {
                                    stockMovements = data;
                                } else if (file.name.includes('users')) {
                                    users = data;
                                }
                            }

                            filesProcessed++;
                            if (filesProcessed === files.length) {
                                // Save to localStorage after importing all files
                                saveToLocalStorageAdvanced();
                                updateDashboardStats();
                                renderProducts();
                                renderCategories();
                                showNotification(`تم استيراد ${filesProcessed} ملف بنجاح`, 'success');
                            }

                        } catch (error) {
                            console.error('خطأ في استيراد الملف:', file.name, error);
                            showNotification(`خطأ في استيراد الملف: ${file.name}`, 'error');
                        }
                    };
                    reader.readAsText(file);
                });
            };

            input.click();
        }

        function autoSaveToExternalFiles() {
            // Auto-save to external files every 5 minutes or on major changes
            if (window.autoSaveTimer) {
                clearTimeout(window.autoSaveTimer);
            }

            window.autoSaveTimer = setTimeout(() => {
                try {
                    // Create individual data files
                    const dataFiles = {
                        'variteks_products.json': products,
                        'variteks_categories.json': categories,
                        'variteks_consumptions.json': weeklyConsumptions,
                        'variteks_movements.json': stockMovements,
                        'variteks_users.json': users
                    };

                    // Save to localStorage with external file structure
                    Object.entries(dataFiles).forEach(([filename, data]) => {
                        localStorage.setItem(`external_${filename}`, JSON.stringify(data, null, 2));
                    });

                    console.log('تم الحفظ التلقائي للملفات الخارجية');

                } catch (error) {
                    console.error('خطأ في الحفظ التلقائي:', error);
                }
            }, 300000); // 5 minutes
        }

        // Initialize auto-save on system start
        function initializeAutoSave() {
            // Set up periodic auto-save
            setInterval(() => {
                autoSaveToExternalFiles();
            }, 300000); // Every 5 minutes

            // Save on page unload
            window.addEventListener('beforeunload', () => {
                try {
                    // Quick save before leaving
                    const quickBackup = {
                        products: products,
                        categories: categories,
                        weeklyConsumptions: weeklyConsumptions,
                        stockMovements: stockMovements,
                        users: users,
                        timestamp: new Date().toISOString()
                    };

                    localStorage.setItem('variteks_emergency_backup', JSON.stringify(quickBackup));
                } catch (error) {
                    console.error('خطأ في الحفظ الطارئ:', error);
                }
            });
        }

        // Advanced Data Synchronization System
        let syncQueue = [];
        let isSyncing = false;
        let autoSaveInterval = null;
        let lastSyncTime = null;
        let syncRetryCount = 0;
        const MAX_RETRY_ATTEMPTS = 3;
        const SYNC_INTERVAL = 5000; // 5 seconds
        const AUTO_SAVE_INTERVAL = 2000; // 2 seconds

        function initializeSyncSystem() {
            console.log('تهيئة نظام المزامنة المتقدم...');

            // Start auto-save interval
            startAutoSave();

            // Start sync monitoring
            startSyncMonitoring();

            // Add event listeners for data changes
            addDataChangeListeners();

            // Show sync status
            updateSyncStatus('متصل', 'success');

            console.log('تم تفعيل نظام المزامنة التلقائية');
        }

        function startAutoSave() {
            if (autoSaveInterval) {
                clearInterval(autoSaveInterval);
            }

            autoSaveInterval = setInterval(() => {
                if (syncQueue.length > 0 && !isSyncing) {
                    processSyncQueue();
                }
            }, AUTO_SAVE_INTERVAL);
        }

        function startSyncMonitoring() {
            // Monitor for changes every 5 seconds
            setInterval(() => {
                checkDataIntegrity();
                updateSyncIndicator();
            }, SYNC_INTERVAL);
        }

        function addDataChangeListeners() {
            // Monitor localStorage changes
            window.addEventListener('storage', function(e) {
                if (e.key && e.key.startsWith('makhzan_')) {
                    console.log('تم اكتشاف تغيير في البيانات:', e.key);
                    reloadDataFromStorage();
                }
            });

            // Monitor page visibility for sync
            document.addEventListener('visibilitychange', function() {
                if (!document.hidden) {
                    // Page became visible, sync data
                    forceSyncData();
                }
            });

            // Monitor before page unload
            window.addEventListener('beforeunload', function(e) {
                if (syncQueue.length > 0) {
                    // Force immediate sync before leaving
                    saveToLocalStorageImmediate();
                }
            });
        }

        function queueDataChange(changeType, data) {
            const change = {
                id: Date.now() + Math.random(),
                type: changeType,
                data: data,
                timestamp: new Date().toISOString(),
                user: currentUser ? currentUser.name : 'مجهول'
            };

            syncQueue.push(change);
            console.log(`تم إضافة تغيير للطابور: ${changeType}`, change);

            // Show immediate save indicator
            showSaveIndicator();

            // Process queue immediately for critical changes
            if (['product_add', 'product_delete', 'category_delete'].includes(changeType)) {
                processSyncQueue();
            }
        }

        function processSyncQueue() {
            if (isSyncing || syncQueue.length === 0) return;

            isSyncing = true;
            updateSyncStatus('جاري المزامنة...', 'syncing');
            updateSyncQueueIndicator();

            try {
                // Process all changes in queue
                const changes = [...syncQueue];
                const changeCount = changes.length;
                syncQueue = []; // Clear queue

                // Show progress
                showDataChangeIndicator(`جاري حفظ ${changeCount} تغيير...`);

                // Apply changes and save
                saveToLocalStorageAdvanced(changes);

                // Update sync status
                lastSyncTime = new Date();
                syncRetryCount = 0;
                updateSyncStatus('تم الحفظ', 'success');
                updateSyncQueueIndicator();

                // Show completion
                showDataChangeIndicator(`تم حفظ ${changeCount} تغيير بنجاح`);

                console.log(`تم معالجة ${changeCount} تغيير بنجاح`);

            } catch (error) {
                console.error('خطأ في معالجة طابور المزامنة:', error);
                showDataChangeIndicator('خطأ في الحفظ!');
                handleSyncError();
            } finally {
                isSyncing = false;
                updateSyncQueueIndicator();
            }
        }

        function saveToLocalStorageAdvanced(changes = []) {
            try {
                const timestamp = new Date().toISOString();

                // Create comprehensive backup
                const backupData = {
                    products: products,
                    categories: categories,
                    consumptions: weeklyConsumptions,
                    movements: stockMovements,
                    reports: reports,
                    changes: changes,
                    lastSaved: timestamp,
                    syncId: generateSyncId(),
                    version: '2.0',
                    user: currentUser ? currentUser.name : 'مجهول'
                };

                // Save main data with versioning
                const dataToSave = {
                    products: products,
                    categories: categories,
                    consumptions: weeklyConsumptions,
                    movements: stockMovements,
                    reports: reports,
                    metadata: {
                        lastSaved: timestamp,
                        version: '2.0',
                        changeCount: changes.length,
                        syncId: backupData.syncId
                    }
                };

                // Multi-layer saving for redundancy
                localStorage.setItem('makhzan_products', JSON.stringify(products));
                localStorage.setItem('makhzan_categories', JSON.stringify(categories));
                localStorage.setItem('makhzan_consumptions', JSON.stringify(weeklyConsumptions));
                localStorage.setItem('makhzan_movements', JSON.stringify(stockMovements));
                localStorage.setItem('makhzan_reports', JSON.stringify(reports));
                localStorage.setItem('makhzan_metadata', JSON.stringify(dataToSave.metadata));
                localStorage.setItem('makhzan_last_save', timestamp);

                // Save multiple backup copies
                localStorage.setItem('makhzan_backup_primary', JSON.stringify(backupData));
                localStorage.setItem('makhzan_backup_secondary', localStorage.getItem('makhzan_backup_primary') || JSON.stringify(backupData));

                // Save to sessionStorage as additional backup
                sessionStorage.setItem('makhzan_session_backup', JSON.stringify(backupData));

                // Save change log
                const changeLog = JSON.parse(localStorage.getItem('makhzan_change_log') || '[]');
                changeLog.push(...changes);

                // Keep only last 100 changes
                if (changeLog.length > 100) {
                    changeLog.splice(0, changeLog.length - 100);
                }
                localStorage.setItem('makhzan_change_log', JSON.stringify(changeLog));

                console.log('تم حفظ البيانات مع المزامنة المتقدمة:', timestamp);

                // Show save confirmation
                showSaveIndicator();

                return true;

            } catch (error) {
                console.error('خطأ في الحفظ المتقدم:', error);
                handleSaveError(error);
                return false;
            }
        }

        function saveToLocalStorageImmediate() {
            // Force immediate save without queue
            try {
                const timestamp = new Date().toISOString();

                localStorage.setItem('makhzan_products', JSON.stringify(products));
                localStorage.setItem('makhzan_categories', JSON.stringify(categories));
                localStorage.setItem('makhzan_consumptions', JSON.stringify(weeklyConsumptions));
                localStorage.setItem('makhzan_last_save', timestamp);

                console.log('تم الحفظ الفوري للبيانات');
                return true;
            } catch (error) {
                console.error('خطأ في الحفظ الفوري:', error);
                return false;
            }
        }

        function generateSyncId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        function handleSyncError() {
            syncRetryCount++;

            if (syncRetryCount < MAX_RETRY_ATTEMPTS) {
                updateSyncStatus(`إعادة المحاولة ${syncRetryCount}/${MAX_RETRY_ATTEMPTS}`, 'warning');

                setTimeout(() => {
                    processSyncQueue();
                }, 1000 * syncRetryCount); // Exponential backoff

            } else {
                updateSyncStatus('خطأ في المزامنة', 'error');
                showNotification('خطأ في حفظ البيانات! سيتم إعادة المحاولة تلقائياً.', 'error');

                // Reset retry count after 30 seconds
                setTimeout(() => {
                    syncRetryCount = 0;
                }, 30000);
            }
        }

        function handleSaveError(error) {
            console.error('خطأ في حفظ البيانات:', error);

            // Try to save to sessionStorage as fallback
            try {
                sessionStorage.setItem('makhzan_emergency_backup', JSON.stringify({
                    products: products,
                    categories: categories,
                    consumptions: weeklyConsumptions,
                    timestamp: new Date().toISOString(),
                    error: error.message
                }));

                showNotification('تم حفظ البيانات في النسخة الاحتياطية الطارئة', 'warning');
            } catch (fallbackError) {
                showNotification('خطأ حرج في حفظ البيانات!', 'error');
            }
        }

        function checkDataIntegrity() {
            try {
                // Verify data consistency
                const savedProducts = localStorage.getItem('makhzan_products');
                const savedCategories = localStorage.getItem('makhzan_categories');
                const savedConsumptions = localStorage.getItem('makhzan_consumptions');

                if (!savedProducts || !savedCategories || !savedConsumptions) {
                    console.warn('بيانات مفقودة، جاري الاستعادة...');
                    restoreFromBackup();
                }

                // Check for data corruption
                JSON.parse(savedProducts || '[]');
                JSON.parse(savedCategories || '[]');
                JSON.parse(savedConsumptions || '[]');

            } catch (error) {
                console.error('خطأ في تكامل البيانات:', error);
                restoreFromBackup();
            }
        }

        function forceSyncData() {
            console.log('فرض مزامنة البيانات...');

            // Add all current data to sync queue
            queueDataChange('force_sync', {
                products: products.length,
                categories: categories.length,
                consumptions: weeklyConsumptions.length
            });

            // Process immediately
            processSyncQueue();
        }

        function reloadDataFromStorage() {
            try {
                const savedProducts = localStorage.getItem('makhzan_products');
                const savedCategories = localStorage.getItem('makhzan_categories');
                const savedConsumptions = localStorage.getItem('makhzan_consumptions');

                if (savedProducts) products = JSON.parse(savedProducts);
                if (savedCategories) categories = JSON.parse(savedCategories);
                if (savedConsumptions) weeklyConsumptions = JSON.parse(savedConsumptions);

                // Refresh UI
                renderProducts();
                renderCategories();
                renderInventory();
                updateDashboardStats();

                console.log('تم إعادة تحميل البيانات من التخزين');

            } catch (error) {
                console.error('خطأ في إعادة تحميل البيانات:', error);
            }
        }

        function updateSyncStatus(message, type) {
            const syncStatus = document.getElementById('syncStatus');
            if (syncStatus) {
                syncStatus.textContent = message;
                syncStatus.className = `sync-status ${type}`;
            }
        }

        function updateSyncIndicator() {
            const indicator = document.getElementById('syncIndicator');
            if (indicator) {
                const timeSinceLastSync = lastSyncTime ? Date.now() - lastSyncTime.getTime() : 0;

                if (timeSinceLastSync < 10000) { // Less than 10 seconds
                    indicator.className = 'sync-indicator online';
                    indicator.title = 'متصل - آخر مزامنة: الآن';
                } else if (timeSinceLastSync < 60000) { // Less than 1 minute
                    indicator.className = 'sync-indicator warning';
                    indicator.title = `آخر مزامنة: ${Math.floor(timeSinceLastSync / 1000)} ثانية`;
                } else {
                    indicator.className = 'sync-indicator offline';
                    indicator.title = 'غير متصل';
                }
            }

            // Also update dashboard cards
            updateSyncDashboardCards();
        }

        function showSaveIndicator() {
            const saveStatus = document.getElementById('saveStatus');
            if (saveStatus) {
                saveStatus.classList.remove('hidden');
                saveStatus.innerHTML = '<i class="fas fa-check ml-1"></i>تم الحفظ';

                setTimeout(() => {
                    saveStatus.classList.add('hidden');
                }, 2000);
            }
        }

        function showDataChangeIndicator(message = 'جاري حفظ التغييرات...') {
            const indicator = document.getElementById('dataChangeIndicator');
            if (indicator) {
                indicator.querySelector('span').textContent = message;
                indicator.classList.add('show');

                setTimeout(() => {
                    indicator.classList.remove('show');
                }, 2000);
            }
        }

        function updateSyncQueueIndicator() {
            const indicator = document.getElementById('syncQueueIndicator');
            const countElement = document.getElementById('queueCount');

            if (indicator && countElement) {
                if (syncQueue.length > 0) {
                    countElement.textContent = syncQueue.length;
                    indicator.classList.add('active');
                } else {
                    indicator.classList.remove('active');
                }
            }
        }

        function showSyncProgress(message) {
            showDataChangeIndicator(message);
            updateSyncQueueIndicator();
        }

        // Enhanced queue function with UI feedback
        function queueDataChangeEnhanced(changeType, data) {
            queueDataChange(changeType, data);
            showSyncProgress(`جاري حفظ: ${data.action || changeType}`);
            updateSyncQueueIndicator();
        }

        // Settings functions
        function clearSyncQueue() {
            if (confirm('هل أنت متأكد من مسح طابور المزامنة؟\n\nقد تفقد التغييرات غير المحفوظة!')) {
                syncQueue = [];
                updateSyncQueueIndicator();
                showNotification('تم مسح طابور المزامنة', 'success');
            }
        }

        function createManualBackup() {
            const data = {
                products: products,
                categories: categories,
                consumptions: weeklyConsumptions,
                exportDate: new Date().toISOString(),
                version: '2.0',
                user: currentUser.name
            };

            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});

            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `مخزن_نسخة_احتياطية_${new Date().toISOString().split('T')[0]}.json`;
            link.click();

            showNotification('تم إنشاء النسخة الاحتياطية بنجاح', 'success');
        }

        function openDataResetTool() {
            if (confirm('هل تريد فتح أداة إدارة البيانات؟\n\nستفتح في نافذة جديدة.')) {
                window.open('إعادة_تعيين_البيانات.html', '_blank');
            }
        }

        function showDataStatistics() {
            const stats = `
إحصائيات البيانات:
==================

📦 المنتجات: ${products.length}
🏷️ الأصناف: ${categories.length}
📊 عمليات الاستهلاك: ${weeklyConsumptions.length}

💾 حالة التخزين:
================
✅ البيانات الأساسية: ${localStorage.getItem('makhzan_products') ? 'محفوظة' : 'مفقودة'}
✅ النسخة الاحتياطية الأساسية: ${localStorage.getItem('makhzan_backup_primary') ? 'موجودة' : 'مفقودة'}
✅ النسخة الاحتياطية الثانوية: ${localStorage.getItem('makhzan_backup_secondary') ? 'موجودة' : 'مفقودة'}
✅ نسخة الجلسة: ${sessionStorage.getItem('makhzan_session_backup') ? 'موجودة' : 'مفقودة'}

🔄 حالة المزامنة:
================
📊 في طابور الانتظار: ${syncQueue.length}
⏰ آخر مزامنة: ${lastSyncTime ? lastSyncTime.toLocaleString('ar-SA') : 'لم تتم بعد'}
🔄 عدد المحاولات الفاشلة: ${syncRetryCount}

📈 الأداء:
==========
💾 حجم البيانات المقدر: ${Math.round((JSON.stringify({products, categories, weeklyConsumptions}).length / 1024))} KB
⚡ الحفظ التلقائي: ${autoSaveInterval ? 'مفعل' : 'معطل'}
            `;

            alert(stats);
        }

        function showChangePasswordModal() {
            const oldPassword = prompt('كلمة المرور الحالية:');
            if (!oldPassword) return;

            if (oldPassword !== currentUser.password) {
                alert('كلمة المرور الحالية غير صحيحة!');
                return;
            }

            const newPassword = prompt('كلمة المرور الجديدة:');
            if (!newPassword || newPassword.length < 4) {
                alert('كلمة المرور يجب أن تكون 4 أحرف على الأقل!');
                return;
            }

            const confirmPassword = prompt('تأكيد كلمة المرور الجديدة:');
            if (newPassword !== confirmPassword) {
                alert('كلمات المرور غير متطابقة!');
                return;
            }

            // Update password
            users[currentUser.username].password = newPassword;
            currentUser.password = newPassword;

            // Save users
            localStorage.setItem('makhzan_users', JSON.stringify(users));

            // Queue sync
            queueDataChange('password_change', {
                username: currentUser.username,
                action: 'تغيير كلمة المرور'
            });

            showNotification('تم تغيير كلمة المرور بنجاح', 'success');
        }

        function updateSettingsPage() {
            // Update current user info
            const usernameField = document.getElementById('currentUsername');
            const roleField = document.getElementById('currentUserRole');

            if (usernameField) usernameField.value = currentUser.username;
            if (roleField) roleField.value = currentUser.role;

            // Update sync status in settings
            const settingsSyncStatus = document.getElementById('settingsSyncStatus');
            const settingsLastSync = document.getElementById('settingsLastSync');
            const settingsQueueCount = document.getElementById('settingsQueueCount');

            if (settingsSyncStatus) {
                settingsSyncStatus.textContent = isSyncing ? 'جاري المزامنة...' : 'متصل';
            }

            if (settingsLastSync) {
                settingsLastSync.textContent = lastSyncTime ?
                    lastSyncTime.toLocaleTimeString('ar-SA') : 'لم تتم بعد';
            }

            if (settingsQueueCount) {
                settingsQueueCount.textContent = syncQueue.length;
            }

            // Update data counts
            const productsCount = document.getElementById('dataProductsCount');
            const categoriesCount = document.getElementById('dataCategoriesCount');
            const consumptionsCount = document.getElementById('dataConsumptionsCount');
            const movementsCount = document.getElementById('dataMovementsCount');

            if (productsCount) productsCount.textContent = products.length;
            if (categoriesCount) categoriesCount.textContent = categories.length;
            if (consumptionsCount) consumptionsCount.textContent = weeklyConsumptions.length;
            if (movementsCount) movementsCount.textContent = stockMovements.length;
        }

        function createCompleteBackup() {
            try {
                // Create complete backup object
                const completeBackup = {
                    products: products,
                    categories: categories,
                    weeklyConsumptions: weeklyConsumptions,
                    stockMovements: stockMovements,
                    users: users,
                    timestamp: new Date().toISOString(),
                    version: '1.0',
                    systemName: 'VARITEKS - Gestion des stocks'
                };

                // Convert to JSON string
                const backupStr = JSON.stringify(completeBackup, null, 2);
                const backupBlob = new Blob([backupStr], {type: 'application/json'});

                // Create download link
                const backupLink = document.createElement('a');
                backupLink.href = URL.createObjectURL(backupBlob);
                backupLink.download = `variteks_complete_backup_${new Date().toISOString().split('T')[0]}.json`;

                // Trigger download
                document.body.appendChild(backupLink);
                backupLink.click();
                document.body.removeChild(backupLink);

                showNotification('تم إنشاء نسخة احتياطية كاملة بنجاح', 'success');

            } catch (error) {
                console.error('خطأ في إنشاء النسخة الاحتياطية:', error);
                showNotification('خطأ في إنشاء النسخة الاحتياطية', 'error');
            }
        }

        // Legacy function for compatibility
        function saveToLocalStorage() {
            queueDataChange('manual_save', {
                timestamp: new Date().toISOString(),
                action: 'حفظ يدوي'
            });
        }

        function restoreFromBackup() {
            try {
                const backupData = localStorage.getItem('makhzan_backup');
                if (backupData) {
                    const backup = JSON.parse(backupData);
                    products = backup.products || [];
                    categories = backup.categories || [];
                    weeklyConsumptions = backup.consumptions || [];

                    console.log('تم استرداد البيانات من النسخة الاحتياطية');
                    return true;
                }
            } catch (error) {
                console.error('خطأ في استرداد النسخة الاحتياطية:', error);
            }
            return false;
        }

        // Enhanced rendering functions
        function renderProducts() {
            const tableBody = document.getElementById('productsTableBody');
            if (!tableBody) return;

            if (products.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="8" class="p-6 text-center text-gray-500">
                            <div class="flex flex-col items-center">
                                <i class="fas fa-box text-4xl mb-4 text-gray-300"></i>
                                <p class="text-lg font-medium mb-2">لا توجد منتجات مسجلة</p>
                                <p class="text-sm text-gray-400 mb-4">ابدأ بإضافة منتج جديد</p>
                                <button onclick="showAddProductModal()" class="btn-primary">
                                    <i class="fas fa-plus ml-2"></i>
                                    إضافة منتج جديد
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            tableBody.innerHTML = products.map(product => {
                const stockStatus = getStockStatus(product);
                const stockBadgeClass = stockStatus.text === 'طبيعي' ? 'stock-normal' :
                                       stockStatus.text === 'منخفض' ? 'stock-low' : 'stock-out';

                return `
                    <tr>
                        <td class="font-medium text-gray-900">${product.name}</td>
                        <td class="text-gray-600 font-mono">${product.code}</td>
                        <td>
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium"
                                  style="background-color: ${getCategoryColor(product.categoryId)}20; color: ${getCategoryColor(product.categoryId)}">
                                ${product.category}
                            </span>
                        </td>
                        <td class="font-medium text-green-600">${product.price.toFixed(2)} ر.س</td>
                        <td class="text-gray-600">${product.cost.toFixed(2)} ر.س</td>
                        <td>
                            <div class="flex items-center gap-2">
                                <span class="font-bold text-lg">${product.currentStock}</span>
                                <span class="stock-badge ${stockBadgeClass}">${stockStatus.text}</span>
                            </div>
                        </td>
                        <td class="text-gray-500">${product.minStock} ${product.unit}</td>
                        <td>
                            <div class="action-buttons">
                                <button onclick="editProductModal(${product.id})" class="action-btn edit" title="تعديل">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="deleteProductConfirm(${product.id})" class="action-btn delete" title="حذف">
                                    <i class="fas fa-trash"></i>
                                </button>
                                <button onclick="viewProductDetails(${product.id})" class="action-btn view" title="تفاصيل">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            console.log(`تم عرض ${products.length} منتج`);
        }

        function getCategoryColor(categoryId) {
            const category = categories.find(c => c.id === categoryId);
            return category ? category.color : '#6b7280';
        }

        function renderCategories() {
            const categoriesGrid = document.getElementById('categoriesGrid');
            if (!categoriesGrid) return;

            if (categories.length === 0) {
                categoriesGrid.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <div class="flex flex-col items-center">
                            <i class="fas fa-tags text-6xl text-gray-300 mb-6"></i>
                            <h3 class="text-xl font-medium text-gray-600 mb-2">لا توجد أصناف مسجلة</h3>
                            <p class="text-gray-400 mb-6">ابدأ بإضافة صنف جديد لتنظيم منتجاتك</p>
                            <button onclick="showAddCategoryModal()" class="btn-primary">
                                <i class="fas fa-plus ml-2"></i>
                                إضافة صنف جديد
                            </button>
                        </div>
                    </div>
                `;
                return;
            }

            categoriesGrid.innerHTML = categories.map(category => {
                const productCount = products.filter(p => p.categoryId === category.id).length;
                return `
                    <div class="card p-6 hover:shadow-xl transition-all duration-300 border-l-4" style="border-left-color: ${category.color}">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-full flex items-center justify-center text-white font-bold"
                                     style="background-color: ${category.color}">
                                    ${category.name.charAt(0)}
                                </div>
                                <div>
                                    <h3 class="font-bold text-lg text-gray-800">${category.name}</h3>
                                    <p class="text-sm text-gray-500">${productCount} منتج</p>
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="editCategoryModal(${category.id})" class="action-btn edit" title="تعديل">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="deleteCategoryConfirm(${category.id})" class="action-btn delete" title="حذف">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>

                        <p class="text-gray-600 text-sm mb-4 min-h-[40px]">${category.description || 'لا يوجد وصف'}</p>

                        <div class="flex justify-between items-center text-xs text-gray-400 pt-3 border-t">
                            <span>تم الإنشاء: ${new Date(category.createdAt).toLocaleDateString('ar-SA')}</span>
                            <div class="flex items-center gap-1">
                                <i class="fas fa-circle" style="color: ${category.color}"></i>
                                <span>${category.color}</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            console.log(`تم عرض ${categories.length} صنف`);
        }

        function editCategoryModal(id) {
            const category = categories.find(c => c.id === id);
            if (!category) return;

            // Populate form
            document.getElementById('editCategoryId').value = category.id;
            document.getElementById('editCategoryName').value = category.name;
            document.getElementById('editCategoryDescription').value = category.description || '';
            document.getElementById('editCategoryColor').value = category.color;

            // Initialize color picker for edit modal
            initializeEditColorPicker(category.color);

            openModal('editCategoryModal');
        }

        function initializeEditColorPicker(selectedColor) {
            const colorOptions = document.querySelectorAll('#editColorOptions .color-option');
            colorOptions.forEach(option => {
                option.classList.remove('selected');
                option.addEventListener('click', function() {
                    colorOptions.forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                    document.getElementById('editCategoryColor').value = this.dataset.color;
                });

                if (option.dataset.color === selectedColor) {
                    option.classList.add('selected');
                }
            });
        }

        function saveEditedCategory() {
            const form = document.getElementById('editCategoryForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const id = parseInt(document.getElementById('editCategoryId').value);
            const category = categories.find(c => c.id === id);
            if (!category) return;

            const name = document.getElementById('editCategoryName').value.trim();
            const description = document.getElementById('editCategoryDescription').value.trim();
            const color = document.getElementById('editCategoryColor').value;

            // Validation
            if (categories.some(c => c.name === name && c.id !== id)) {
                showNotification('اسم الصنف موجود مسبقاً!', 'error');
                return;
            }

            // Update category
            const oldName = category.name;
            category.name = name;
            category.description = description;
            category.color = color;

            // Update products that use this category
            products.forEach(product => {
                if (product.categoryId === id) {
                    product.category = name;
                }
            });

            // Queue sync with detailed change info
            queueDataChange('category_edit', {
                categoryId: category.id,
                categoryName: category.name,
                oldName: oldName,
                action: 'تعديل بيانات الصنف'
            });

            renderCategories();
            renderProducts(); // Re-render products to show updated category names
            updateDashboardStats();
            populateProductCategoryOptions('productCategory');
            populateProductCategoryOptions('editProductCategory');
            addRecentActivity('edit', `تم تعديل الصنف: ${category.name}`);
            showNotification('تم تعديل الصنف بنجاح', 'success');
            closeModal('editCategoryModal');
        }

        function deleteCategoryFromModal() {
            const id = parseInt(document.getElementById('editCategoryId').value);
            deleteCategoryConfirm(id);
            closeModal('editCategoryModal');
        }

        function deleteCategoryConfirm(id) {
            const category = categories.find(c => c.id === id);
            if (!category) {
                showNotification('الصنف غير موجود!', 'error');
                return;
            }

            const relatedProducts = products.filter(p => p.categoryId === id);
            const productCount = relatedProducts.length;

            if (productCount > 0) {
                const productNames = relatedProducts.slice(0, 3).map(p => p.name).join(', ');
                const moreText = productCount > 3 ? ` و ${productCount - 3} منتجات أخرى` : '';

                const errorMessage = `❌ لا يمكن حذف الصنف "${category.name}"

السبب: يحتوي على ${productCount} منتج

المنتجات المرتبطة:
${productNames}${moreText}

الحلول المقترحة:
1. احذف المنتجات أولاً
2. انقل المنتجات لصنف آخر
3. أنشئ صنف جديد وانقل المنتجات إليه`;

                alert(errorMessage);
                return;
            }

            // Enhanced confirmation
            const confirmMessage = `⚠️ تأكيد حذف الصنف ⚠️

الصنف: ${category.name}
الوصف: ${category.description || 'لا يوجد وصف'}
اللون: ${category.color}
تاريخ الإنشاء: ${new Date(category.createdAt).toLocaleDateString('ar-SA')}

هل أنت متأكد من حذف هذا الصنف؟
هذا الإجراء لا يمكن التراجع عنه!`;

            if (confirm(confirmMessage)) {
                try {
                    // Store category info for activity log
                    const categoryInfo = {
                        name: category.name,
                        description: category.description,
                        color: category.color
                    };

                    // Remove category
                    categories = categories.filter(c => c.id !== id);

                    // Queue sync with detailed change info
                    queueDataChange('category_delete', {
                        categoryId: id,
                        categoryName: category.name,
                        categoryColor: category.color,
                        action: 'حذف صنف'
                    });

                    renderCategories();
                    updateDashboardStats();
                    populateProductCategoryOptions('productCategory');
                    populateProductCategoryOptions('editProductCategory');
                    addRecentActivity('delete', `تم حذف الصنف: ${categoryInfo.name}`);
                    showNotification(`تم حذف الصنف "${categoryInfo.name}" بنجاح`, 'success');

                } catch (error) {
                    showNotification('خطأ في حذف الصنف!', 'error');
                    console.error('Delete category error:', error);
                }
            }
        }

        function getStockStatus(product) {
            if (product.currentStock <= 0) {
                return { text: 'منتهي', color: 'text-red-600', class: 'bg-red-100' };
            } else if (product.currentStock <= product.minStock) {
                return { text: 'منخفض', color: 'text-yellow-600', class: 'bg-yellow-100' };
            } else {
                return { text: 'طبيعي', color: 'text-green-600', class: 'bg-green-100' };
            }
        }

        function renderInventory() {
            // Update inventory stats
            const totalProducts = products.length;
            const totalValue = products.reduce((sum, p) => sum + (p.currentStock * p.cost), 0);
            const lowStock = products.filter(p => p.currentStock <= p.minStock).length;
            const outOfStock = products.filter(p => p.currentStock <= 0).length;

            // Update inventory stats elements
            const elements = {
                'inventoryTotalProducts': totalProducts,
                'inventoryTotalValue': totalValue.toFixed(2) + ' ر.س',
                'inventoryLowStock': lowStock,
                'inventoryOutOfStock': outOfStock
            };

            Object.entries(elements).forEach(([id, value]) => {
                const element = document.getElementById(id);
                if (element) element.textContent = value;
            });

            // Render inventory table
            const tableBody = document.getElementById('inventoryTableBody');
            if (!tableBody) return;

            tableBody.innerHTML = products.map(product => {
                const status = getStockStatus(product);
                const value = (product.currentStock * product.cost).toFixed(2);

                return `
                    <tr class="hover:bg-gray-50">
                        <td class="p-3 font-medium">${product.name}</td>
                        <td class="p-3">${product.code}</td>
                        <td class="p-3 font-bold ${status.color}">${product.currentStock}</td>
                        <td class="p-3">${product.minStock}</td>
                        <td class="p-3">
                            <span class="px-2 py-1 rounded text-xs ${status.class} ${status.color}">
                                ${status.text}
                            </span>
                        </td>
                        <td class="p-3">${value} ر.س</td>
                        <td class="p-3">
                            <div class="action-buttons">
                                <button onclick="adjustStock(${product.id})" class="action-btn edit" title="تعديل المخزون">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="showProductDetails(${product.id})" class="action-btn view" title="تفاصيل">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button onclick="addProductConsumption(${product.id})" class="action-btn consume" title="تسجيل استهلاك">
                                    <i class="fas fa-minus-circle"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Enhanced Modal Functions
        function showAddProductModal() {
            populateProductCategoryOptions('productCategory');
            openModal('addProductModal');
        }

        function showAddCategoryModal() {
            openModal('addCategoryModal');
            initializeColorPicker();
        }

        function openModal(modalId) {
            const overlay = document.getElementById('modalOverlay');
            const modal = document.getElementById(modalId);

            if (overlay && modal) {
                overlay.classList.add('active');
                modal.style.display = 'block';

                // Focus first input
                const firstInput = modal.querySelector('input, select, textarea');
                if (firstInput) {
                    setTimeout(() => firstInput.focus(), 100);
                }
            }
        }

        function closeModal(modalId) {
            const overlay = document.getElementById('modalOverlay');
            const modal = document.getElementById(modalId);

            if (overlay && modal) {
                overlay.classList.remove('active');
                setTimeout(() => {
                    modal.style.display = 'none';
                    clearModalForm(modalId);
                }, 300);
            }
        }

        function clearModalForm(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                const form = modal.querySelector('form');
                if (form) {
                    form.reset();
                }

                // Clear color selection
                const colorOptions = modal.querySelectorAll('.color-option');
                colorOptions.forEach(option => option.classList.remove('selected'));
                if (colorOptions.length > 0) {
                    colorOptions[0].classList.add('selected');
                    document.getElementById('categoryColor').value = colorOptions[0].dataset.color;
                }
            }
        }

        function populateProductCategoryOptions(selectId) {
            const select = document.getElementById(selectId);
            if (select) {
                select.innerHTML = '<option value="">اختر الصنف</option>' +
                    categories.map(cat => `<option value="${cat.id}">${cat.name}</option>`).join('');
            }
        }

        function initializeColorPicker() {
            const colorOptions = document.querySelectorAll('.color-option');
            colorOptions.forEach(option => {
                option.addEventListener('click', function() {
                    colorOptions.forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                    document.getElementById('categoryColor').value = this.dataset.color;
                });
            });

            // Select first color by default
            if (colorOptions.length > 0) {
                colorOptions[0].classList.add('selected');
                document.getElementById('categoryColor').value = colorOptions[0].dataset.color;
            }
        }

        function saveNewProduct() {
            const form = document.getElementById('addProductForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            // Show saving indicator
            const saveBtn = document.querySelector('#addProductModal .btn-primary');
            const originalText = saveBtn.innerHTML;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin ml-2"></i>جاري الحفظ...';
            saveBtn.disabled = true;

            try {
                const name = document.getElementById('productName').value.trim();
                const code = document.getElementById('productCode').value.trim();
                const categoryId = parseInt(document.getElementById('productCategory').value);
                const unit = document.getElementById('productUnit').value;
                const price = parseFloat(document.getElementById('productPrice').value);
                const cost = parseFloat(document.getElementById('productCost').value);
                const currentStock = parseInt(document.getElementById('productStock').value);
                const minStock = parseInt(document.getElementById('productMinStock').value);
                const description = document.getElementById('productDescription').value.trim();
                const barcode = document.getElementById('productBarcode').value.trim();
                const supplier = document.getElementById('productSupplier').value.trim();

                // Enhanced validation
                if (!name || name.length < 2) {
                    throw new Error('اسم المنتج يجب أن يكون حرفين على الأقل');
                }

                if (!code || code.length < 3) {
                    throw new Error('كود المنتج يجب أن يكون 3 أحرف على الأقل');
                }

                if (products.some(p => p.code === code)) {
                    throw new Error('كود المنتج موجود مسبقاً!');
                }

                if (products.some(p => p.name.toLowerCase() === name.toLowerCase())) {
                    if (!confirm('يوجد منتج بنفس الاسم. هل تريد المتابعة؟')) {
                        throw new Error('تم إلغاء العملية');
                    }
                }

                const category = categories.find(c => c.id === categoryId);
                if (!category) {
                    throw new Error('يجب اختيار صنف صحيح!');
                }

                if (price < 0 || cost < 0) {
                    throw new Error('السعر والتكلفة يجب أن تكون أرقام موجبة');
                }

                if (currentStock < 0 || minStock < 0) {
                    throw new Error('كميات المخزون يجب أن تكون أرقام موجبة');
                }

                if (barcode && products.some(p => p.barcode === barcode)) {
                    throw new Error('رقم الباركود موجود مسبقاً!');
                }

                const newProduct = {
                    id: Date.now(),
                    name: name,
                    code: code,
                    category: category.name,
                    categoryId: category.id,
                    price: price,
                    cost: cost,
                    currentStock: currentStock,
                    minStock: minStock,
                    unit: unit,
                    description: description,
                    barcode: barcode,
                    supplier: supplier,
                    createdAt: new Date().toISOString(),
                    lastModified: new Date().toISOString()
                };

                products.push(newProduct);

                // Queue sync with detailed change info
                queueDataChange('product_add', {
                    productId: newProduct.id,
                    productName: newProduct.name,
                    productCode: newProduct.code,
                    action: 'إضافة منتج جديد'
                });

                renderProducts();
                updateDashboardStats();
                addRecentActivity('add', `تم إضافة المنتج: ${name}`);
                showNotification('تم إضافة المنتج بنجاح', 'success');
                closeModal('addProductModal');

            } catch (error) {
                showNotification(error.message, 'error');
            } finally {
                // Restore button
                saveBtn.innerHTML = originalText;
                saveBtn.disabled = false;
            }
        }

        function saveNewCategory() {
            const form = document.getElementById('addCategoryForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            // Show saving indicator
            const saveBtn = document.querySelector('#addCategoryModal .btn-primary');
            const originalText = saveBtn.innerHTML;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin ml-2"></i>جاري الحفظ...';
            saveBtn.disabled = true;

            try {
                const name = document.getElementById('categoryName').value.trim();
                const description = document.getElementById('categoryDescription').value.trim();
                const color = document.getElementById('categoryColor').value;

                // Enhanced validation
                if (!name || name.length < 2) {
                    throw new Error('اسم الصنف يجب أن يكون حرفين على الأقل');
                }

                if (categories.some(c => c.name.toLowerCase() === name.toLowerCase())) {
                    throw new Error('اسم الصنف موجود مسبقاً!');
                }

                if (!color || !color.startsWith('#')) {
                    throw new Error('يجب اختيار لون صحيح للصنف');
                }

                const newCategory = {
                    id: Date.now(),
                    name: name,
                    description: description,
                    color: color,
                    createdAt: new Date().toISOString()
                };

                categories.push(newCategory);

                // Queue sync with detailed change info
                queueDataChange('category_add', {
                    categoryId: newCategory.id,
                    categoryName: newCategory.name,
                    categoryColor: newCategory.color,
                    action: 'إضافة صنف جديد'
                });

                renderCategories();
                updateDashboardStats();
                populateProductCategoryOptions('productCategory');
                populateProductCategoryOptions('editProductCategory');
                addRecentActivity('add', `تم إضافة الصنف: ${name}`);
                showNotification('تم إضافة الصنف بنجاح', 'success');
                closeModal('addCategoryModal');

            } catch (error) {
                showNotification(error.message, 'error');
            } finally {
                // Restore button
                saveBtn.innerHTML = originalText;
                saveBtn.disabled = false;
            }
        }

        function editProductModal(id) {
            const product = products.find(p => p.id === id);
            if (!product) return;

            // Populate form
            document.getElementById('editProductId').value = product.id;
            document.getElementById('editProductName').value = product.name;
            document.getElementById('editProductCode').value = product.code;
            document.getElementById('editProductPrice').value = product.price;
            document.getElementById('editProductCost').value = product.cost;
            document.getElementById('editProductDescription').value = product.description || '';
            document.getElementById('editProductBarcode').value = product.barcode || '';
            document.getElementById('editProductSupplier').value = product.supplier || '';
            document.getElementById('editProductUnit').value = product.unit;

            // Populate categories
            populateProductCategoryOptions('editProductCategory');
            document.getElementById('editProductCategory').value = product.categoryId;

            openModal('editProductModal');
        }

        function saveEditedProduct() {
            const form = document.getElementById('editProductForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            // Show saving indicator
            const saveBtn = document.querySelector('#editProductModal .btn-primary');
            const originalText = saveBtn.innerHTML;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin ml-2"></i>جاري الحفظ...';
            saveBtn.disabled = true;

            try {
                const id = parseInt(document.getElementById('editProductId').value);
                const product = products.find(p => p.id === id);
                if (!product) {
                    throw new Error('المنتج غير موجود!');
                }

                const name = document.getElementById('editProductName').value.trim();
                const code = document.getElementById('editProductCode').value.trim();
                const categoryId = parseInt(document.getElementById('editProductCategory').value);
                const unit = document.getElementById('editProductUnit').value;
                const price = parseFloat(document.getElementById('editProductPrice').value);
                const cost = parseFloat(document.getElementById('editProductCost').value);
                const description = document.getElementById('editProductDescription').value.trim();
                const barcode = document.getElementById('editProductBarcode').value.trim();
                const supplier = document.getElementById('editProductSupplier').value.trim();

                // Enhanced validation
                if (!name || name.length < 2) {
                    throw new Error('اسم المنتج يجب أن يكون حرفين على الأقل');
                }

                if (!code || code.length < 3) {
                    throw new Error('كود المنتج يجب أن يكون 3 أحرف على الأقل');
                }

                if (products.some(p => p.code === code && p.id !== id)) {
                    throw new Error('كود المنتج موجود مسبقاً!');
                }

                if (barcode && products.some(p => p.barcode === barcode && p.id !== id)) {
                    throw new Error('رقم الباركود موجود مسبقاً!');
                }

                const category = categories.find(c => c.id === categoryId);
                if (!category) {
                    throw new Error('يجب اختيار صنف صحيح!');
                }

                if (price < 0 || cost < 0) {
                    throw new Error('السعر والتكلفة يجب أن تكون أرقام موجبة');
                }

                // Store old values for activity log
                const oldName = product.name;
                const changes = [];

                if (product.name !== name) changes.push(`الاسم: ${product.name} → ${name}`);
                if (product.code !== code) changes.push(`الكود: ${product.code} → ${code}`);
                if (product.price !== price) changes.push(`السعر: ${product.price} → ${price}`);
                if (product.cost !== cost) changes.push(`التكلفة: ${product.cost} → ${cost}`);

                // Update product
                product.name = name;
                product.code = code;
                product.category = category.name;
                product.categoryId = category.id;
                product.price = price;
                product.cost = cost;
                product.unit = unit;
                product.description = description;
                product.barcode = barcode;
                product.supplier = supplier;
                product.lastModified = new Date().toISOString();

                // Queue sync with detailed change info
                queueDataChange('product_edit', {
                    productId: product.id,
                    productName: product.name,
                    oldName: oldName,
                    changes: changes,
                    action: 'تعديل بيانات المنتج'
                });

                renderProducts();
                updateDashboardStats();
                addRecentActivity('edit', `تم تعديل المنتج: ${product.name}${changes.length > 0 ? ' (' + changes.join(', ') + ')' : ''}`);
                showNotification('تم تعديل المنتج بنجاح', 'success');
                closeModal('editProductModal');

            } catch (error) {
                showNotification(error.message, 'error');
            } finally {
                // Restore button
                saveBtn.innerHTML = originalText;
                saveBtn.disabled = false;
            }
        }

        function deleteProductFromModal() {
            const id = parseInt(document.getElementById('editProductId').value);
            deleteProductConfirm(id);
            closeModal('editProductModal');
        }

        function deleteProductConfirm(id) {
            const product = products.find(p => p.id === id);
            if (!product) {
                showNotification('المنتج غير موجود!', 'error');
                return;
            }

            // Enhanced confirmation with product details
            const confirmMessage = `⚠️ تأكيد حذف المنتج ⚠️

المنتج: ${product.name}
الكود: ${product.code}
الصنف: ${product.category}
المخزون الحالي: ${product.currentStock} ${product.unit}
القيمة: ${(product.currentStock * product.cost).toFixed(2)} ر.س

هل أنت متأكد من حذف هذا المنتج؟
هذا الإجراء لا يمكن التراجع عنه!`;

            if (confirm(confirmMessage)) {
                // Check if product has stock
                if (product.currentStock > 0) {
                    const stockWarning = `تحذير: المنتج يحتوي على ${product.currentStock} ${product.unit} في المخزون!

هل تريد المتابعة مع ذلك؟`;

                    if (!confirm(stockWarning)) {
                        return;
                    }
                }

                try {
                    // Store product info for activity log
                    const productInfo = {
                        name: product.name,
                        code: product.code,
                        stock: product.currentStock,
                        value: (product.currentStock * product.cost).toFixed(2)
                    };

                    // Remove product
                    products = products.filter(p => p.id !== id);

                    // Queue sync with detailed change info
                    queueDataChange('product_delete', {
                        productId: id,
                        productName: product.name,
                        productCode: product.code,
                        stockLost: product.currentStock,
                        valueLost: product.currentStock * product.cost,
                        action: 'حذف منتج'
                    });

                    renderProducts();
                    updateDashboardStats();
                    addRecentActivity('delete', `تم حذف المنتج: ${productInfo.name} (${productInfo.code}) - مخزون مفقود: ${productInfo.stock}`);
                    showNotification(`تم حذف المنتج "${productInfo.name}" بنجاح`, 'success');

                } catch (error) {
                    showNotification('خطأ في حذف المنتج!', 'error');
                    console.error('Delete product error:', error);
                }
            }
        }

        // Legacy functions - now redirect to modal versions
        function editProduct(id) {
            editProductModal(id);
        }

        function deleteProduct(id) {
            deleteProductConfirm(id);
        }

        function viewProductDetails(id) {
            const product = products.find(p => p.id === id);
            if (!product) return;

            const details = `
اسم المنتج: ${product.name}
الكود: ${product.code}
الصنف: ${product.category}
السعر: ${product.price} ر.س
التكلفة: ${product.cost} ر.س
المخزون الحالي: ${product.currentStock} ${product.unit}
الحد الأدنى: ${product.minStock} ${product.unit}
تاريخ الإنشاء: ${new Date(product.createdAt).toLocaleString('ar-SA')}
آخر تعديل: ${new Date(product.lastModified).toLocaleString('ar-SA')}
            `;

            alert(details);
        }

        function adjustStock(id) {
            const product = products.find(p => p.id === id);
            if (!product) {
                showNotification('المنتج غير موجود!', 'error');
                return;
            }

            const currentStock = product.currentStock;
            const stockStatus = getStockStatus(product);

            const adjustmentMessage = `📦 تعديل مخزون المنتج

المنتج: ${product.name}
الكود: ${product.code}
المخزون الحالي: ${currentStock} ${product.unit}
الحد الأدنى: ${product.minStock} ${product.unit}
الحالة: ${stockStatus.text}

أدخل الكمية الجديدة:`;

            const newStockInput = prompt(adjustmentMessage);

            if (newStockInput === null) return;

            const newStock = parseInt(newStockInput);

            if (isNaN(newStock)) {
                showNotification('يجب إدخال رقم صحيح!', 'error');
                return;
            }

            if (newStock < 0) {
                if (!confirm('تحذير: المخزون سيصبح سالباً. هل تريد المتابعة؟')) {
                    return;
                }
            }

            if (newStock <= product.minStock && newStock > 0) {
                if (!confirm(`تحذير: المخزون الجديد (${newStock}) أقل من أو يساوي الحد الأدنى (${product.minStock}). هل تريد المتابعة؟`)) {
                    return;
                }
            }

            const difference = newStock - currentStock;
            const changeType = difference > 0 ? 'زيادة' : difference < 0 ? 'نقص' : 'لا تغيير';

            // Create stock movement record
            if (difference !== 0) {
                const movement = {
                    id: Date.now(),
                    productId: product.id,
                    productName: product.name,
                    type: 'adjustment',
                    quantity: difference,
                    stockBefore: currentStock,
                    stockAfter: newStock,
                    unitCost: product.cost,
                    totalValue: Math.abs(difference) * product.cost * (difference < 0 ? -1 : 1),
                    reason: 'تعديل يدوي للمخزون',
                    notes: `تعديل من ${currentStock} إلى ${newStock}`,
                    date: new Date().toISOString(),
                    user: currentUser.name,
                    reference: `ADJ-${Date.now().toString().slice(-6)}`
                };

                stockMovements.push(movement);
            }

            // Update product
            const oldStock = product.currentStock;
            product.currentStock = newStock;
            product.lastModified = new Date().toISOString();

            // Queue sync with detailed change info
            queueDataChange('stock_adjustment', {
                productId: product.id,
                productName: product.name,
                oldStock: oldStock,
                newStock: newStock,
                difference: difference,
                changeType: changeType,
                action: 'تعديل المخزون'
            });

            renderProducts();
            renderInventory();
            renderMovements();
            updateDashboardStats();

            const activityMessage = difference === 0 ?
                `لا تغيير في مخزون ${product.name}` :
                `تم ${changeType} مخزون ${product.name} من ${oldStock} إلى ${newStock} (${difference > 0 ? '+' : ''}${difference})`;

            addRecentActivity('edit', activityMessage);
            showNotification('تم تعديل المخزون بنجاح', 'success');
        }

        // Search and filter functions
        function applyProductFilters() {
            const searchTerm = document.getElementById('productSearch').value.toLowerCase();
            const categoryFilter = document.getElementById('categoryFilter').value;

            let filteredProducts = products;

            if (searchTerm) {
                filteredProducts = filteredProducts.filter(p =>
                    p.name.toLowerCase().includes(searchTerm) ||
                    p.code.toLowerCase().includes(searchTerm)
                );
            }

            if (categoryFilter) {
                filteredProducts = filteredProducts.filter(p => p.category === categoryFilter);
            }

            renderFilteredProducts(filteredProducts);
        }

        function renderFilteredProducts(filteredProducts) {
            const tableBody = document.getElementById('productsTableBody');
            if (!tableBody) return;

            if (filteredProducts.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="8" class="p-6 text-center text-gray-500">
                            <i class="fas fa-search text-4xl mb-4 block"></i>
                            لا توجد نتائج للبحث
                        </td>
                    </tr>
                `;
                return;
            }

            tableBody.innerHTML = filteredProducts.map(product => {
                const stockStatus = getStockStatus(product);
                return `
                    <tr class="hover:bg-gray-50">
                        <td class="p-3 font-medium">${product.name}</td>
                        <td class="p-3">${product.code}</td>
                        <td class="p-3">${product.category}</td>
                        <td class="p-3">${product.price.toFixed(2)} ر.س</td>
                        <td class="p-3">${product.cost.toFixed(2)} ر.س</td>
                        <td class="p-3">
                            <span class="font-bold ${stockStatus.color}">${product.currentStock}</span>
                        </td>
                        <td class="p-3">${product.minStock}</td>
                        <td class="p-3">
                            <div class="flex gap-1">
                                <button onclick="editProduct(${product.id})" class="text-blue-600 hover:text-blue-800 p-1" title="تعديل">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="deleteProduct(${product.id})" class="text-red-600 hover:text-red-800 p-1" title="حذف">
                                    <i class="fas fa-trash"></i>
                                </button>
                                <button onclick="viewProductDetails(${product.id})" class="text-green-600 hover:text-green-800 p-1" title="تفاصيل">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function applyInventoryFilters() {
            const searchTerm = document.getElementById('inventorySearch').value.toLowerCase();
            const statusFilter = document.getElementById('stockStatusFilter').value;

            let filteredProducts = products;

            if (searchTerm) {
                filteredProducts = filteredProducts.filter(p =>
                    p.name.toLowerCase().includes(searchTerm) ||
                    p.code.toLowerCase().includes(searchTerm)
                );
            }

            if (statusFilter) {
                filteredProducts = filteredProducts.filter(p => {
                    const status = getStockStatus(p);
                    if (statusFilter === 'normal') return status.text === 'طبيعي';
                    if (statusFilter === 'low') return status.text === 'منخفض';
                    if (statusFilter === 'out') return status.text === 'منتهي';
                    return true;
                });
            }

            renderFilteredInventory(filteredProducts);
        }

        function renderFilteredInventory(filteredProducts) {
            const tableBody = document.getElementById('inventoryTableBody');
            if (!tableBody) return;

            tableBody.innerHTML = filteredProducts.map(product => {
                const status = getStockStatus(product);
                const value = (product.currentStock * product.cost).toFixed(2);

                return `
                    <tr class="hover:bg-gray-50">
                        <td class="p-3 font-medium">${product.name}</td>
                        <td class="p-3">${product.code}</td>
                        <td class="p-3 font-bold ${status.color}">${product.currentStock}</td>
                        <td class="p-3">${product.minStock}</td>
                        <td class="p-3">
                            <span class="px-2 py-1 rounded text-xs ${status.class} ${status.color}">
                                ${status.text}
                            </span>
                        </td>
                        <td class="p-3">${value} ر.س</td>
                        <td class="p-3">
                            <button onclick="adjustStock(${product.id})" class="text-blue-600 hover:text-blue-800 p-1" title="تعديل المخزون">
                                <i class="fas fa-edit"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function showAddConsumptionModal() {
            if (products.length === 0) {
                showNotification('لا توجد منتجات لتسجيل الاستهلاك!', 'warning');
                return;
            }

            populateConsumptionProductOptions();
            setDefaultConsumptionDate();
            openModal('addConsumptionModal');
        }

        function populateConsumptionProductOptions() {
            const select = document.getElementById('consumptionProduct');
            if (select) {
                select.innerHTML = '<option value="">اختر المنتج</option>' +
                    products.map(product => {
                        const stockStatus = getStockStatus(product);
                        const statusIcon = product.currentStock <= 0 ? '❌' :
                                         product.currentStock <= product.minStock ? '⚠️' : '✅';
                        return `<option value="${product.id}">${statusIcon} ${product.name} (${product.currentStock} ${product.unit})</option>`;
                    }).join('');
            }
        }

        function setDefaultConsumptionDate() {
            const dateInput = document.getElementById('consumptionDate');
            if (dateInput) {
                const now = new Date();
                const localDateTime = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
                dateInput.value = localDateTime;
            }
        }

        function updateConsumptionInfo() {
            const productId = document.getElementById('consumptionProduct').value;
            const quantity = parseInt(document.getElementById('consumptionQuantity').value) || 0;
            const infoDiv = document.getElementById('consumptionInfo');
            const warningDiv = document.getElementById('stockWarning');

            if (!productId || !quantity) {
                infoDiv.style.display = 'none';
                return;
            }

            const product = products.find(p => p.id == productId);
            if (!product) return;

            const stockAfter = product.currentStock - quantity;
            const totalCost = quantity * product.cost;

            document.getElementById('currentStockInfo').textContent = `${product.currentStock} ${product.unit}`;
            document.getElementById('stockAfterConsumption').textContent = `${stockAfter} ${product.unit}`;
            document.getElementById('unitCostInfo').textContent = `${product.cost.toFixed(2)} ر.س`;
            document.getElementById('totalCostInfo').textContent = `${totalCost.toFixed(2)} ر.س`;

            // Update stock after consumption color
            const stockAfterElement = document.getElementById('stockAfterConsumption');
            if (stockAfter < 0) {
                stockAfterElement.className = 'font-medium text-red-600';
                warningDiv.style.display = 'block';
                warningDiv.innerHTML = '<i class="fas fa-exclamation-triangle ml-1"></i>تحذير: الكمية أكبر من المخزون المتاح!';
            } else if (stockAfter <= product.minStock) {
                stockAfterElement.className = 'font-medium text-yellow-600';
                warningDiv.style.display = 'block';
                warningDiv.innerHTML = '<i class="fas fa-exclamation-triangle ml-1"></i>تحذير: المخزون سيصبح منخفضاً!';
            } else {
                stockAfterElement.className = 'font-medium text-green-600';
                warningDiv.style.display = 'none';
            }

            infoDiv.style.display = 'block';
        }

        // Quick consumption function (old method)
        function addConsumption() {
            if (products.length === 0) {
                showNotification('لا توجد منتجات لتسجيل الاستهلاك!', 'warning');
                return;
            }

            const productName = prompt('اختر المنتج:\n' + products.map((p, i) => `${i+1}. ${p.name}`).join('\n'));
            if (!productName) return;

            const product = products.find(p => p.name.includes(productName) || productName.includes(p.name));
            if (!product) {
                alert('المنتج غير موجود!');
                return;
            }

            const quantity = parseInt(prompt(`كمية الاستهلاك من "${product.name}":`));
            if (isNaN(quantity) || quantity <= 0) return;

            if (quantity > product.currentStock) {
                alert('الكمية المطلوبة أكبر من المخزون المتاح!');
                return;
            }

            const reasons = ['إنتاج', 'صيانة', 'اختبار', 'عينة', 'تلف', 'انتهاء صلاحية', 'استخدام داخلي', 'أخرى'];
            const reason = prompt('سبب الاستهلاك:\n' + reasons.map((r, i) => `${i+1}. ${r}`).join('\n'));
            if (!reason) return;

            const selectedReason = reasons.find(r => reason.includes(r)) || reasons[parseInt(reason) - 1] || 'أخرى';

            const newConsumption = {
                id: Date.now(),
                productId: product.id,
                productName: product.name,
                quantity: quantity,
                unitCost: product.cost,
                reason: selectedReason,
                notes: '',
                date: new Date().toISOString(),
                user: currentUser.name
            };

            // Update product stock
            product.currentStock -= quantity;
            product.lastModified = new Date().toISOString();

            weeklyConsumptions.push(newConsumption);

            // Queue sync with detailed change info
            queueDataChange('consumption_add', {
                consumptionId: newConsumption.id,
                productId: product.id,
                productName: product.name,
                quantity: quantity,
                reason: selectedReason,
                action: 'تسجيل استهلاك'
            });

            renderProducts();
            renderInventory();
            renderConsumptions();
            updateDashboardStats();
            addRecentActivity('add', `تم تسجيل استهلاك ${quantity} من ${product.name}`);
            showNotification('تم تسجيل الاستهلاك بنجاح', 'success');
        }

        // وظيفة حفظ الاستهلاك من النافذة المنبثقة
        function saveNewConsumption() {
            const form = document.getElementById('addConsumptionForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            // Show saving indicator
            const saveBtn = document.querySelector('#addConsumptionModal .btn-primary');
            if (saveBtn) {
                const originalText = saveBtn.innerHTML;
                saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin ml-2"></i>جاري الحفظ...';
                saveBtn.disabled = true;

                try {
                    const productId = parseInt(document.getElementById('consumptionProduct').value);
                    const quantity = parseInt(document.getElementById('consumptionQuantity').value);
                    const reason = document.getElementById('consumptionReason').value;
                    const notes = document.getElementById('consumptionNotes').value.trim();
                    const date = document.getElementById('consumptionDate').value;

                    const product = products.find(p => p.id === productId);
                    if (!product) {
                        throw new Error('المنتج غير موجود!');
                    }

                    if (quantity <= 0) {
                        throw new Error('الكمية يجب أن تكون أكبر من صفر!');
                    }

                    if (quantity > product.currentStock) {
                        throw new Error(`الكمية المطلوبة (${quantity}) أكبر من المخزون المتاح (${product.currentStock})!`);
                    }

                    const selectedReason = reason || 'استهلاك';

                    // Create new consumption record
                    const newConsumption = {
                        id: Date.now(),
                        productId: product.id,
                        productName: product.name,
                        quantity: quantity,
                        unitCost: product.cost,
                        reason: selectedReason,
                        notes: notes,
                        date: date ? new Date(date).toISOString() : new Date().toISOString(),
                        user: currentUser.name
                    };

                    // Update product stock
                    product.currentStock -= quantity;
                    product.lastModified = new Date().toISOString();

                    // Add consumption record
                    weeklyConsumptions.push(newConsumption);

                    // Queue sync
                    queueDataChange('consumption_add', {
                        consumptionId: newConsumption.id,
                        productId: product.id,
                        productName: product.name,
                        quantity: quantity,
                        reason: selectedReason,
                        action: 'تسجيل استهلاك'
                    });

                    renderProducts();
                    renderInventory();
                    renderConsumptions();
                    updateDashboardStats();
                    addRecentActivity('add', `تم تسجيل استهلاك ${quantity} من ${product.name}`);
                    showNotification('تم تسجيل الاستهلاك بنجاح', 'success');
                    closeModal('addConsumptionModal');
                } catch (error) {
                    showNotification(error.message, 'error');
                } finally {
                    // Restore button
                    saveBtn.innerHTML = originalText;
                    saveBtn.disabled = false;
                }
            }
        }

        // وظيفة حذف الاستهلاك
        function deleteConsumption(id) {
            const consumption = weeklyConsumptions.find(c => c.id === id);
            if (!consumption) {
                showNotification('عملية الاستهلاك غير موجودة!', 'error');
                return;
            }

            const confirmMessage = `⚠️ تأكيد حذف عملية الاستهلاك

المنتج: ${consumption.productName}
الكمية: ${consumption.quantity}
التاريخ: ${new Date(consumption.date).toLocaleDateString('ar-SA')}
السبب: ${consumption.reason}
القيمة: ${(consumption.quantity * consumption.unitCost).toFixed(2)} ر.س

هل أنت متأكد من حذف هذه العملية؟
ملاحظة: سيتم إعادة الكمية إلى المخزون.`;

            if (confirm(confirmMessage)) {
                try {
                    // Find product to restore stock
                    const product = products.find(p => p.id === consumption.productId);
                    if (product) {
                        // Restore stock
                        product.currentStock += consumption.quantity;
                        product.lastModified = new Date().toISOString();
                    }

                    // Remove consumption
                    weeklyConsumptions = weeklyConsumptions.filter(c => c.id !== id);

                    // Queue sync
                    queueDataChange('consumption_delete', {
                        consumptionId: id,
                        productName: consumption.productName,
                        quantity: consumption.quantity,
                        action: 'حذف عملية استهلاك'
                    });

                    renderProducts();
                    renderInventory();
                    renderConsumptions();
                    updateDashboardStats();
                    addRecentActivity('delete', `تم حذف استهلاك ${consumption.quantity} من ${consumption.productName} وإعادة الكمية للمخزون`);
                    showNotification('تم حذف عملية الاستهلاك وإعادة الكمية للمخزون بنجاح', 'success');
                } catch (error) {
                    showNotification('حدث خطأ أثناء حذف عملية الاستهلاك!', 'error');
                    console.error('Delete consumption error:', error);
                }
            }
        }

        // وظيفة تعديل الاستهلاك
        function editConsumption(id) {
            const consumption = weeklyConsumptions.find(c => c.id === id);
            if (!consumption) {
                showNotification('عملية الاستهلاك غير موجودة!', 'error');
                return;
            }

            const newQuantity = prompt(`تعديل كمية الاستهلاك لـ "${consumption.productName}"\nالكمية الحالية: ${consumption.quantity}\nأدخل الكمية الجديدة:`);

            if (newQuantity === null || isNaN(parseInt(newQuantity)) || parseInt(newQuantity) <= 0) {
                return;
            }

            const quantity = parseInt(newQuantity);
            const product = products.find(p => p.id === consumption.productId);

            if (!product) {
                showNotification('المنتج غير موجود!', 'error');
                return;
            }

            // Calculate stock difference
            const stockDifference = consumption.quantity - quantity;
            const newStock = product.currentStock + stockDifference;

            if (newStock < 0) {
                showNotification(`لا يمكن تعديل الكمية. المخزون سيصبح سالباً (${newStock})`, 'error');
                return;
            }

            // Update product stock
            product.currentStock = newStock;
            product.lastModified = new Date().toISOString();

            // Update consumption
            const oldQuantity = consumption.quantity;
            consumption.quantity = quantity;

            // Queue sync
            queueDataChange('consumption_edit', {
                consumptionId: consumption.id,
                productName: consumption.productName,
                oldQuantity: oldQuantity,
                newQuantity: quantity,
                action: 'تعديل عملية استهلاك'
            });

            renderProducts();
            renderInventory();
            renderConsumptions();
            updateDashboardStats();
            addRecentActivity('edit', `تم تعديل استهلاك ${consumption.productName} من ${oldQuantity} إلى ${quantity}`);
            showNotification('تم تعديل عملية الاستهلاك بنجاح', 'success');
        }

        // وظيفة إضافة استهلاك لمنتج محدد
        function addProductConsumption(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) {
                showNotification('المنتج غير موجود!', 'error');
                return;
            }

            if (product.currentStock <= 0) {
                showNotification(`المنتج "${product.name}" غير متوفر في المخزون!`, 'error');
                return;
            }

            const quantity = prompt(`تسجيل استهلاك للمنتج: ${product.name}
المخزون الحالي: ${product.currentStock} ${product.unit}
الحد الأدنى: ${product.minStock} ${product.unit}

أدخل الكمية المستهلكة:`);

            if (!quantity || isNaN(parseInt(quantity)) || parseInt(quantity) <= 0) {
                return;
            }

            const consumptionQuantity = parseInt(quantity);

            if (consumptionQuantity > product.currentStock) {
                showNotification(`الكمية المطلوبة (${consumptionQuantity}) أكبر من المخزون المتاح (${product.currentStock})!`, 'error');
                return;
            }

            const reasons = ['إنتاج', 'صيانة', 'اختبار', 'عينة', 'تلف', 'انتهاء صلاحية', 'استخدام داخلي', 'أخرى'];
            const reasonInput = prompt('اختر سبب الاستهلاك:\n' + reasons.map((r, i) => `${i+1}. ${r}`).join('\n'));

            if (!reasonInput) return;

            const selectedReason = reasons.find(r => reasonInput.includes(r)) ||
                                 reasons[parseInt(reasonInput) - 1] || 'أخرى';

            // Create consumption record
            const newConsumption = {
                id: Date.now(),
                productId: product.id,
                productName: product.name,
                quantity: consumptionQuantity,
                unitCost: product.cost,
                reason: selectedReason,
                notes: `استهلاك مباشر من صفحة المخزون`,
                date: new Date().toISOString(),
                user: currentUser.name
            };

            // Update product stock
            product.currentStock -= consumptionQuantity;
            product.lastModified = new Date().toISOString();

            // Add consumption record
            weeklyConsumptions.push(newConsumption);

            // Queue sync
            queueDataChange('consumption_add', {
                consumptionId: newConsumption.id,
                productId: product.id,
                productName: product.name,
                quantity: consumptionQuantity,
                reason: selectedReason,
                action: 'تسجيل استهلاك مباشر'
            });

            renderProducts();
            renderInventory();
            renderConsumptions();
            updateDashboardStats();
            addRecentActivity('add', `تم تسجيل استهلاك ${consumptionQuantity} من ${product.name} (${selectedReason})`);
            showNotification(`تم تسجيل استهلاك ${consumptionQuantity} ${product.unit} من ${product.name}`, 'success');
        }

        function exportAllData() {
            const data = {
                products: products,
                categories: categories,
                consumptions: weeklyConsumptions,
                exportDate: new Date().toISOString()
            };

            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});

            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `مخزن_نسخة_احتياطية_${new Date().toISOString().split('T')[0]}.json`;
            link.click();

            showNotification('تم تصدير النسخة الاحتياطية بنجاح', 'success');
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);

                    if (data.products) products = data.products;
                    if (data.categories) categories = data.categories;
                    if (data.consumptions) weeklyConsumptions = data.consumptions;

                    saveToLocalStorage();
                    updateDashboardStats();

                    showNotification('تم استيراد البيانات بنجاح', 'success');
                } catch (error) {
                    showNotification('خطأ في استيراد البيانات', 'error');
                }
            };
            reader.readAsText(file);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('بدء تحميل النظام المتقدم...');

            // Generate initial captcha
            generateCaptcha();

            // Load saved users or use defaults
            const savedUsers = localStorage.getItem('makhzan_users');
            if (savedUsers) {
                try {
                    Object.assign(users, JSON.parse(savedUsers));
                } catch (error) {
                    console.error('Error loading saved users:', error);
                }
            }

            // Check for auto-login first
            if (!checkAutoLogin()) {
                // No saved login, show login page
                document.getElementById('loginPage').style.display = 'flex';
                document.getElementById('mainApp').style.display = 'none';
            }

            // Update time every minute
            setInterval(updateCurrentDateTime, 60000);

            // Add settings event listeners
            addSettingsEventListeners();

            // Add modal event listeners
            addModalEventListeners();

            // Initialize enhanced features
            initializeEnhancedFeatures();

            // Initialize auto-save system for cross-device compatibility
            initializeAutoSave();

            console.log('تم تحميل النظام بنجاح مع نظام الحفظ المحسن للتوافق بين الأجهزة');
        });

        function addSettingsEventListeners() {
            // Auto save toggle
            const autoSaveToggle = document.getElementById('autoSaveToggle');
            if (autoSaveToggle) {
                autoSaveToggle.addEventListener('change', function() {
                    if (this.checked) {
                        startAutoSave();
                        showNotification('تم تفعيل الحفظ التلقائي', 'success');
                    } else {
                        if (autoSaveInterval) {
                            clearInterval(autoSaveInterval);
                            autoSaveInterval = null;
                        }
                        showNotification('تم إيقاف الحفظ التلقائي', 'warning');
                    }

                    queueDataChange('settings_change', {
                        setting: 'auto_save',
                        value: this.checked,
                        action: 'تغيير إعدادات الحفظ التلقائي'
                    });
                });
            }

            // Auto save interval
            const autoSaveIntervalSelect = document.getElementById('autoSaveInterval');
            if (autoSaveIntervalSelect) {
                autoSaveIntervalSelect.addEventListener('change', function() {
                    AUTO_SAVE_INTERVAL = parseInt(this.value);
                    startAutoSave(); // Restart with new interval

                    showNotification(`تم تغيير فترة الحفظ التلقائي إلى ${this.value/1000} ثانية`, 'success');

                    queueDataChange('settings_change', {
                        setting: 'auto_save_interval',
                        value: this.value,
                        action: 'تغيير فترة الحفظ التلقائي'
                    });
                });
            }

            // Backup count
            const backupCountSelect = document.getElementById('backupCount');
            if (backupCountSelect) {
                backupCountSelect.addEventListener('change', function() {
                    showNotification(`تم تغيير عدد النسخ الاحتياطية إلى ${this.value}`, 'success');

                    queueDataChange('settings_change', {
                        setting: 'backup_count',
                        value: this.value,
                        action: 'تغيير عدد النسخ الاحتياطية'
                    });
                });
            }
        }

        function addModalEventListeners() {
            // Close modal when clicking overlay
            const overlay = document.getElementById('modalOverlay');
            if (overlay) {
                overlay.addEventListener('click', function(e) {
                    if (e.target === overlay) {
                        const activeModal = overlay.querySelector('.modal[style*="block"]');
                        if (activeModal) {
                            closeModal(activeModal.id);
                        }
                    }
                });
            }

            // Close modal with Escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    const overlay = document.getElementById('modalOverlay');
                    if (overlay && overlay.classList.contains('active')) {
                        const activeModal = overlay.querySelector('.modal[style*="block"]');
                        if (activeModal) {
                            closeModal(activeModal.id);
                        }
                    }
                }
            });

            // Form submission handlers
            const addProductForm = document.getElementById('addProductForm');
            if (addProductForm) {
                addProductForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    saveNewProduct();
                });
            }

            const addCategoryForm = document.getElementById('addCategoryForm');
            if (addCategoryForm) {
                addCategoryForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    saveNewCategory();
                });
            }

            const editProductForm = document.getElementById('editProductForm');
            if (editProductForm) {
                editProductForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    saveEditedProduct();
                });
            }

            // Auto-generate product code
            const productName = document.getElementById('productName');
            const productCode = document.getElementById('productCode');
            if (productName && productCode) {
                productName.addEventListener('input', function() {
                    if (!productCode.value) {
                        const name = this.value.trim();
                        if (name) {
                            const code = generateProductCode(name);
                            productCode.value = code;
                        }
                    }
                });
            }
        }

        function generateProductCode(name) {
            // Generate code from first letters of words + timestamp
            const words = name.split(' ');
            let code = '';

            words.forEach(word => {
                if (word.length > 0) {
                    code += word.charAt(0).toUpperCase();
                }
            });

            // Add numbers if code is too short
            if (code.length < 3) {
                code = code.padEnd(3, '0');
            }

            // Add timestamp suffix to ensure uniqueness
            const timestamp = Date.now().toString().slice(-3);
            code += timestamp;

            // Check if code exists and modify if needed
            let finalCode = code;
            let counter = 1;
            while (products.some(p => p.code === finalCode)) {
                finalCode = code + counter.toString().padStart(2, '0');
                counter++;
            }

            return finalCode;
        }

        // Export functions
        function exportProductsData() {
            if (products.length === 0) {
                showNotification('لا توجد منتجات للتصدير!', 'warning');
                return;
            }

            const csvData = convertProductsToCSV();
            downloadCSV(csvData, `منتجات_المخزن_${new Date().toISOString().split('T')[0]}.csv`);
            showNotification(`تم تصدير ${products.length} منتج بنجاح`, 'success');
        }

        function exportCategoriesData() {
            if (categories.length === 0) {
                showNotification('لا توجد أصناف للتصدير!', 'warning');
                return;
            }

            const csvData = convertCategoriesToCSV();
            downloadCSV(csvData, `أصناف_المخزن_${new Date().toISOString().split('T')[0]}.csv`);
            showNotification(`تم تصدير ${categories.length} صنف بنجاح`, 'success');
        }

        function convertProductsToCSV() {
            const headers = ['الاسم', 'الكود', 'الصنف', 'السعر', 'التكلفة', 'المخزون الحالي', 'الحد الأدنى', 'الوحدة', 'الوصف', 'الباركود', 'المورد', 'تاريخ الإنشاء'];

            const rows = products.map(product => [
                product.name,
                product.code,
                product.category,
                product.price,
                product.cost,
                product.currentStock,
                product.minStock,
                product.unit,
                product.description || '',
                product.barcode || '',
                product.supplier || '',
                new Date(product.createdAt).toLocaleDateString('ar-SA')
            ]);

            return [headers, ...rows].map(row =>
                row.map(cell => `"${cell}"`).join(',')
            ).join('\n');
        }

        function convertCategoriesToCSV() {
            const headers = ['الاسم', 'الوصف', 'اللون', 'عدد المنتجات', 'تاريخ الإنشاء'];

            const rows = categories.map(category => {
                const productCount = products.filter(p => p.categoryId === category.id).length;
                return [
                    category.name,
                    category.description || '',
                    category.color,
                    productCount,
                    new Date(category.createdAt).toLocaleDateString('ar-SA')
                ];
            });

            return [headers, ...rows].map(row =>
                row.map(cell => `"${cell}"`).join(',')
            ).join('\n');
        }

        function downloadCSV(csvData, filename) {
            const BOM = '\uFEFF'; // UTF-8 BOM for proper Arabic display
            const blob = new Blob([BOM + csvData], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');

            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        // Enhanced UI functions
        function showProductDetails(id) {
            const product = products.find(p => p.id === id);
            if (!product) return;

            const stockStatus = getStockStatus(product);
            const totalValue = (product.currentStock * product.cost).toFixed(2);
            const profit = product.cost > 0 ? ((product.price - product.cost) / product.cost * 100).toFixed(1) : '0';

            const details = `📦 تفاصيل المنتج
═══════════════════

🏷️ المعلومات الأساسية:
• الاسم: ${product.name}
• الكود: ${product.code}
• الصنف: ${product.category}
• الوحدة: ${product.unit}

💰 المعلومات المالية:
• السعر: ${product.price.toFixed(2)} ر.س
• التكلفة: ${product.cost.toFixed(2)} ر.س
• هامش الربح: ${profit}%

📊 معلومات المخزون:
• المخزون الحالي: ${product.currentStock} ${product.unit}
• الحد الأدنى: ${product.minStock} ${product.unit}
• حالة المخزون: ${stockStatus.text}
• القيمة الإجمالية: ${totalValue} ر.س

📝 معلومات إضافية:
• الوصف: ${product.description || 'لا يوجد وصف'}
• الباركود: ${product.barcode || 'غير محدد'}
• المورد: ${product.supplier || 'غير محدد'}

📅 التواريخ:
• تاريخ الإنشاء: ${new Date(product.createdAt).toLocaleString('ar-SA')}
• آخر تعديل: ${new Date(product.lastModified).toLocaleString('ar-SA')}`;

            alert(details);
        }

        function viewProductDetails(id) {
            showProductDetails(id);
        }

        // Quick actions
        function quickAddProduct() {
            const name = prompt('اسم المنتج السريع:');
            if (!name) return;

            if (categories.length === 0) {
                showNotification('يجب إضافة صنف واحد على الأقل أولاً!', 'error');
                showAddCategoryModal();
                return;
            }

            const newProduct = {
                id: Date.now(),
                name: name,
                code: generateProductCode(name),
                category: categories[0].name,
                categoryId: categories[0].id,
                price: 0,
                cost: 0,
                currentStock: 0,
                minStock: 1,
                unit: 'قطعة',
                description: '',
                barcode: '',
                supplier: '',
                createdAt: new Date().toISOString(),
                lastModified: new Date().toISOString()
            };

            products.push(newProduct);

            queueDataChange('product_quick_add', {
                productId: newProduct.id,
                productName: newProduct.name,
                action: 'إضافة سريعة للمنتج'
            });

            renderProducts();
            updateDashboardStats();
            addRecentActivity('add', `إضافة سريعة: ${name}`);
            showNotification(`تم إضافة "${name}" بنجاح. يمكنك تعديل التفاصيل لاحقاً.`, 'success');

            // Auto-open edit modal
            setTimeout(() => {
                editProductModal(newProduct.id);
            }, 500);
        }

        // Validation helpers
        function validateProductData(productData) {
            const errors = [];

            if (!productData.name || productData.name.length < 2) {
                errors.push('اسم المنتج يجب أن يكون حرفين على الأقل');
            }

            if (!productData.code || productData.code.length < 3) {
                errors.push('كود المنتج يجب أن يكون 3 أحرف على الأقل');
            }

            if (productData.price < 0) {
                errors.push('السعر يجب أن يكون رقم موجب');
            }

            if (productData.cost < 0) {
                errors.push('التكلفة يجب أن تكون رقم موجب');
            }

            if (productData.currentStock < 0) {
                errors.push('المخزون الحالي يجب أن يكون رقم موجب');
            }

            if (productData.minStock < 0) {
                errors.push('الحد الأدنى للمخزون يجب أن يكون رقم موجب');
            }

            return errors;
        }

        function validateCategoryData(categoryData) {
            const errors = [];

            if (!categoryData.name || categoryData.name.length < 2) {
                errors.push('اسم الصنف يجب أن يكون حرفين على الأقل');
            }

            if (!categoryData.color || !categoryData.color.startsWith('#')) {
                errors.push('يجب اختيار لون صحيح للصنف');
            }

            return errors;
        }

        // Initialize enhanced features
        function initializeEnhancedFeatures() {
            // Add keyboard shortcuts
            document.addEventListener('keydown', function(e) {
                // Ctrl+N for new product
                if (e.ctrlKey && e.key === 'n') {
                    e.preventDefault();
                    showAddProductModal();
                }

                // Ctrl+Shift+N for new category
                if (e.ctrlKey && e.shiftKey && e.key === 'N') {
                    e.preventDefault();
                    showAddCategoryModal();
                }

                // Ctrl+S for manual save
                if (e.ctrlKey && e.key === 's') {
                    e.preventDefault();
                    saveToLocalStorage();
                    showNotification('تم حفظ البيانات يدوياً', 'success');
                }

                // Ctrl+Shift+C for new consumption
                if (e.ctrlKey && e.shiftKey && e.key === 'C') {
                    e.preventDefault();
                    showAddConsumptionModal();
                }
            });

            // Add event listeners for consumption form
            const consumptionProductSelect = document.getElementById('consumptionProduct');
            const consumptionQuantityInput = document.getElementById('consumptionQuantity');

            if (consumptionProductSelect) {
                consumptionProductSelect.addEventListener('change', updateConsumptionInfo);
            }

            if (consumptionQuantityInput) {
                consumptionQuantityInput.addEventListener('input', updateConsumptionInfo);
            }

            console.log('تم تفعيل الميزات المحسنة');
        }

        // Stock Movements Functions
        function renderMovements() {
            const tableBody = document.getElementById('movementsTableBody');
            if (!tableBody) return;

            if (stockMovements.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="10" class="p-6 text-center text-gray-500">
                            <div class="flex flex-col items-center">
                                <i class="fas fa-exchange-alt text-4xl mb-4 text-gray-300"></i>
                                <p class="text-lg font-medium mb-2">لا توجد حركات مخزون مسجلة</p>
                                <p class="text-sm text-gray-400 mb-4">ابدأ بإضافة حركة مخزون جديدة</p>
                                <button onclick="showAddMovementModal()" class="btn-primary">
                                    <i class="fas fa-plus ml-2"></i>
                                    إضافة حركة جديدة
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            tableBody.innerHTML = stockMovements.map(movement => {
                const typeInfo = getMovementTypeInfo(movement.type);
                const impactClass = movement.type === 'in' ? 'text-green-600' :
                                   movement.type === 'out' ? 'text-red-600' : 'text-blue-600';

                return `
                    <tr>
                        <td class="text-sm">${new Date(movement.date).toLocaleString('ar-SA')}</td>
                        <td class="font-medium">${movement.productName}</td>
                        <td>
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${typeInfo.class}">
                                <i class="${typeInfo.icon} ml-1"></i>
                                ${typeInfo.text}
                            </span>
                        </td>
                        <td class="font-bold ${impactClass}">
                            ${movement.type === 'out' ? '-' : movement.type === 'in' ? '+' : ''}${movement.quantity}
                        </td>
                        <td class="text-gray-600">${movement.stockBefore}</td>
                        <td class="font-medium">${movement.stockAfter}</td>
                        <td class="font-medium ${movement.totalValue >= 0 ? 'text-green-600' : 'text-red-600'}">
                            ${movement.totalValue.toFixed(2)} ر.س
                        </td>
                        <td class="text-sm">${movement.reason}</td>
                        <td class="text-sm text-gray-500">${movement.user}</td>
                        <td>
                            <div class="action-buttons">
                                <button onclick="viewMovementDetails(${movement.id})" class="action-btn view" title="تفاصيل">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button onclick="deleteMovement(${movement.id})" class="action-btn delete" title="حذف">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            updateMovementStats();
            console.log(`تم عرض ${stockMovements.length} حركة مخزون`);
        }

        function getMovementTypeInfo(type) {
            const types = {
                'in': { text: 'إدخال', icon: 'fas fa-arrow-down', class: 'bg-green-100 text-green-800' },
                'out': { text: 'إخراج', icon: 'fas fa-arrow-up', class: 'bg-red-100 text-red-800' },
                'adjustment': { text: 'تعديل', icon: 'fas fa-edit', class: 'bg-blue-100 text-blue-800' },
                'transfer': { text: 'نقل', icon: 'fas fa-exchange-alt', class: 'bg-purple-100 text-purple-800' }
            };
            return types[type] || { text: 'غير محدد', icon: 'fas fa-question', class: 'bg-gray-100 text-gray-800' };
        }

        function updateMovementStats() {
            const totalMovements = stockMovements.length;
            const inMovements = stockMovements.filter(m => m.type === 'in').length;
            const outMovements = stockMovements.filter(m => m.type === 'out').length;
            const totalValue = stockMovements.reduce((sum, m) => sum + Math.abs(m.totalValue), 0);

            document.getElementById('totalMovements').textContent = totalMovements;
            document.getElementById('inMovements').textContent = inMovements;
            document.getElementById('outMovements').textContent = outMovements;
            document.getElementById('movementsValue').textContent = totalValue.toFixed(2) + ' ر.س';
        }

        function populateMovementFilters() {
            const productFilter = document.getElementById('movementProductFilter');
            if (productFilter) {
                productFilter.innerHTML = '<option value="">جميع المنتجات</option>' +
                    products.map(product => `<option value="${product.id}">${product.name}</option>`).join('');
            }
        }

        function showAddMovementModal() {
            populateMovementProductOptions();
            setDefaultMovementDate();
            openModal('addMovementModal');
        }

        function populateMovementProductOptions() {
            const select = document.getElementById('movementProduct');
            if (select) {
                select.innerHTML = '<option value="">اختر المنتج</option>' +
                    products.map(product => `<option value="${product.id}">${product.name} (${product.currentStock} ${product.unit})</option>`).join('');
            }
        }

        function setDefaultMovementDate() {
            const dateInput = document.getElementById('movementDate');
            if (dateInput) {
                const now = new Date();
                const localDateTime = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
                dateInput.value = localDateTime;
            }
        }

        function updateMovementForm() {
            const type = document.getElementById('movementType').value;
            const reasonSelect = document.getElementById('movementReason');
            const summaryDiv = document.getElementById('movementSummary');

            // Update reason options based on movement type
            const reasons = {
                'in': ['شراء جديد', 'إرجاع من العميل', 'تحويل من فرع آخر', 'إنتاج داخلي', 'تصحيح مخزون', 'أخرى'],
                'out': ['بيع', 'استهلاك داخلي', 'تلف', 'انتهاء صلاحية', 'تحويل لفرع آخر', 'عينة', 'أخرى'],
                'adjustment': ['تصحيح جرد', 'تلف', 'فقدان', 'خطأ في الإدخال', 'أخرى'],
                'transfer': ['نقل بين المخازن', 'نقل بين الفروع', 'إعادة توزيع', 'أخرى']
            };

            if (reasonSelect && reasons[type]) {
                reasonSelect.innerHTML = '<option value="">اختر السبب</option>' +
                    reasons[type].map(reason => `<option value="${reason}">${reason}</option>`).join('');
            }

            // Show/hide summary
            if (summaryDiv) {
                summaryDiv.style.display = type ? 'block' : 'none';
            }

            updateMovementSummary();
        }

        function updateMovementSummary() {
            const productId = document.getElementById('movementProduct').value;
            const type = document.getElementById('movementType').value;
            const quantity = parseInt(document.getElementById('movementQuantity').value) || 0;

            if (!productId || !type || !quantity) return;

            const product = products.find(p => p.id == productId);
            if (!product) return;

            const currentStock = product.currentStock;
            let newStock = currentStock;
            let impact = '';
            let value = 0;

            switch (type) {
                case 'in':
                    newStock = currentStock + quantity;
                    impact = `زيادة ${quantity} ${product.unit}`;
                    value = quantity * product.cost;
                    break;
                case 'out':
                    newStock = currentStock - quantity;
                    impact = `نقص ${quantity} ${product.unit}`;
                    value = quantity * product.cost;
                    break;
                case 'adjustment':
                    // For adjustment, quantity can be positive or negative
                    newStock = quantity; // Direct set
                    impact = newStock > currentStock ? `زيادة ${newStock - currentStock}` : `نقص ${currentStock - newStock}`;
                    value = Math.abs(newStock - currentStock) * product.cost;
                    break;
            }

            document.getElementById('currentStockDisplay').textContent = `${currentStock} ${product.unit}`;
            document.getElementById('newStockDisplay').textContent = `${newStock} ${product.unit}`;
            document.getElementById('movementValueDisplay').textContent = `${value.toFixed(2)} ر.س`;
            document.getElementById('movementImpactDisplay').textContent = impact;

            // Warning for negative stock
            const newStockElement = document.getElementById('newStockDisplay');
            if (newStock < 0) {
                newStockElement.className = 'font-medium text-red-600';
            } else if (newStock <= product.minStock) {
                newStockElement.className = 'font-medium text-yellow-600';
            } else {
                newStockElement.className = 'font-medium text-green-600';
            }
        }

        // Add event listeners for real-time updates
        document.addEventListener('DOMContentLoaded', function() {
            const productSelect = document.getElementById('movementProduct');
            const quantityInput = document.getElementById('movementQuantity');

            if (productSelect) {
                productSelect.addEventListener('change', updateMovementSummary);
            }

            if (quantityInput) {
                quantityInput.addEventListener('input', updateMovementSummary);
            }
        });

        function saveNewMovement() {
            const form = document.getElementById('addMovementForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const saveBtn = document.querySelector('#addMovementModal .btn-primary');
            const originalText = saveBtn.innerHTML;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin ml-2"></i>جاري الحفظ...';
            saveBtn.disabled = true;

            try {
                const productId = parseInt(document.getElementById('movementProduct').value);
                const type = document.getElementById('movementType').value;
                const quantity = parseInt(document.getElementById('movementQuantity').value);
                const date = document.getElementById('movementDate').value;
                const reason = document.getElementById('movementReason').value;
                const notes = document.getElementById('movementNotes').value.trim();

                const product = products.find(p => p.id === productId);
                if (!product) {
                    throw new Error('المنتج غير موجود!');
                }

                // Validate quantity
                if (type === 'out' && quantity > product.currentStock) {
                    throw new Error(`الكمية المطلوبة (${quantity}) أكبر من المخزون المتاح (${product.currentStock})`);
                }

                const stockBefore = product.currentStock;
                let stockAfter = stockBefore;
                let actualQuantity = quantity;

                // Calculate new stock based on movement type
                switch (type) {
                    case 'in':
                        stockAfter = stockBefore + quantity;
                        break;
                    case 'out':
                        stockAfter = stockBefore - quantity;
                        actualQuantity = -quantity; // Negative for out movements
                        break;
                    case 'adjustment':
                        stockAfter = quantity; // Direct set for adjustments
                        actualQuantity = quantity - stockBefore; // Difference
                        break;
                    case 'transfer':
                        stockAfter = stockBefore - quantity;
                        actualQuantity = -quantity;
                        break;
                }

                const totalValue = Math.abs(actualQuantity) * product.cost;
                const reference = generateMovementReference(type);

                const newMovement = {
                    id: Date.now(),
                    productId: product.id,
                    productName: product.name,
                    type: type,
                    quantity: actualQuantity,
                    stockBefore: stockBefore,
                    stockAfter: stockAfter,
                    unitCost: product.cost,
                    totalValue: type === 'out' || actualQuantity < 0 ? -totalValue : totalValue,
                    reason: reason,
                    notes: notes,
                    date: new Date(date).toISOString(),
                    user: currentUser.name,
                    reference: reference
                };

                // Update product stock
                product.currentStock = stockAfter;
                product.lastModified = new Date().toISOString();

                // Add movement
                stockMovements.push(newMovement);

                // Queue sync
                queueDataChange('movement_add', {
                    movementId: newMovement.id,
                    productId: product.id,
                    productName: product.name,
                    type: type,
                    quantity: actualQuantity,
                    action: 'إضافة حركة مخزون'
                });

                renderMovements();
                renderProducts();
                renderInventory();
                updateDashboardStats();
                addRecentActivity('add', `حركة ${getMovementTypeInfo(type).text}: ${product.name} (${Math.abs(actualQuantity)} ${product.unit})`);
                showNotification('تم إضافة حركة المخزون بنجاح', 'success');
                closeModal('addMovementModal');

            } catch (error) {
                showNotification(error.message, 'error');
            } finally {
                saveBtn.innerHTML = originalText;
                saveBtn.disabled = false;
            }
        }

        function generateMovementReference(type) {
            const prefix = {
                'in': 'IN',
                'out': 'OUT',
                'adjustment': 'ADJ',
                'transfer': 'TRF'
            };

            const count = stockMovements.filter(m => m.type === type).length + 1;
            return `${prefix[type] || 'MOV'}-${count.toString().padStart(3, '0')}`;
        }

        function viewMovementDetails(id) {
            const movement = stockMovements.find(m => m.id === id);
            if (!movement) return;

            const typeInfo = getMovementTypeInfo(movement.type);
            const details = `📋 تفاصيل حركة المخزون
═══════════════════════════

🏷️ معلومات الحركة:
• المرجع: ${movement.reference}
• النوع: ${typeInfo.text}
• التاريخ: ${new Date(movement.date).toLocaleString('ar-SA')}
• المستخدم: ${movement.user}

📦 معلومات المنتج:
• المنتج: ${movement.productName}
• الكمية: ${Math.abs(movement.quantity)}
• التكلفة الوحدة: ${movement.unitCost.toFixed(2)} ر.س

📊 تأثير على المخزون:
• المخزون قبل: ${movement.stockBefore}
• المخزون بعد: ${movement.stockAfter}
• التغيير: ${movement.quantity > 0 ? '+' : ''}${movement.quantity}

💰 القيمة المالية:
• إجمالي القيمة: ${movement.totalValue.toFixed(2)} ر.س

📝 تفاصيل إضافية:
• السبب: ${movement.reason}
• الملاحظات: ${movement.notes || 'لا توجد ملاحظات'}`;

            alert(details);
        }

        function deleteMovement(id) {
            const movement = stockMovements.find(m => m.id === id);
            if (!movement) return;

            const confirmMessage = `⚠️ تحذير: حذف حركة المخزون

هل أنت متأكد من حذف هذه الحركة؟

المنتج: ${movement.productName}
النوع: ${getMovementTypeInfo(movement.type).text}
الكمية: ${Math.abs(movement.quantity)}
التاريخ: ${new Date(movement.date).toLocaleString('ar-SA')}

تحذير: حذف هذه الحركة لن يؤثر على المخزون الحالي!`;

            if (confirm(confirmMessage)) {
                stockMovements = stockMovements.filter(m => m.id !== id);

                queueDataChange('movement_delete', {
                    movementId: id,
                    productName: movement.productName,
                    action: 'حذف حركة مخزون'
                });

                renderMovements();
                addRecentActivity('delete', `تم حذف حركة: ${movement.productName}`);
                showNotification('تم حذف حركة المخزون', 'success');
            }
        }

        function applyMovementFilters() {
            const search = document.getElementById('movementSearch').value.toLowerCase();
            const typeFilter = document.getElementById('movementTypeFilter').value;
            const productFilter = document.getElementById('movementProductFilter').value;
            const dateFrom = document.getElementById('movementDateFrom').value;
            const dateTo = document.getElementById('movementDateTo').value;

            let filteredMovements = stockMovements;

            if (search) {
                filteredMovements = filteredMovements.filter(m =>
                    m.productName.toLowerCase().includes(search) ||
                    m.reason.toLowerCase().includes(search) ||
                    m.notes.toLowerCase().includes(search)
                );
            }

            if (typeFilter) {
                filteredMovements = filteredMovements.filter(m => m.type === typeFilter);
            }

            if (productFilter) {
                filteredMovements = filteredMovements.filter(m => m.productId == productFilter);
            }

            if (dateFrom) {
                filteredMovements = filteredMovements.filter(m =>
                    new Date(m.date) >= new Date(dateFrom)
                );
            }

            if (dateTo) {
                filteredMovements = filteredMovements.filter(m =>
                    new Date(m.date) <= new Date(dateTo + 'T23:59:59')
                );
            }

            renderFilteredMovements(filteredMovements);
        }

        function renderFilteredMovements(filteredMovements) {
            const tableBody = document.getElementById('movementsTableBody');
            if (!tableBody) return;

            if (filteredMovements.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="10" class="p-6 text-center text-gray-500">
                            <i class="fas fa-search text-4xl mb-4 block text-gray-300"></i>
                            <p class="text-lg font-medium">لا توجد نتائج للبحث</p>
                        </td>
                    </tr>
                `;
                return;
            }

            tableBody.innerHTML = filteredMovements.map(movement => {
                const typeInfo = getMovementTypeInfo(movement.type);
                const impactClass = movement.type === 'in' ? 'text-green-600' :
                                   movement.type === 'out' ? 'text-red-600' : 'text-blue-600';

                return `
                    <tr>
                        <td class="text-sm">${new Date(movement.date).toLocaleString('ar-SA')}</td>
                        <td class="font-medium">${movement.productName}</td>
                        <td>
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${typeInfo.class}">
                                <i class="${typeInfo.icon} ml-1"></i>
                                ${typeInfo.text}
                            </span>
                        </td>
                        <td class="font-bold ${impactClass}">
                            ${movement.type === 'out' ? '-' : movement.type === 'in' ? '+' : ''}${Math.abs(movement.quantity)}
                        </td>
                        <td class="text-gray-600">${movement.stockBefore}</td>
                        <td class="font-medium">${movement.stockAfter}</td>
                        <td class="font-medium ${movement.totalValue >= 0 ? 'text-green-600' : 'text-red-600'}">
                            ${movement.totalValue.toFixed(2)} ر.س
                        </td>
                        <td class="text-sm">${movement.reason}</td>
                        <td class="text-sm text-gray-500">${movement.user}</td>
                        <td>
                            <div class="action-buttons">
                                <button onclick="viewMovementDetails(${movement.id})" class="action-btn view" title="تفاصيل">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button onclick="deleteMovement(${movement.id})" class="action-btn delete" title="حذف">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function clearMovementFilters() {
            document.getElementById('movementSearch').value = '';
            document.getElementById('movementTypeFilter').value = '';
            document.getElementById('movementProductFilter').value = '';
            document.getElementById('movementDateFrom').value = '';
            document.getElementById('movementDateTo').value = '';

            renderMovements();
        }

        function exportMovementsData() {
            if (stockMovements.length === 0) {
                showNotification('لا توجد حركات للتصدير!', 'warning');
                return;
            }

            const csvData = convertMovementsToCSV();
            downloadCSV(csvData, `حركات_المخزون_${new Date().toISOString().split('T')[0]}.csv`);
            showNotification(`تم تصدير ${stockMovements.length} حركة بنجاح`, 'success');
        }

        function convertMovementsToCSV() {
            const headers = ['التاريخ', 'المنتج', 'نوع الحركة', 'الكمية', 'المخزون قبل', 'المخزون بعد', 'القيمة', 'السبب', 'الملاحظات', 'المستخدم', 'المرجع'];

            const rows = stockMovements.map(movement => [
                new Date(movement.date).toLocaleString('ar-SA'),
                movement.productName,
                getMovementTypeInfo(movement.type).text,
                movement.quantity,
                movement.stockBefore,
                movement.stockAfter,
                movement.totalValue.toFixed(2),
                movement.reason,
                movement.notes || '',
                movement.user,
                movement.reference
            ]);

            return [headers, ...rows].map(row =>
                row.map(cell => `"${cell}"`).join(',')
            ).join('\n');
        }

        // Reports Functions
        function renderReports() {
            updateReportStats();
            console.log('تم تحميل صفحة التقارير');
        }

        function updateReportStats() {
            const totalProducts = products.length;
            const inventoryValue = products.reduce((sum, p) => sum + (p.currentStock * p.cost), 0);
            const lowStockCount = products.filter(p => p.currentStock <= p.minStock).length;

            const now = new Date();
            const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
            const monthlyConsumption = weeklyConsumptions.filter(c =>
                new Date(c.date) >= monthStart
            ).reduce((sum, c) => sum + c.quantity, 0);

            document.getElementById('reportTotalProducts').textContent = totalProducts;
            document.getElementById('reportInventoryValue').textContent = inventoryValue.toFixed(2) + ' ر.س';
            document.getElementById('reportLowStock').textContent = lowStockCount;
            document.getElementById('reportMonthlyConsumption').textContent = monthlyConsumption;
        }

        function generateInventoryReport() {
            const reportData = {
                title: 'تقرير المخزون الحالي',
                type: 'inventory',
                data: products.map(product => ({
                    name: product.name,
                    code: product.code,
                    category: product.category,
                    currentStock: product.currentStock,
                    minStock: product.minStock,
                    unit: product.unit,
                    unitCost: product.cost,
                    totalValue: product.currentStock * product.cost,
                    status: getStockStatus(product).text
                })),
                summary: {
                    totalProducts: products.length,
                    totalValue: products.reduce((sum, p) => sum + (p.currentStock * p.cost), 0),
                    lowStockItems: products.filter(p => p.currentStock <= p.minStock).length
                }
            };

            displayReport(reportData);
        }

        function generateLowStockReport() {
            const lowStockProducts = products.filter(p => p.currentStock <= p.minStock);

            const reportData = {
                title: 'تقرير المخزون المنخفض',
                type: 'low_stock',
                data: lowStockProducts.map(product => ({
                    name: product.name,
                    code: product.code,
                    category: product.category,
                    currentStock: product.currentStock,
                    minStock: product.minStock,
                    unit: product.unit,
                    shortage: product.minStock - product.currentStock,
                    urgency: product.currentStock === 0 ? 'عاجل' : 'متوسط'
                })),
                summary: {
                    totalLowStock: lowStockProducts.length,
                    outOfStock: lowStockProducts.filter(p => p.currentStock === 0).length,
                    criticalItems: lowStockProducts.filter(p => p.currentStock < p.minStock * 0.5).length
                }
            };

            displayReport(reportData);
        }

        function generateStockValueReport() {
            const reportData = {
                title: 'تقرير قيمة المخزون',
                type: 'stock_value',
                data: products.map(product => ({
                    name: product.name,
                    category: product.category,
                    currentStock: product.currentStock,
                    unitCost: product.cost,
                    totalValue: product.currentStock * product.cost,
                    percentage: 0 // Will be calculated below
                })),
                summary: {
                    totalValue: products.reduce((sum, p) => sum + (p.currentStock * p.cost), 0),
                    averageValue: 0,
                    highestValue: 0,
                    lowestValue: 0
                }
            };

            // Calculate percentages and summary
            const totalValue = reportData.summary.totalValue;
            reportData.data.forEach(item => {
                item.percentage = totalValue > 0 ? (item.totalValue / totalValue * 100).toFixed(1) : 0;
            });

            reportData.summary.averageValue = totalValue / products.length;
            reportData.summary.highestValue = Math.max(...reportData.data.map(item => item.totalValue));
            reportData.summary.lowestValue = Math.min(...reportData.data.map(item => item.totalValue));

            displayReport(reportData);
        }

        function generateConsumptionReport() {
            const reportData = {
                title: 'تقرير الاستهلاك الأسبوعي',
                type: 'consumption',
                data: weeklyConsumptions.map(consumption => ({
                    productName: consumption.productName,
                    quantity: consumption.quantity,
                    unitCost: consumption.unitCost,
                    totalValue: consumption.quantity * consumption.unitCost,
                    reason: consumption.reason,
                    date: new Date(consumption.date).toLocaleDateString('ar-SA'),
                    user: consumption.user
                })),
                summary: {
                    totalConsumptions: weeklyConsumptions.length,
                    totalQuantity: weeklyConsumptions.reduce((sum, c) => sum + c.quantity, 0),
                    totalValue: weeklyConsumptions.reduce((sum, c) => sum + (c.quantity * c.unitCost), 0),
                    averageConsumption: 0
                }
            };

            reportData.summary.averageConsumption = reportData.summary.totalValue / reportData.summary.totalConsumptions;

            displayReport(reportData);
        }

        function generateTopProductsReport() {
            const productConsumption = {};

            weeklyConsumptions.forEach(consumption => {
                if (!productConsumption[consumption.productId]) {
                    productConsumption[consumption.productId] = {
                        name: consumption.productName,
                        totalQuantity: 0,
                        totalValue: 0,
                        frequency: 0
                    };
                }

                productConsumption[consumption.productId].totalQuantity += consumption.quantity;
                productConsumption[consumption.productId].totalValue += consumption.quantity * consumption.unitCost;
                productConsumption[consumption.productId].frequency += 1;
            });

            const topProducts = Object.values(productConsumption)
                .sort((a, b) => b.totalQuantity - a.totalQuantity)
                .slice(0, 10);

            const reportData = {
                title: 'تقرير المنتجات الأكثر استهلاكاً',
                type: 'top_products',
                data: topProducts.map((product, index) => ({
                    rank: index + 1,
                    name: product.name,
                    totalQuantity: product.totalQuantity,
                    totalValue: product.totalValue,
                    frequency: product.frequency,
                    averagePerConsumption: product.totalQuantity / product.frequency
                })),
                summary: {
                    topProduct: topProducts[0]?.name || 'لا يوجد',
                    totalTrackedProducts: topProducts.length,
                    totalConsumptionValue: topProducts.reduce((sum, p) => sum + p.totalValue, 0)
                }
            };

            displayReport(reportData);
        }

        function generateCategoryReport() {
            const categoryStats = {};

            products.forEach(product => {
                if (!categoryStats[product.categoryId]) {
                    categoryStats[product.categoryId] = {
                        name: product.category,
                        productCount: 0,
                        totalStock: 0,
                        totalValue: 0,
                        consumption: 0
                    };
                }

                categoryStats[product.categoryId].productCount += 1;
                categoryStats[product.categoryId].totalStock += product.currentStock;
                categoryStats[product.categoryId].totalValue += product.currentStock * product.cost;
            });

            // Add consumption data
            weeklyConsumptions.forEach(consumption => {
                const product = products.find(p => p.id === consumption.productId);
                if (product && categoryStats[product.categoryId]) {
                    categoryStats[product.categoryId].consumption += consumption.quantity;
                }
            });

            const reportData = {
                title: 'تقرير الاستهلاك حسب الصنف',
                type: 'category',
                data: Object.values(categoryStats).map(category => ({
                    name: category.name,
                    productCount: category.productCount,
                    totalStock: category.totalStock,
                    totalValue: category.totalValue,
                    consumption: category.consumption,
                    averageStockPerProduct: category.totalStock / category.productCount,
                    consumptionRate: category.totalStock > 0 ? (category.consumption / category.totalStock * 100).toFixed(1) : 0
                })),
                summary: {
                    totalCategories: Object.keys(categoryStats).length,
                    mostActiveCategory: Object.values(categoryStats).sort((a, b) => b.consumption - a.consumption)[0]?.name || 'لا يوجد',
                    highestValueCategory: Object.values(categoryStats).sort((a, b) => b.totalValue - a.totalValue)[0]?.name || 'لا يوجد'
                }
            };

            displayReport(reportData);
        }

        function generateStockMovementReport() {
            const lastMonth = new Date();
            lastMonth.setMonth(lastMonth.getMonth() - 1);

            const movements = stockMovements.filter(m => new Date(m.date) >= lastMonth);

            const reportData = {
                title: 'تقرير حركة المخزون',
                type: 'movement',
                data: movements.map(movement => ({
                    date: formatDate(movement.date),
                    productName: movement.productName,
                    type: movement.type === 'in' ? 'وارد' : 'صادر',
                    quantity: movement.quantity,
                    reason: movement.reason || '-',
                    user: movement.user || 'النظام'
                })),
                summary: {
                    totalMovements: movements.length,
                    incomingCount: movements.filter(m => m.type === 'in').length,
                    outgoingCount: movements.filter(m => m.type === 'out').length,
                    incomingQuantity: movements.filter(m => m.type === 'in').reduce((sum, m) => sum + m.quantity, 0),
                    outgoingQuantity: movements.filter(m => m.type === 'out').reduce((sum, m) => sum + m.quantity, 0)
                }
            };

            displayReport(reportData);
        }

        function generateTrendReport() {
            // Get consumption data for the last 6 months
            const months = [];
            const monthlyData = {};

            for (let i = 5; i >= 0; i--) {
                const date = new Date();
                date.setMonth(date.getMonth() - i);
                const monthKey = `${date.getFullYear()}-${date.getMonth() + 1}`;
                const monthName = date.toLocaleDateString('ar-SA', { month: 'long' });
                months.push({ key: monthKey, name: monthName });
                monthlyData[monthKey] = { consumption: 0, value: 0 };
            }

            // Calculate consumption for each month
            weeklyConsumptions.forEach(consumption => {
                const date = new Date(consumption.date);
                const monthKey = `${date.getFullYear()}-${date.getMonth() + 1}`;
                if (monthlyData[monthKey]) {
                    monthlyData[monthKey].consumption += consumption.quantity;

                    // Calculate value
                    const product = products.find(p => p.id === consumption.productId);
                    if (product) {
                        monthlyData[monthKey].value += consumption.quantity * product.cost;
                    }
                }
            });

            const reportData = {
                title: 'تحليل اتجاهات الاستهلاك',
                type: 'trend',
                data: months.map(month => ({
                    month: month.name,
                    consumption: monthlyData[month.key].consumption,
                    value: monthlyData[month.key].value.toFixed(2)
                })),
                summary: {
                    totalConsumption: Object.values(monthlyData).reduce((sum, data) => sum + data.consumption, 0),
                    totalValue: Object.values(monthlyData).reduce((sum, data) => sum + data.value, 0).toFixed(2),
                    averageMonthlyConsumption: (Object.values(monthlyData).reduce((sum, data) => sum + data.consumption, 0) / 6).toFixed(1)
                }
            };

            displayReport(reportData);
        }

        function displayReport(reportData) {
            const reportArea = document.getElementById('reportDisplayArea');
            const reportTitle = document.getElementById('reportTitle');
            const reportContent = document.getElementById('reportContent');

            reportTitle.textContent = reportData.title;
            reportContent.innerHTML = generateReportHTML(reportData);
            reportArea.style.display = 'block';
            reportArea.scrollIntoView({ behavior: 'smooth' });

            // Store current report for export
            window.currentReport = reportData;
        }

        function generateReportHTML(reportData) {
            let html = `
                <div class="mb-6">
                    <h4 class="text-lg font-semibold mb-4">ملخص التقرير</h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            `;

            // Generate summary cards based on report type
            Object.entries(reportData.summary).forEach(([key, value]) => {
                const label = getSummaryLabel(key);
                html += `
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <p class="text-sm text-gray-600">${label}</p>
                        <p class="text-xl font-bold text-gray-800">${formatValue(value)}</p>
                    </div>
                `;
            });

            html += `
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full border-collapse border border-gray-300">
                        <thead class="bg-gray-50">
                            <tr>
            `;

            // Generate table headers
            if (reportData.data.length > 0) {
                Object.keys(reportData.data[0]).forEach(key => {
                    html += `<th class="border border-gray-300 p-3 text-right font-semibold">${getColumnLabel(key)}</th>`;
                });
            }

            html += `
                            </tr>
                        </thead>
                        <tbody>
            `;

            // Generate table rows
            reportData.data.forEach((row, index) => {
                html += `<tr class="${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}">`;
                Object.values(row).forEach(value => {
                    html += `<td class="border border-gray-300 p-3">${formatValue(value)}</td>`;
                });
                html += `</tr>`;
            });

            html += `
                        </tbody>
                    </table>
                </div>
            `;

            return html;
        }

        function getSummaryLabel(key) {
            const labels = {
                totalProducts: 'إجمالي المنتجات',
                totalValue: 'إجمالي القيمة',
                lowStockItems: 'مخزون منخفض',
                totalLowStock: 'إجمالي المخزون المنخفض',
                outOfStock: 'منتجات منتهية',
                criticalItems: 'منتجات حرجة',
                averageValue: 'متوسط القيمة',
                highestValue: 'أعلى قيمة',
                lowestValue: 'أقل قيمة',
                totalConsumptions: 'إجمالي العمليات',
                totalQuantity: 'إجمالي الكمية',
                averageConsumption: 'متوسط الاستهلاك',
                topProduct: 'المنتج الأكثر استهلاكاً',
                totalTrackedProducts: 'المنتجات المتتبعة',
                totalConsumptionValue: 'قيمة الاستهلاك',
                totalCategories: 'إجمالي الأصناف',
                mostActiveCategory: 'الصنف الأكثر نشاطاً',
                highestValueCategory: 'الصنف الأعلى قيمة'
            };
            return labels[key] || key;
        }

        function getColumnLabel(key) {
            const labels = {
                name: 'الاسم',
                code: 'الكود',
                category: 'الصنف',
                currentStock: 'المخزون الحالي',
                minStock: 'الحد الأدنى',
                unit: 'الوحدة',
                unitCost: 'التكلفة',
                totalValue: 'إجمالي القيمة',
                status: 'الحالة',
                shortage: 'النقص',
                urgency: 'الأولوية',
                percentage: 'النسبة %',
                productName: 'المنتج',
                quantity: 'الكمية',
                reason: 'السبب',
                date: 'التاريخ',
                user: 'المستخدم',
                rank: 'الترتيب',
                frequency: 'التكرار',
                averagePerConsumption: 'متوسط الاستهلاك',
                productCount: 'عدد المنتجات',
                totalStock: 'إجمالي المخزون',
                consumption: 'الاستهلاك',
                averageStockPerProduct: 'متوسط المخزون',
                consumptionRate: 'معدل الاستهلاك %'
            };
            return labels[key] || key;
        }

        function formatValue(value) {
            if (typeof value === 'number') {
                if (value % 1 === 0) {
                    return value.toString();
                } else {
                    return value.toFixed(2);
                }
            }
            return value;
        }

        function closeReport() {
            document.getElementById('reportDisplayArea').style.display = 'none';
            window.currentReport = null;
        }

        function printReport() {
            if (!window.currentReport) return;

            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html dir="rtl">
                <head>
                    <title>${window.currentReport.title}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: right; }
                        th { background-color: #f2f2f2; }
                        .summary { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px; }
                        .summary-item { background: #f9f9f9; padding: 10px; border-radius: 5px; }
                    </style>
                </head>
                <body>
                    <h1>${window.currentReport.title}</h1>
                    <p>تاريخ التقرير: ${new Date().toLocaleString('ar-SA')}</p>
                    ${generateReportHTML(window.currentReport)}
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        function exportReportPDF() {
            showNotification('تصدير PDF قيد التطوير', 'info');
        }

        function exportReportExcel() {
            if (!window.currentReport) return;

            const csvData = convertReportToCSV(window.currentReport);
            downloadCSV(csvData, `${window.currentReport.title}_${new Date().toISOString().split('T')[0]}.csv`);
            showNotification('تم تصدير التقرير بنجاح', 'success');
        }

        function convertReportToCSV(reportData) {
            if (reportData.data.length === 0) return '';

            const headers = Object.keys(reportData.data[0]).map(key => getColumnLabel(key));
            const rows = reportData.data.map(row => Object.values(row));

            return [headers, ...rows].map(row =>
                row.map(cell => `"${cell}"`).join(',')
            ).join('\n');
        }

        function generateCustomReport() {
            openModal('customReportModal');
        }

        function generateProfitReport() {
            // Calculate profit based on cost vs selling price (if available)
            const profitData = products.map(product => {
                // Assume selling price is cost + 30% markup (can be customized)
                const sellingPrice = product.cost * 1.3;
                const profitPerUnit = sellingPrice - product.cost;
                const totalProfit = product.currentStock * profitPerUnit;

                return {
                    name: product.name,
                    cost: product.cost,
                    sellingPrice: sellingPrice.toFixed(2),
                    profitPerUnit: profitPerUnit.toFixed(2),
                    currentStock: product.currentStock,
                    totalProfit: totalProfit.toFixed(2)
                };
            });

            const reportData = {
                title: 'تقرير الأرباح المتوقعة',
                type: 'profit',
                data: profitData,
                summary: {
                    totalPotentialProfit: profitData.reduce((sum, item) => sum + parseFloat(item.totalProfit), 0).toFixed(2),
                    averageProfitMargin: '30%',
                    highestProfitProduct: profitData.sort((a, b) => parseFloat(b.totalProfit) - parseFloat(a.totalProfit))[0]?.name || '-'
                }
            };

            displayReport(reportData);
        }

        function generateSeasonalReport() {
            // Get data for the last year by month
            const monthlyData = {};
            const months = [];

            for (let i = 0; i < 12; i++) {
                const date = new Date();
                date.setMonth(date.getMonth() - i);
                const monthKey = `${date.getFullYear()}-${date.getMonth() + 1}`;
                const monthName = date.toLocaleDateString('ar-SA', { month: 'long' });
                months.unshift({ key: monthKey, name: monthName });
                monthlyData[monthKey] = { consumption: 0, movements: 0 };
            }

            // Calculate consumption for each month
            weeklyConsumptions.forEach(consumption => {
                const date = new Date(consumption.date);
                const monthKey = `${date.getFullYear()}-${date.getMonth() + 1}`;
                if (monthlyData[monthKey]) {
                    monthlyData[monthKey].consumption += consumption.quantity;
                }
            });

            // Calculate movements for each month
            stockMovements.forEach(movement => {
                const date = new Date(movement.date);
                const monthKey = `${date.getFullYear()}-${date.getMonth() + 1}`;
                if (monthlyData[monthKey]) {
                    monthlyData[monthKey].movements++;
                }
            });

            const reportData = {
                title: 'التحليل الموسمي للمخزون',
                type: 'seasonal',
                data: months.map(month => ({
                    month: month.name,
                    consumption: monthlyData[month.key].consumption,
                    movements: monthlyData[month.key].movements
                })),
                summary: {
                    highestConsumptionMonth: months.sort((a, b) =>
                        monthlyData[b.key].consumption - monthlyData[a.key].consumption)[0]?.name || '-',
                    lowestConsumptionMonth: months.sort((a, b) =>
                        monthlyData[a.key].consumption - monthlyData[b.key].consumption)[0]?.name || '-',
                    averageMonthlyConsumption: (Object.values(monthlyData).reduce((sum, data) =>
                        sum + data.consumption, 0) / 12).toFixed(1)
                }
            };

            displayReport(reportData);
        }

        function generatePerformanceReport() {
            // Calculate various performance metrics
            const totalProducts = products.length;
            const lowStockProducts = products.filter(p => p.currentStock <= p.minStock).length;
            const outOfStockProducts = products.filter(p => p.currentStock === 0).length;
            const totalValue = products.reduce((sum, p) => sum + (p.currentStock * p.cost), 0);

            // Calculate stock turnover
            const startDate = new Date();
            startDate.setMonth(startDate.getMonth() - 1);

            const monthlyConsumption = weeklyConsumptions
                .filter(c => new Date(c.date) >= startDate)
                .reduce((sum, c) => sum + c.quantity, 0);

            const averageInventory = totalValue / 2; // Simplified calculation
            const stockTurnover = monthlyConsumption > 0 ? (totalValue / monthlyConsumption).toFixed(2) : 0;

            const reportData = {
                title: 'تقرير أداء المخزون',
                type: 'performance',
                data: [
                    { metric: 'إجمالي المنتجات', value: totalProducts },
                    { metric: 'منتجات ذات مخزون منخفض', value: lowStockProducts, percentage: ((lowStockProducts / totalProducts) * 100).toFixed(1) + '%' },
                    { metric: 'منتجات نفذت من المخزون', value: outOfStockProducts, percentage: ((outOfStockProducts / totalProducts) * 100).toFixed(1) + '%' },
                    { metric: 'قيمة المخزون الإجمالية', value: totalValue.toFixed(2) + ' ر.س' },
                    { metric: 'معدل دوران المخزون (شهري)', value: stockTurnover },
                    { metric: 'الاستهلاك الشهري', value: monthlyConsumption },
                    { metric: 'نسبة المنتجات المستهلكة', value: ((weeklyConsumptions.length / totalProducts) * 100).toFixed(1) + '%' }
                ],
                summary: {
                    overallPerformance: lowStockProducts < (totalProducts * 0.1) ? 'ممتاز' :
                                        (lowStockProducts < (totalProducts * 0.2) ? 'جيد' : 'يحتاج تحسين'),
                    stockEfficiency: stockTurnover > 2 ? 'عالي' : (stockTurnover > 1 ? 'متوسط' : 'منخفض'),
                    inventoryHealth: outOfStockProducts === 0 ? 'ممتاز' :
                                    (outOfStockProducts < 3 ? 'جيد' : 'يحتاج مراقبة')
                }
            };

            displayReport(reportData);
        }

        function exportAllReports() {
            showNotification('تصدير جميع التقارير قيد التطوير', 'info');
        }

        function closeReport() {
            document.getElementById('reportDisplayArea').style.display = 'none';
            window.currentReport = null;
        }

        function generateForecastReport() {
            // Simple forecasting based on average consumption
            const forecastData = [];

            // Group consumption by product
            const productConsumption = {};
            weeklyConsumptions.forEach(consumption => {
                if (!productConsumption[consumption.productId]) {
                    productConsumption[consumption.productId] = {
                        productId: consumption.productId,
                        productName: consumption.productName,
                        totalConsumption: 0,
                        consumptionCount: 0
                    };
                }

                productConsumption[consumption.productId].totalConsumption += consumption.quantity;
                productConsumption[consumption.productId].consumptionCount++;
            });

            // Calculate average consumption and forecast
            Object.values(productConsumption).forEach(item => {
                const product = products.find(p => p.id === item.productId);
                if (product) {
                    const avgConsumption = item.consumptionCount > 0 ?
                        item.totalConsumption / item.consumptionCount : 0;

                    // Weekly forecast
                    const weeklyForecast = avgConsumption;

                    // Monthly forecast (4 weeks)
                    const monthlyForecast = weeklyForecast * 4;

                    // Weeks until stock out
                    const weeksUntilStockOut = avgConsumption > 0 ?
                        Math.floor(product.currentStock / avgConsumption) : 999;

                    forecastData.push({
                        productName: product.name,
                        currentStock: product.currentStock,
                        avgWeeklyConsumption: avgConsumption.toFixed(2),
                        weeklyForecast: weeklyForecast.toFixed(2),
                        monthlyForecast: monthlyForecast.toFixed(2),
                        weeksUntilStockOut: weeksUntilStockOut === 999 ? 'غير محدد' : weeksUntilStockOut,
                        stockStatus: weeksUntilStockOut <= 2 ? 'حرج' :
                                    (weeksUntilStockOut <= 4 ? 'منخفض' : 'جيد')
                    });
                }
            });

            // Sort by weeks until stock out (ascending)
            forecastData.sort((a, b) => {
                const aWeeks = a.weeksUntilStockOut === 'غير محدد' ? 999 : parseInt(a.weeksUntilStockOut);
                const bWeeks = b.weeksUntilStockOut === 'غير محدد' ? 999 : parseInt(b.weeksUntilStockOut);
                return aWeeks - bWeeks;
            });

            const reportData = {
                title: 'توقعات المخزون',
                type: 'forecast',
                data: forecastData,
                summary: {
                    productsAtRisk: forecastData.filter(d => d.stockStatus === 'حرج').length,
                    productsLow: forecastData.filter(d => d.stockStatus === 'منخفض').length,
                    averageWeeksUntilStockOut: forecastData
                        .filter(d => d.weeksUntilStockOut !== 'غير محدد')
                        .reduce((sum, d) => sum + parseInt(d.weeksUntilStockOut), 0) /
                        forecastData.filter(d => d.weeksUntilStockOut !== 'غير محدد').length || 0
                }
            };

            displayReport(reportData);
        }

        function getSummaryLabel(key) {
            const labels = {
                totalProducts: 'إجمالي المنتجات',
                totalCategories: 'إجمالي الأصناف',
                totalValue: 'القيمة الإجمالية',
                totalStock: 'إجمالي المخزون',
                totalConsumption: 'إجمالي الاستهلاك',
                totalMovements: 'إجمالي الحركات',
                lowStockCount: 'منتجات بمخزون منخفض',
                outOfStockCount: 'منتجات نفذت',
                averageValue: 'متوسط القيمة',
                highestValue: 'أعلى قيمة',
                lowestValue: 'أقل قيمة',
                averageConsumption: 'متوسط الاستهلاك',
                mostActiveCategory: 'أكثر الأصناف نشاطاً',
                highestValueCategory: 'أعلى الأصناف قيمة',
                incomingCount: 'الحركات الواردة',
                outgoingCount: 'الحركات الصادرة',
                incomingQuantity: 'الكمية الواردة',
                outgoingQuantity: 'الكمية الصادرة',
                totalPotentialProfit: 'إجمالي الأرباح المتوقعة',
                averageProfitMargin: 'متوسط هامش الربح',
                highestProfitProduct: 'أعلى منتج ربحاً',
                highestConsumptionMonth: 'أعلى شهر استهلاكاً',
                lowestConsumptionMonth: 'أقل شهر استهلاكاً',
                averageMonthlyConsumption: 'متوسط الاستهلاك الشهري',
                overallPerformance: 'الأداء العام',
                stockEfficiency: 'كفاءة المخزون',
                inventoryHealth: 'صحة المخزون',
                productsAtRisk: 'منتجات في خطر',
                productsLow: 'منتجات منخفضة',
                averageWeeksUntilStockOut: 'متوسط الأسابيع حتى النفاد',
                stockStatus: 'حالة المخزون'
            };

            return labels[key] || key;
        }

        function getColumnLabel(key) {
            const labels = {
                name: 'الاسم',
                code: 'الكود',
                category: 'الصنف',
                currentStock: 'المخزون الحالي',
                minStock: 'الحد الأدنى',
                maxStock: 'الحد الأقصى',
                unit: 'الوحدة',
                cost: 'التكلفة',
                value: 'القيمة',
                totalValue: 'القيمة الإجمالية',
                productName: 'اسم المنتج',
                date: 'التاريخ',
                type: 'النوع',
                quantity: 'الكمية',
                reason: 'السبب',
                user: 'المستخدم',
                notes: 'ملاحظات',
                productCount: 'عدد المنتجات',
                totalStock: 'إجمالي المخزون',
                consumption: 'الاستهلاك',
                averageStockPerProduct: 'متوسط المخزون لكل منتج',
                consumptionRate: 'معدل الاستهلاك',
                month: 'الشهر',
                movements: 'الحركات',
                sellingPrice: 'سعر البيع',
                profitPerUnit: 'الربح لكل وحدة',
                totalProfit: 'إجمالي الربح',
                metric: 'المقياس',
                percentage: 'النسبة',
                avgWeeklyConsumption: 'متوسط الاستهلاك الأسبوعي',
                weeklyForecast: 'التوقع الأسبوعي',
                monthlyForecast: 'التوقع الشهري',
                weeksUntilStockOut: 'أسابيع حتى النفاد',
                stockStatus: 'حالة المخزون'
            };

            return labels[key] || key;
        }

        function updateReportOptions() {
            const reportType = document.getElementById('reportType').value;
            const filterSection = document.getElementById('reportFilterSection');
            const filterSelect = document.getElementById('reportFilter');

            if (reportType === 'product') {
                filterSection.style.display = 'block';
                filterSelect.innerHTML = '<option value="">اختر المنتج</option>' +
                    products.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
            } else if (reportType === 'category') {
                filterSection.style.display = 'block';
                filterSelect.innerHTML = '<option value="">اختر الصنف</option>' +
                    categories.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            } else {
                filterSection.style.display = 'none';
            }
        }

        function generateReport() {
            const form = document.getElementById('customReportForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const title = document.getElementById('reportCustomTitle').value;
            const type = document.getElementById('reportType').value;
            const format = document.getElementById('reportFormat').value;
            const dateFrom = document.getElementById('reportDateFrom').value;
            const dateTo = document.getElementById('reportDateTo').value;
            const filter = document.getElementById('reportFilter').value;

            // Generate report based on type
            switch (type) {
                case 'inventory':
                    generateInventoryReport();
                    break;
                case 'consumption':
                    generateConsumptionReport();
                    break;
                case 'movement':
                    generateMovementReport(dateFrom, dateTo);
                    break;
                case 'value':
                    generateStockValueReport();
                    break;
                case 'product':
                    generateProductSpecificReport(filter);
                    break;
                case 'category':
                    generateCategorySpecificReport(filter);
                    break;
                default:
                    showNotification('نوع التقرير غير مدعوم', 'error');
                    return;
            }

            closeModal('customReportModal');
        }

        function generateMovementReport(dateFrom, dateTo) {
            let movements = stockMovements;

            if (dateFrom) {
                movements = movements.filter(m => new Date(m.date) >= new Date(dateFrom));
            }

            if (dateTo) {
                movements = movements.filter(m => new Date(m.date) <= new Date(dateTo + 'T23:59:59'));
            }

            const reportData = {
                title: 'تقرير حركات المخزون',
                type: 'movement',
                data: movements.map(movement => ({
                    date: new Date(movement.date).toLocaleDateString('ar-SA'),
                    productName: movement.productName,
                    type: getMovementTypeInfo(movement.type).text,
                    quantity: Math.abs(movement.quantity),
                    stockBefore: movement.stockBefore,
                    stockAfter: movement.stockAfter,
                    totalValue: movement.totalValue,
                    reason: movement.reason,
                    user: movement.user
                })),
                summary: {
                    totalMovements: movements.length,
                    inMovements: movements.filter(m => m.type === 'in').length,
                    outMovements: movements.filter(m => m.type === 'out').length,
                    totalValue: movements.reduce((sum, m) => sum + Math.abs(m.totalValue), 0)
                }
            };

            displayReport(reportData);
        }

        function exportAllReports() {
            showNotification('تصدير جميع التقارير قيد التطوير', 'info');
        }
    </script>
</body>
</html>
